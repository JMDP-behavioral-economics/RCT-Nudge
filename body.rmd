---
title: |
  Only You:
  A Field Experiment of Text Message to Prevent Free-riding in Japan Marrow Donor Program
author:
  - name: Hiroki Kato
    affiliations:
      - 'Graduate School of Economics, Osaka University, Japan'
  - name: Fumio Ohtake
    affiliations:
      - 'Graduate School of Economics, Osaka University, Japan'
      - 'Center for Infectious Disease Education and Research (CiDER), Osaka University, Japan'
  - name: Saiko Kurosawa
    affiliations:
      - 'Department of Oncology, Ina Central Hospital, Japan'
  - name: Kazuhiro Yoshiuchi
    affiliations:
      - 'Graduate School of Medicine, Tokyo University, Japan'
  - name: Takahiro Fukuda
    affiliations:
      - 'Department of Hematopoietic Stem Cell Transplantation, National Cancer Center Hospital, Japan'

output:
  bookdown::word_document2:
    toc: false
    number-sections: true
---

```{r}
#| include: false

knitr::opts_chunk$set(
  echo = FALSE,
  message = FALSE,
  warning = FALSE
)
```

```{r include=FALSE}
library(here)
library(tidyverse)
library(lubridate)
library(estimatr)
library(fixest)
library(grf)
library(modelsummary)
library(kableExtra)
library(flextable)
library(officer)
library(RCTtoolbox)
library(patchwork)
source(here("R", "wildBS.r"))
source(here("R", "ft_theme.r"))

options(
  knitr.table.format = "markdown",
  kableExtra.auto_format = FALSE,
  modelsummary_stars_note = FALSE,
  modelsummary_factory_default = "flextable",
  modelsummary_factory_html = "kableExtra",
  modelsummary_factory_latex = "kableExtra",
  modelsummary_factory_word = "flextable"
)
```

```{r include=FALSE}
root <- "D:/JMDPフィールド実験"

outcome_label <- list(
  reply = "Reply",
  positive = "Positive intention",
  negative = "Negative intention",
  test = "CT",
  candidate = "Candidate",
  consent = "Consent",
  donate = "Donation"
)
```

# Field Experiment
## Background: Coordination Process of JMDP


フィールド実験の介入のタイミングとデータの理解を促すために、骨髄バンクに登録したドナー候補者が幹細胞を提供するに至るまでの工程を概観しておく。
はじめに、あるドナー候補者のHLAが骨髄バンクに登録した患者のHLAと一致すると、骨髄バンクの事務局はその候補者に幹細胞提供を依頼する適合通知を送付する[^SNS]。
ドナー候補者は適合通知に対して提供の意向と問診表を記入して、返信する。

[^SNS]: 適合通知を送付したことを伝えるSMSメッセージも送付している。

提供を希望したドナー候補者はおよそ1カ月以内に確認検査を受ける。確認検査では、コーディネーターが提供方法（骨髄採取・末梢血幹細胞採取）を詳細に説明し、ドナー候補者とその家族の意向について調査する。
このとき、ドナー候補者は希望する採取方法を選べる。
また、調整医師が問診・診察・感染症の有無や血液型を調べるための一般血液検査を実施する。
この検査を通じて、ドナー候補者が、骨髄バンクが設定した基準を満たしているかどうかを調べる。

骨髄バンクに登録したドナーは同時に最大10人のドナー候補者とのコーディネーションを進められる。
患者の主治医は確認検査まで至った複数のドナー候補者の中から最も最適な候補者（第一候補者）を選ぶ。
重要な点であるが、ドナー候補者は自身とマッチした患者が何人のドナーとのコーディネーションを進めているかを知ることができない。
また、コーディネーターや調整医師もこの点を知らないので、ドナー候補者が他者からその情報を得ることもできない。

第一候補者となったドナーはコーディネーターと調整医師からの説明を再度受けて、最終的な意思決定をする（最終同意）。
このとき、ドナーの家族の代表者も採取に同意する必要がある。
また、最終同意後、ドナーは自分の意向を変えられない。
最終的な同意をした後、ドナーは約1週間の入院をして、術前検査と採取準備（貧血を防ぐための自己血採血）を受ける。
この後、ドナーは幹細胞を採取する処置を受ける。確認検査から採取までの期間はおよそ3～4カ月程度である。

## Experimental Design

```{r }
#| label: intervention
#| fig.cap: Intervention Messages

knitr::include_graphics(here("image", "intervention.png"))
```

我々は、骨髄バンクがドナー候補者に幹細胞提供を依頼する適合通知の内容に介入を施した。上図に介入の内容を示す。
介入前の適合通知はドナー候補者として選ばれたこと、7日以内に提供意思と問診表を記入して返信してほしいことを記載している。
また、適合通知と併せて同封した資料の一つは先の小節で述べた採取までの流れを示したハンドブックである。

我々はコーディネーションの促進を目的として、適合通知に行動科学の知見に基づく二種類のメッセージを追加した（図\@ref(fig:intervention)）[^pressure]。
確率メッセージは骨髄バンクに登録した患者とHLA型が一致するドナー登録者が少ないことを強調している。
これは同時に進行している他のドナー候補者の数に関する信念の過大評価を防ぎ、幹細胞提供の「ただ乗り」行動を抑制できる可能性がある。

[^pressure]: メッセージの作成の際、我々はドナー候補者に過度なプレッシャーを与えないように適切な配慮をしている。第一に、嘆願調のようなメッセージを避けている。第二に、メッセージの作成に際して、骨髄バンクが公開している情報のみを使用している。第三に、これまでと同様に移植リスクに関する説明をしている。

患者メッセージは骨髄バンクを通して移植を受けられる患者が半数しかいないことを強調している。
これは自分が協力しなくても患者は助かるだろうという認識を修正し、ドナー候補者の利他性を刺激していることを目的としている。
さらに、提供に至るまでの期間を短くすることの重要性を強調することで、適合通知への早い返信を促している。

二種類の介入メッセージの効果を推定するために、我々は四つの実験群を設ける。
実験群Aは介入メッセージのない適合通知を送る（コントロール群）。実験群BとCはそれぞれ確率メッセージと患者情報メッセージを送る。
さらに、情報過多による認知負荷の負の影響を検証するために、二つの介入メッセージを両方加えた適合通知を送付する実験群Dも設ける。

```{r}
#| include: false

schedule <- read_csv(here(root, "RCT-schedule.csv")) %>%
  mutate(
    my = paste0(month, "/", year - 2000),
    my = factor(
      my,
      levels = c("9/21", "10/21", "11/21", "12/21", "1/22", "2/22"),
      labels = c("Sep 21", "Oct 21", "Nov 21", "Dec 21", "Jan 22", "Feb 22")
    ),
    week = factor(week, levels = 1:4, labels = paste("Week", 1:4))
  ) %>%
  dplyr::select(week, my, treat) %>%
  pivot_wider(values_from = treat, names_from = my)
```

```{r}
#| label: assignment
#| tab.cap: Assignment Schedule

flextable(schedule) %>%
  align(j = -1, align = "center", part = "all") %>%
  ft_theme()
```

我々は2021年9月から2022年2月にかけて骨髄バンクが適合通知を送付したドナー候補者11,154名をフィールド実験の対象とした。実験群の割り当ては骨髄バンク事務局の業務の無理のない範囲で週単位でクラスターランダム化した。このとき、週・月の固定効果を取り除けるように、実験群が週・月でバランスするように割り当てた。割り当てのスケジュールは表\@ref(tab:assignment)にまとめている。

## Data and Empirical Strategy

```{r}
#| include: false

rawdt <- read_csv(here(root, "shaped.csv"), locale = locale(encoding = "cp932"))

use <- rawdt %>%
  dplyr::filter(ongoing == 0) %>%
  mutate(
    treat = factor(treat, levels = LETTERS[1:4]),
    plan_two_methods = if_else(plan_method == "BM/PB", 1, 0)
  )
```

```{r}
#| output: false

lm_robust(
  ongoing ~ treat,
  data = rawdt,
  cluster = RCTweek,
  se_type = "stata"
) %>%
{
  f <- summary(.)$fstatistic[1]
  numdf <- summary(.)$fstatistic[2]
  dendf <- summary(.)$fstatistic[3]
  p <- pf(f, numdf, dendf, lower.tail = FALSE)

  sprintf("F-value = %1.3f; p-value = %1.3f", f, p)
}
```

我々は2022年6月末に骨髄バンクが管理するコーディネーションデータの提供を受けた。観測単位はフィールド実験の対象であるドナー候補者である。個人属性として性別・年齢・過去のコーディネーション回数・居住地域（都道府県レベル）を記録している。コーディネーションの過程について、提供に至るまでの各工程（適合通知への返信・確認検査・第一候補者選定・最終同意・採取）に到達したかどうかを記録しており、これらをアウトカム変数として用いる。特に、適合通知の返信については、返信したかどうかに加えて、返信日数・提供意向についても記録している。コーディネーションが途中で中断した場合、その理由を三つのカテゴリー（患者理由・ドナーの健康以外の理由・ドナーの健康上の理由）で記録している。分析対象は国内在住でコーディネーションが完全に終了している11,049名とする[^exclude]。

[^exclude]: 海外に在住している人が1人いた。また、データ提供時点でコーディネーションが進行している人が104名いた。コーディネーションが進行している人の比率は実験群間でバランスしている（F-value, p-value = $0.956$）

追加的なデータとして、我々はJMDPがホームページ上で公開している施設リストを用いる。このデータは病院の住所に加えて、骨髄採取が可能かどうか、末梢血幹細胞採取が可能かどうかを含んでいる。我々はこのデータを都道府県レベルで集計して、10平方キロメートル当たりの病院の数を計算し、コーディネーションデータと都道府県をキーとして突合する。我々はこの変数をコーディネーションや提供の移動コストとみなす。

```{r}
#| include: false

balance_test <- use %>%
  select(
    male,
    age,
    coordinate,
    hospital_per_area,
    PB_per_area,
    BM_per_area,
    treat,
    RCTweek
  ) %>%
  pivot_longer(male:BM_per_area, values_to = "value", names_to = "vars") %>%
  group_by(vars) %>%
  do(est = lm_robust(
    value ~ treat,
    clusters = RCTweek,
    se_type = "stata",
    data = .
  )) %>%
  summarize(
    vars = vars,
    f = summary(est)$fstatistic[1],
    numdf = summary(est)$fstatistic[2],
    dendf = summary(est)$fstatistic[3],
    "F-test, p-value" = pf(f, numdf, dendf, lower.tail = FALSE)
  )

size <- with(use, sprintf("%1d", table(treat))) %>%
  {
    tribble(
      ~terms, ~A, ~B, ~C, ~D, ~"F-test, p-value",
      "Standard notification", "X", "X", "X", "X", "",
      "Probability message", "", "X", "", "X", "",
      "Patients message", "", "", "X", "X", "",
      "N", .[1], .[2], .[3], .[4], ""
    )
  }

attr(size, "position") <- seq(nrow(size))
```

```{r}
#| label: experiment-summary
#| tab.cap: Overview of Field Experiment

tbl <- use %>%
  datasummary(
    (`Male (=1)` = male) +
    (`Age` = age) +
    (`Number of past coordinations` = coordinate) +
    (`Number of listed hospitals` = hospital_per_area) +
    (`Number of hospitals listed with PBSC collection` = PB_per_area) +
    (`Number of hospitals listed with BM collection` = BM_per_area) ~ mean * treat,
    data = .,
    add_rows = size,
    add_columns = balance_test[c(5, 1, 3, 4, 6, 2), 5],
    align = "lccccc",
    output = "data.frame"
  ) %>%
  bind_cols(
    tibble(type = c(
      rep("A. Interventions", 3),
      rep("B. Sample Size", 1),
      rep("C. Covariates, Balance Test", 6)
    ))
  )

as_grouped_data(tbl, groups = "type") %>%
  as_flextable(hide_grouplabel = TRUE) %>%
  align(j = -1, align = "center", part = "all") %>%
  padding(i = 2:4, j = 1, padding = 20) %>%
  padding(i = 6, j = 1, padding = 20) %>%
  padding(i = 8:13, j = 1, padding = 20) %>%
  padding(i = 6, j = 1, padding = 20) %>%
  width(j = 1, 2) %>%
  fontsize(size = 9, part = "all") %>%
  ft_theme()
```

表\@ref(tab:experiment-summary)はフィールド実験を概観している。パネルAは各実験群の介入をまとめており、パネルBは各実験群のサンプルサイズを示している。パネルCは共変量のバランステストの結果を示しており、割り当てのランダム化が成功しているかどうかを検証している。ほとんどの共変量が群間でバランスしているので、実験群の割り当てはおおよそランダムである。ただし、実験群C・Dのドナー候補者は実験群A・Bのドナー候補者よりも若く、群間でアンバランスな可能性がある（F-test, p-value = $0.07$）。

ドナー候補者は実験群を選択できない、すなわち、実験群は外生的であるので、単純な二群比較は平均処置効果を識別できる。ただし、年齢および割り当ての週と月の数が実験群間で完全にバランスしていないので、単純な二群比較はバイアスを伴う可能性がある。そこで、二群比較に加えて、我々は$m$月の第$w$週に適合通知を受け取った個人$i$について以下の線形確率モデルを推定する、

\begin{equation}
  Y_{imw} =
  \beta_1 \cdot \text{B}_{mw} + \beta_2 \cdot \text{C}_{mw}
  + \beta_3 \cdot \text{D}_{mw}
  + X'_i \gamma + \lambda_m + \theta_w + u_{imw}
\end{equation}

ここで、$X_i$は個人属性ベクトル、$\lambda_m$と$\theta_w$はそれぞれ週・月のダミー変数である。
我々はランダム化のユニットである実験週レベルでクラスタした標準誤差を使用する。

# Results: Effects on Reply and Intentions

```{r}
#| include: false

stock <- use %>%
  dplyr::filter(exg_stop_reply == 0) %>%
  rename(positive = intention) %>%
  mutate(
    negative = reply * (1 - positive),
    age_demean = age - mean(rawdt$age),
  ) %>%
  select(reply, positive, negative, everything()) %>%
  pivot_longer(reply:negative, names_to = "outcome") %>%
  mutate(outcome = factor(
    outcome,
    levels = unlist(names(outcome_label)[1:3]),
    labels = unlist(outcome_label[1:3])
  ))
```

はじめに、ドナー候補者の意向が最も現れる返信に対する効果を推定する。返信のアウトカム変数は提供意向に関わらず適合通知に返信したらならば1を取るダミー変数である。さらに、提供意向の変数を用いて、返信に対する効果を二つに分解する。第一に、正の意向を示して、適合通知に返信した効果である。アウトカム変数は適合通知に返信し、かつ提供の意向を示したならば1を取るダミー変数である。第二に、負の意向を示して、適合通知に返信した効果である。アウトカム変数は適合通知に返信し、かつ提供の意向を示さなければ1を取るダミー変数である。提供の意向に関する二つのアウトカム変数の和は必ず返信のアウトカム変数と一致するので、二つの意向に対する効果の和は必ず返信に対する効果となる。コントロール（実験群A）の返信率は$88.35$%である。正の意向を伴って返信した比率は$55.33$%である一方で、負の意向を伴って返信した比率は$33.03$%である。したがって、適合通知に返信したドナー候補者の$62.63$%が提供したいと考えている。

返信をする以前に患者側の都合でコーディネーションが中断してしまう可能性がある。このケースはドナー候補者の意向と無関係に生じるコーディネーションの中断なので、分析のサンプルから除外する。各実験群の$0.5$--$0.7$%をこのケースで除外しており、その比率は群間でバランスしている。

## Main Results

```{r}
#| include: false

mod <- list(
  unctrl = value ~ treat,
  ctrl = value ~ treat + age_demean + I(age_demean^2) + male + coordinate +
    hospital_per_area + PB_per_area + BM_per_area +
    factor(prefecture) + factor(month) + factor(week)
)

est_stock <- stock %>%
  group_by(outcome) %>%
  nest() %>%
  mutate(
    fit1 = map(
      data,
      ~ lm_robust(
        mod$unctrl,
        data = .,
        cluster = RCTweek,
        se_type = "stata"
      )
    ),
    fit2 = map(
      data,
      ~ lm_robust(
        mod$ctrl,
        data = .,
        cluster = RCTweek,
        se_type = "stata"
      )
    )
  ) %>%
  pivot_longer(
    fit1:fit2,
    names_prefix = "fit",
    names_to = "model",
    values_to = "fit"
  )

ctrl_avg <- stock %>%
  dplyr::filter(treat == "A") %>%
  group_by(outcome) %>%
  summarize(mean = sprintf("%1.4f", mean(value)))

add_table <- tibble::tribble(
  ~term, ~"(1)", ~"(2)", ~"(3)", ~"(4)", ~"(5)", ~"(6)",
  "Control average", ctrl_avg$mean[1], ctrl_avg$mean[1],
  ctrl_avg$mean[2], ctrl_avg$mean[2],
  ctrl_avg$mean[3], ctrl_avg$mean[3],
  "Covariates", "", "X", "", "X", "", "X"
)

attr(add_table, "position") <- 9:12
```

```{r}
#| label: full-reply
#| tab.cap: Linear Probability Model of Replay and Intention

est_stock %>%
  pull(fit) %>%
  setNames(paste0("(", seq_len(length(.)), ")")) %>%
  modelsummary(
    coef_map = c(
      "(Intercept)" = "Constant",
      "treatB" = "Treatment B",
      "treatC" = "Treatment C",
      "treatD" = "Treatment D"
    ),
    stars = c("***" = .01, "**" = .05, "*" = .1),
    fmt = 4,
    gof_omit = "R2|AIC|BIC|Log|Std|FE|se_type",
    add_rows = add_table,
  ) %>%
  flextable::add_header_row(
    values = c("", "Reply", "Positive", "Negative"),
    colwidths = c(1, 2, 2, 2)
  ) %>%
  flextable::add_header_row(
    values = c("", "Intention"),
    colwidths = c(3, 4)
  ) %>%
  align(j = -1, align = "center", part = "all") %>%
  width(j = 1, 1) %>%
  fontsize(size = 9, part = "all") %>%
  ft_theme()
```

表\@ref(tab:full-reply)は線形確率モデルの推定結果である。奇数列は実験群ダミーのみを説明変数として用いているのに対して、偶数列は個人属性や月・週の固定効果も制御している。列(1)は、確率メッセージを加えた適合通知を送付する実験群Bが返信率を$0.01$もしくは$1.2$%高めていることを示している。個人属性などをコントロールする（列(2)）と、効果のサイズは大きく変化しないが、統計的に5%水準で有意となる。この効果は正の意向を伴った返信の増加に由来している。列(3)と(5)では、実験群Bが正の意向を伴った返信率を$0.02$もしくは$3.94$%高めている一方で、負の意向を伴った返信率を$0.01$もしくは$3.42$%下げている。ただし、これらの統計的な有意性は、個人属性などをコントロールしても、弱い。また、実験群CとDは実験群Bよりも効果のサイズが小さく、統計的に非有意である。我々は頑健性の分析としてロジットモデルを推定した（表\@ref(tab:full-reply-logit)）。その結果は効果の方向について上表と整合的であるが、統計的に非有意である。総合すると、我々の介入は全体的に返信に大きな影響を与えていない。

```{r}
#| label: subsample-reply
#| fig.cap: "Effect on Reply and Intentions by Gender and Age Group. Note: These plots show the average effect (and associated 95% confidential interval) on each outcome by gender and age group. We cluster standard errors by experimental weeks. We control number of past coordinations, number of hospitals per 10 square kilometers, number of hospitals with PBSC collection per 10 square kilometers, number of hospitals with BM collection per 10 square kilometers, prefecture dummies, month dummies, and week dummies."
#| fig.width: 15
#| fig.height: 10

est_stock_sub <- stock %>%
  mutate(age_less30 = if_else(age < 30, 1, 0)) %>%
  group_by(outcome, male, age_less30) %>%
  nest() %>%
  mutate(est = map(data, ~ lm_robust(
    update(mod$ctrl, . ~ . - male - age_demean),
    cluster = RCTweek,
    se_type = "stata",
    data = .x
  ))) %>%
  mutate(
    fit = map(est, tidy),
    fit = map(fit, ~ subset(.x, str_detect(term, "treat"))),
    fit = map(fit, ~ dplyr::select(.x, -outcome)),
    N = map_chr(est, ~ paste("N =", nobs(.x))),
    mean = map_dbl(data, ~ with(subset(., treat == "A"), mean(value))),
    mean = sprintf("Control avg = %1.3f", mean)
  ) %>%
  select(-data, -est) %>%
  unnest(cols = fit) %>%
  mutate(
    pos = paste0(male, age_less30),
    pos = factor(
      pos,
      levels = c("01", "00", "11", "10"),
      labels = c(
        "Female\u00d7\nAge<30",
        "Female\u00d7\n30\u2264Age",
        "Male\u00d7\nAge<30",
        "Male\u00d7\n30\u2264Age"
      )
    ),
    term = str_replace(term, "treat", ""),
    term = factor(term, LETTERS[2:4])
  )

text <- est_stock_sub %>%
  select(male, age_less30, pos, N, mean) %>%
  distinct()

plot_list <- unique(est_stock_sub$outcome) %>%
  purrr::map(function(x) {
    subset(est_stock_sub, outcome == x) %>%
      ggplot(aes(x = pos, y = estimate)) +
      geom_hline(aes(yintercept = 0), linetype = 2) +
      geom_point(
        aes(color = term, shape = term),
        size = 3, position = position_dodge(0.5)
      ) +
      geom_errorbar(
        aes(ymin = conf.low, ymax = conf.high, color = term),
        position = position_dodge(0.5),
        width = 0
      ) +
      geom_text(
        aes(y = -0.125, label = N),
        data = subset(text, outcome == x),
        color = "black"
      ) +
      geom_text(
        aes(y = -0.15, label = mean),
        data = subset(text, outcome == x),
        color = "black"
      ) +
      scale_y_continuous(
        breaks = seq(-0.2, 0.2, by = 0.05), limits = c(-0.17, 0.17)
      ) +
      labs(
        title = paste("Outcome:", x),
        x = "Subset",
        y = "Estimated Effects (95%CI)",
        color = "Treatment", shape = "Treatment"
      ) +
      simplegg()
  })

wrap_plots(plot_list, ncol = 2) +
  plot_layout(guides = "collect") &
  theme(legend.position = "bottom")
```

しかしながら、メッセージの効果は大きな異質性がある。図\@ref(fig:subsample-reply)は性別と年齢層（30歳未満かどうか）でサンプルを4分割して、各サブセットでメッセージの効果を推定している。その結果、確率メッセージを加えた実験群BとDは30歳未満の男性の返信率を$0.06$もしくは$8.06$%高めている（ベースラインの返信率は$74.4$%）。とくに、確率メッセージだけを加えた実験群Bの効果は正の意向を伴う返信率の増加に起因している。このグループで、実験群Bは正の意向を伴う返信率を$0.1$もしくは$25.91$%高めている（ベースラインの比率は$38.6$%）一方で、負の意向を伴う返信率を$0.03$もしくは$8.38$%下げている（ベースラインの比率は$35.8$%）。これらは統計的に有意な効果である。逆に、二つの介入メッセージを加えた実験群Dは負の意向を伴う返信率を$0.31$もしくは$8.66$%下げており、これは統計的に5%水準で有意である。他の性年代のグループ（とくに、30歳以上の男女）では、介入メッセージが返信や意向に大きな影響を与えていない。ただし、30歳未満の女性で、実験群Dが統計的に有意に正の意向を伴う返信率を$0.05$もしくは$9.69$%下げている。したがって、他のドナー候補者が少ないというメッセージは若年男性の提供意向を高め、適合通知への返信を促している。若年男性ドナーは移植成績が良いにも関わらず、提供意向が他の性年代よりも明らかに低いことを考慮すると、確率メッセージは移植コーディネーションの効率性を改善しているといえる。

## Robustness to Heterogenous Treatment Effects

前節では、介入効果は性別・年齢層によって大きく異質的であり、特に、他のドナー候補者が少ないという情報を提供することが若年男性の提供意向を高めて、返信を促していることを明らかにした。この小節では、この結果が頑健であることを確認する。

はじめに、統計的推論に対する頑健性を検証する。ここまでの結果はトリートメントの割り当てに基づいて週レベルでクラスターした標準誤差を用いている。しかしながら、Cameron et al. (2008)はクラスターの数が少ないと、帰無仮説を過度に棄却してしまう恐れがあることを指摘し、クラスターワイルドブートストラップ法によるp値の計算を推奨している。我々は図\@ref(fig:subsample-reply)で示した分析にこの手法を適用して、統計的な有意性が頑健であるかどうかを検証する。補論の表\@ref(tab:robust-subsample-reply)は介入メッセージによって統計的に有意な影響を受ける若年層の結果を示している。その結果、すべてのメッセージの効果の統計的な有意性は下がり、ほとんどの結果が統計的に非有意となる。しかしながら、確率メッセージ（介入群B）が30歳未満の男性の正の意向を伴う返信率を統計的に10%水準で有意に高めている。

```{r}
#| include: false
#| cache: true

covariate <- ~ 0 + male + age + coordinate1 + hospital_per_area +
  PB_per_area + BM_per_area

intdt <- subset(stock, outcome == "Positive intention")
Y <- intdt$value
X <- model.matrix(covariate, data = intdt)
W <- intdt$treat
G <- intdt$RCTweek

rcf <- multi_arm_causal_forest(X, Y, W)
```

次に、より柔軟に異質性を検証するために、causal forestを用いる。Causal forestは与えられた共変量で多くのサブサンプルを作成し、各サブサンプル内で効果を推定する手法である。この手法は各サブサンプルの平均効果の分散を最大にして、サブサンプルを構築している[^mse]。我々は性別、年齢、過去のコーディネーション経験の有無、10平方キロメートル当たりの病院・骨髄採取可能な病院・末梢血幹細胞採取可能な病院を共変量として用いている。

[^mse]: 各サブサンプルの平均効果の分散を最大にすることで、サブサンプルの平均効果の平均二乗誤差（個人の真の効果からの乖離の程度）を最小化にできる。

```{r}
#| label: rcf-intention
#| fig.cap: "Distribution of treatment effects on the positive intention estimated by the random causal effect."
tau <- predict(rcf, X)
plotdt <- data.frame(X) %>%
  cbind(tau$predictions) %>%
  rename(
    effect_B = `B - A.Y.1`,
    effect_C = `C - A.Y.1`,
    effect_D = `D - A.Y.1`
  ) %>%
  pivot_longer(
    effect_B:effect_D,
    names_to = c(".value", "treat"),
    names_sep = "_"
  ) %>%
  mutate(
    treat = factor(treat, labels = paste("Treatment", LETTERS[2:4])),
    age_less30 = if_else(age < 30, 1, 0),
    pos = paste0(male, age_less30),
    pos = factor(
      pos,
      levels = c("01", "00", "11", "10"),
      labels = c(
        "Female\u00d7\nAge<30",
        "Female\u00d7\n30\u2264Age",
        "Male\u00d7\nAge<30",
        "Male\u00d7\n30\u2264Age"
      )
    )
  )

plotdt %>%
  ggplot(aes(x = effect, y = after_stat(count) / sum(after_stat(count)))) +
  geom_histogram(
    aes(fill = effect > 0),
    breaks = seq(-0.3, 0.3, by = 0.025),
    color = "black"
  ) +
  scale_fill_manual(values = c("white", "grey50")) +
  facet_grid(treat~pos) +
  labs(
    x = "Treatment effects",
    y = "Fraction"
  ) +
  simplegg(axis_title_size = 10, axis_text_size = 9) +
  theme(legend.position = "none")
```

```{r}
#| include: false

ate <- average_treatment_effect(rcf, subset = X[, 1] == 1 & X[, 2] < 30)
ate[, 5] <- pnorm(abs(ate[, 1] / ate[, 2]), lower.tail = FALSE) * 2
ate
```

図\@ref(fig:rcf-intention)は正の意向を伴う返信に対する効果の分布を示している。この図もまた確率メッセージ（介入群B）が若年男性のほとんど（92%）の提供意向を高め、返信を促していることが分かる。この群の介入群Bの平均効果は$0.11$パーセンテージポイント（$\text{s.e.} = 0.04; p\text{-value}<0.01$）であり、図\@ref(fig:subsample-reply)の推定値と似ている。

```{r}
#| include: false

plotdt %>%
  dplyr::filter(treat == "Treatment B") %>%
  mutate(positive = effect > 0) %>%
  group_by(pos, positive) %>%
  summarize_at(
    vars(coordinate1, hospital_per_area, PB_per_area, BM_per_area),
    list(~ mean(.))
  ) %>%
  knitr::kable()
```

また、この図は確率メッセージが他の性年代のドナー候補者のおよそ半数の提供意向を高め、返信を促していることが分かる。正の効果を受けるドナー候補者は、負の効果を受けるドナー候補者よりも、過去にコーディネーションを経験しておらず、居住都道府県の病院の数が多い（コーディネーションに関わる移動コストが低い）傾向にある。他の介入群についても、居住都道府県の病院の数が多いと、介入群の効果は正になりやすい。しかしながら、利他メッセージを加えた介入群CとDは過去にコーディネーションの経験がある人の提供意向を促進しやすい。

## Response Speed to Notification

我々のデータは返信日数を記録しているので、トリートメント効果の経時的変化を検証できる。我々は$d$日以内に返信する確率$\text{Pr}(D_{imw} \le d)$を線形確率モデルで推定する。このとき、アウトカム変数は$d$日以内に返信したならば1を取るようなダミー変数である。介入群CとDに含まれる利他メッセージは適合通知に早く返信することで患者の移植率の改善に貢献できることを強調しているので、$d$の値が小さいほど、正の効果となると予想できる。ただし、$d$の値を十分に大きくすると、$\text{Pr}(D_{imw} \le d)$に対する効果は前々小節で示した返信に対する効果と一致する。

```{r}
#| include: false

flow <- stock %>%
  mutate(
    days_reply = if_else(is.na(days_reply), 10000, days_reply),
    days4 = if_else(days_reply <= 4, value, 0),
    days7 = if_else(days_reply <= 7, value, 0),
    days10 = if_else(days_reply <= 10, value, 0),
    days14 = if_else(days_reply <= 14, value, 0),
    days21 = if_else(days_reply <= 21, value, 0),
    days28 = if_else(days_reply <= 28, value, 0)
  ) %>%
  select(-value) %>%
  pivot_longer(days4:days28, names_to = "within", names_prefix = "days") %>%
  mutate(within = as.numeric(within))
```

```{r}
#| include: false

est_flow <- flow %>%
  group_by(outcome, within) %>%
  nest() %>%
  mutate(fit = map(data, ~ lm_robust(
    mod$ctrl,
    cluster = RCTweek,
    se_type = "stata",
    data = .x
  ))) %>%
  mutate(
    tidy = map(fit, tidy),
    tidy = map(tidy, ~ subset(.x, str_detect(term, "treat"))),
    tidy = map(tidy, ~ dplyr::select(.x, -outcome))
  ) %>%
  dplyr::select(-data, -fit) %>%
  unnest(cols = tidy) %>%
  mutate(
    term = str_replace(term, "treat", ""),
    term = factor(term, LETTERS[2:4])
  )

ctrl_avg <- flow %>%
  dplyr::filter(treat == "A") %>%
  group_by(outcome, within) %>%
  summarize(mean = mean(value)) %>%
  mutate(mean = sprintf("%1d\n(%1.3f)", within, mean))
```

```{r}
#| label: fig-full-speed
#| fig-cap: "Effect on Reply within Specific Days after Sending Notification. Notes: These plots show the average effect (and associated 95% confidential interval) on each outcome."
#| fig.width: 15
#| fig.height: 10

plot_list <- unique(est_flow$outcome) %>%
  purrr::map(function(x) {
    subset(est_flow, outcome == x) %>%
      ggplot(aes(x = within, y = estimate, color = term, shape = term)) +
      geom_hline(aes(yintercept = 0), linetype = 2) +
      geom_point(size = 3, position = position_dodge(2)) +
      geom_errorbar(
        aes(ymin = conf.low, ymax = conf.high),
        position = position_dodge(2),
        width = 0
      ) +
      scale_x_continuous(
        breaks = subset(ctrl_avg, outcome == x)$within,
        labels = subset(ctrl_avg, outcome == x)$mean
      ) +
      scale_y_continuous(
        breaks = seq(-0.2, 0.2, by = 0.025), limits = c(-0.1, 0.05)
      ) +
      labs(
        title = paste("Outcome:", x),
        x = "Days after sending notification\n(Control average)",
        y = "Estimated Effects (95%CI)",
        color = "Treatment", shape = "Treatment"
      ) +
      simplegg()
  })

wrap_plots(plot_list, ncol = 2) +
  plot_layout(guides = "collect") &
  theme(legend.position = "bottom")
```

# (APPENDIX) Appendix {-}

```{r}
#| include: false

est_stock <- stock %>%
  group_by(outcome) %>%
  nest() %>%
  mutate(
    fit1 = map(
      data,
      ~ glm(
        mod$unctrl,
        data = .,
        family = binomial()
      )
    ),
    fit2 = map(
      data,
      ~ glm(
        mod$ctrl,
        data = .,
        family = binomial()
      )
    )
  ) %>%
  pivot_longer(
    fit1:fit2,
    names_prefix = "fit",
    names_to = "model",
    values_to = "fit"
  )

add_tables <- tibble::tribble(
  ~term, ~"(1)", ~"(2)", ~"(3)", ~"(4)", ~"(5)", ~"(6)",
  "Covariates", "", "X", "", "X", "", "X"
)

attr(add_tables, "position") <- 7
```

```{r}
#| include: false

tidy_custom.glm <- function(x, ...) {
  tbl <- tidy(x) %>%
    mutate(
      or = exp(estimate),
      lower.or = exp(estimate - 1.96 * std.error),
      upper.or = exp(estimate + 1.96 * std.error)
    )

  tbl
}
```

```{r}
#| label: full-reply-logit
#| tab.cap: Logit Model of Reply and Intention

est_stock %>%
  pull(fit) %>%
  setNames(paste0("(", seq_len(length(.)), ")")) %>%
  modelsummary(
    estimate = "{or}",
    statistic = "[{lower.or}, {upper.or}]",
    coef_map = c(
      "treatB" = "Treatment B",
      "treatC" = "Treatment C",
      "treatD" = "Treatment D"
    ),
    add_rows = add_tables,
    gof_omit = "R2|AIC|BIC|RMSE|Std|FE|se_type",
    fmt = fmt_sprintf("%.3f")
  ) %>%
  flextable::add_header_row(
    values = c("", "Reply", "Positive", "Negative"),
    colwidths = c(1, 2, 2, 2)
  ) %>%
  flextable::add_header_row(
    values = c("", "Intention"),
    colwidths = c(3, 4)
  ) %>%
  align(j = -1, align = "center", part = "all") %>%
  width(j = 1, 1) %>%
  fontsize(size = 9, part = "all") %>%
  ft_theme()
```

```{r}
#| eval: false
#| include: false
#| cahce: true

est_stock_young <- stock %>%
  dplyr::filter(age < 30) %>%
  group_by(outcome, male) %>%
  nest() %>%
  mutate(est = map(data, ~ lm_robust(
    update(mod$ctrl, . ~ . - male - age_demean),
    cluster = RCTweek,
    se_type = "stata",
    data = .x
  )))

wildBS_p <- est_stock_young %>%
  select(-est) %>%
  mutate(
    treatB = map_dbl(data, ~ wildBS(
      update(mod$ctrl, . ~ . - male - age_demean),
      data = .x,
      cluster = RCTweek,
      H0 = "treatB = 0",
      B = 1000
    )),
    treatD = map_dbl(data, ~ wildBS(
      update(mod$ctrl, . ~ . - male - age_demean),
      data = .x,
      cluster = RCTweek,
      H0 = "treatD = 0",
      B = 1000
    ))
  ) %>%
  select(-data)
```

```{r}
#| eval: false
#| label: robust-subsample-reply
#| tab.cap: Linear Probability Model of Replay and Intention (Males and Females Less than 30)

add_table <- data.frame(rbind(
  c("Wild-bootstrap, p-value", rep("", 6)),
  c("B = 0", sprintf("%1.4f", wildBS_p$treatB)),
  c("D = 0", sprintf("%1.4f", wildBS_p$treatD))
))

attr(add_table, "position") <- 9:11

est_stock_young %>%
  pull(est) %>%
  modelsummary(
    coef_map = c(
      "(Intercept)" = "Constant",
      "treatB" = "Treatment B",
      "treatC" = "Treatment C",
      "treatD" = "Treatment D"
    ),
    stars = c("***" = .01, "**" = .05, "*" = .1),
    fmt = 4,
    align = "lcccccc",
    gof_omit = "R2|AIC|BIC|Log|Std|FE|se_type",
    add_rows = add_table
  ) %>%
  flextable::add_header_row(values = c(
    "", "Reply", "Positive", "Negative",
    "Reply", "Positive", "Negative"
  )) %>%
  flextable::add_header_row(
    values = c("", "Female", "Male"),
    colwidths = c(1, 3, 3)
  ) %>%
  align(j = -1, align = "center", part = "all") %>%
  padding(i = 9:11, j = 1, padding = 20) %>%
  width(j = 1, 1) %>%
  fontsize(size = 9, part = "all") %>%
  ft_theme()
```