---
title: |
  Only You: A Field Experiment of Text Message
  to Prevent Free-riding in Japan Marrow Donor Program
subtitle: Effects on Reply and Intention
---

```{r include=FALSE}
library(here)
source(here("R", "_library.r"))
source(here("R", "_outcome_labels.r"))
```

- ドナー候補者の意向が最も現れる返信とその時の提供意向に対する効果を推定する
  - 返信のアウトカム変数は提供意向に関わらず適合通知に返信したらならば1を取るダミー変数
  - 提供意向のアウトカム変数は適合通知に返信し、かつ提供の意向を示したならば1を取るダミー変数
- 返信をする以前に患者側の都合でコーディネーションが中断してしまう可能性がある。
  - このケースは個人の意向と無関係に生じるコーディネーションの中断なので、分析のサンプルから除外する
  - 各実験群の0.5--0.7%をこのケースで除外しており、その比率は群間でバランスしている

```{r load-data, echo=FALSE, message=FALSE}
root <- "D:/JMDPフィールド実験"

schedule <- read_csv(here(root, "RCT-schedule.csv"))

rawdt <- read_csv(
  here(root, "shaped.csv"),
  locale = locale(encoding = "cp932")
)

stock <- rawdt %>%
  mutate(treat = factor(treat, levels = LETTERS[1:4])) %>%
  dplyr::filter(ongoing == 0 & prefecture != "海外") %>%
  dplyr::filter(exg_stop_reply == 0) %>%
  rename(positive = intention) %>%
  mutate(
    negative = reply * (1 - positive),
    age_demean = age - mean(rawdt$age),
  ) %>%
  select(reply, positive, negative, everything()) %>%
  pivot_longer(reply:negative, "outcome") %>%
  mutate(outcome = factor(
    outcome,
    levels = unlist(names(outcome_label)[1:3]),
    labels = unlist(outcome_label[1:3])
  ))

flow <- stock %>%
  mutate(
    days_reply = if_else(is.na(days_reply), 10000, days_reply),
    days4 = if_else(days_reply <= 4, value, 0),
    days7 = if_else(days_reply <= 7, value, 0),
    days10 = if_else(days_reply <= 10, value, 0),
    days14 = if_else(days_reply <= 14, value, 0),
    days21 = if_else(days_reply <= 21, value, 0),
    days28 = if_else(days_reply <= 28, value, 0)
  ) %>%
  select(-value) %>%
  pivot_longer(days4:days28, "within", "days") %>%
  mutate(within = as.numeric(within))
```

## Estimation Results

- 下表は個人属性や月・週ダミーをコントロールした線形確率モデルの推定結果である
- すべてのコントロール変数を加えると、確率メッセージのみを加えたトリートメントB群は返信率を$1.32$%ポイント高めている
  - これは統計的に5%水準で有意である
  - コントロール（実験群A）の返信率が$88.35$%なので、実験群Bは返信率を`r sprintf("$%1.2f$", 100 * 0.0132 / 0.8835)`%高めている
  - ただし、月・週ダミー変数を除いたモデルは効果サイズに大きな変化を与えないものの、統計的に非有意となるので、安定的ではない
  - また、患者情報メッセージを加えている実験群C・Dは統計的に有意な効果をもっていない
- すべてのコントロール変数を加えると、トリートメントB群は提供意向を$2.04$%ポイント高めている
  - これは統計的に非有意である。
  - コントロール群の提供意向の比率が$55.33$%なので、実験群Bは提供意向を`r sprintf("$%1.2f$", 100 * 0.0204 / 0.5533)`%高めている
  - 月・週ダミー変数を除いたモデルは効果サイズに大きな変化を与えないものの、統計的に10%水準で有意となる
  - 実験群C・Dは提供意向に対して統計的に有意な効果を持っていない
- まとめると、他のドナー候補者が少ないことを伝えるメッセージはドナー候補者の返信と提供意向を促している可能性がある。
  - 逆に、骨髄バンクに登録した患者の一部が移植を受けれていないという事実を伝え、ドナー候補者の利他性を刺激するメッセージはドナー候補者の返信と提供意向を促していない
  - 実験群Dの効果がないのは、情報過多による認知負荷というよりむしろ、ドナー候補者の利他性を刺激するメッセージに効果がないことに起因していると考えられる

```{r reg-reply-stock, echo=FALSE, message=FALSE}
mod <- value ~ treat + age_demean + male + coordinate +
  factor(prefecture) + factor(month) + factor(week)

est_stock <- stock %>%
  group_by(outcome) %>%
  nest() %>%
  mutate(
    fit1 = map(
      data,
      ~ lm_robust(
        update(mod, . ~ . - factor(month) - factor(week)),
        cluster = RCTweek, se_type = "stata", data = .
      )
    ),
    fit2 = map(
      data,
      ~ lm_robust(
        mod,
        cluster = RCTweek, se_type = "stata", data = .
      )
    )
  ) %>%
  pivot_longer(
    fit1:fit2,
    names_prefix = "fit",
    names_to = "model",
    values_to = "fit"
  )

ctrl_avg <- stock %>%
  dplyr::filter(treat == "A") %>%
  group_by(outcome) %>%
  summarize(mean = sprintf("%1.4f", mean(value)))

add_table <- tibble::tribble(
  ~term, ~"(1)", ~"(2)", ~"(3)", ~"(4)", ~"(5)", ~"(6)",
  "Control average", ctrl_avg$mean[1], ctrl_avg$mean[1],
  ctrl_avg$mean[2], ctrl_avg$mean[2],
  ctrl_avg$mean[3], ctrl_avg$mean[3],
  "Demographics", "X", "X", "X", "X", "X", "X",
  "Month and week dummies", "", "X", "", "X", "", "X"
)

attr(add_table, "position") <- 7:10

est_stock %>%
  pull(fit) %>%
  setNames(paste0("(", seq_len(length(.)), ")")) %>%
  modelsummary(
    title = "Linear Probability Model of Reply and Intention",
    coef_map = c(
      "treatB" = "Treatment B",
      "treatC" = "Treatment C",
      "treatD" = "Treatment D"
    ),
    stars = c("***" = .01, "**" = .05, "*" = .1),
    fmt = 4,
    gof_omit = "R2|AIC|BIC|Log|Std|FE|se_type",
    add_rows = add_table
  ) %>%
  kableExtra::kable_styling() %>%
  kableExtra::add_header_above(c(
    " " = 1, "Reply" = 2, "Positive" = 2, "Negative" = 2
  )) %>%
  kableExtra::add_header_above(c(
    " " = 3, "Intention" = 4
  )) %>%
  kableExtra::footnote(
    paste(
      "* p < 0.1, ** p < 0.05, *** p < 0.01.",
      "Standard errros are clustered at experimental weeks.",
      "Demographics are gender, (demeaned) age, number of past coordinations,",
      "and prefectures."
    )
  )
```

```{r reg-reply-stock-subsample, echo=FALSE, message=FALSE, fig.width=15, fig.height=10, fig.cap="Subsample Analysis by Gender and Age Group."}
est_stock_sub <- stock %>%
  mutate(age_less30 = if_else(age < 30, 1, 0)) %>%
  group_by(outcome, male, age_less30) %>%
  nest() %>%
  mutate(est = map(data, ~ lm_robust(
    update(mod, . ~ . - male - age_demean),
    cluster = RCTweek,
    se_type = "stata",
    data = .x
  ))) %>%
  mutate(
    fit = map(est, tidy),
    fit = map(fit, ~ subset(.x, str_detect(term, "treat"))),
    fit = map(fit, ~ dplyr::select(.x, -outcome)),
    N = map_chr(est, ~ paste0("N=", nobs(.x)))
  ) %>%
  select(-data, -est) %>%
  unnest(cols = fit) %>%
  mutate(
    pos = paste0(male, age_less30),
    pos = factor(
      pos,
      levels = c("01", "00", "11", "10"),
      labels = c(
        "Female\u00d7\nAge\u226430",
        "Female\u00d7\n30<Age",
        "Male\u00d7\nAge\u226430",
        "Male\u00d7\n30<Age"
      )
    ),
    term = str_replace(term, "treat", ""),
    term = factor(term, LETTERS[2:4])
  )

plot_list <- unique(est_stock_sub$outcome) %>%
  purrr::map(function(x) {
    subset(est_stock_sub, outcome == x) %>%
      ggplot(aes(x = pos, y = estimate)) +
      geom_hline(aes(yintercept = 0), linetype = 2) +
      geom_point(
        aes(color = term, shape = term),
        size = 3, position = position_dodge(0.5)
      ) +
      geom_errorbar(
        aes(ymin = conf.low, ymax = conf.high, color = term),
        position = position_dodge(0.5),
        width = 0
      ) +
      geom_text(
        aes(y = -0.125, label = N),
        data = ungroup(est_stock_sub) %>%
          select(male, age_less30, N, pos) %>%
          distinct(),
        color = "black"
      ) +
      scale_y_continuous(
        breaks = seq(-0.2, 0.2, by = 0.05), limits = c(-0.17, 0.17)
      ) +
      labs(
        title = paste("Outcome:", x),
        x = "Subset",
        y = "Estimated Effects (95%CI)",
        color = "Treatment", shape = "Treatment"
      ) +
      simplegg()
  })

wrap_plots(plot_list, ncol = 2) +
  plot_layout(guides = "collect") &
  theme(legend.position = "bottom")
```

## Robustness Check of Heterogenous Treatment Effects



## Response Speed to Notification

```{r reg-reply-flow, echo=FALSE, message=FALSE, fig.width=15, fig.height=10, fig.cap="Effect on Reply within Specific Days after Sending."}
est_flow <- flow %>%
  group_by(outcome, within) %>%
  nest() %>%
  mutate(fit = map(data, ~ lm_robust(
    mod,
    cluster = RCTweek,
    se_type = "stata",
    data = .x
  ))) %>%
  mutate(
    tidy = map(fit, tidy),
    tidy = map(tidy, ~ subset(.x, str_detect(term, "treat"))),
    tidy = map(tidy, ~ dplyr::select(.x, -outcome))
  ) %>%
  dplyr::select(-data, -fit) %>%
  unnest(cols = tidy) %>%
  mutate(
    term = str_replace(term, "treat", ""),
    term = factor(term, LETTERS[2:4])
  )

ctrl_avg <- flow %>%
  dplyr::filter(treat == "A") %>%
  group_by(outcome, within) %>%
  summarize(mean = mean(value)) %>%
  mutate(mean = sprintf("%1d\n(%1.3f)", within, mean))

plot_list <- unique(est_flow$outcome) %>%
  purrr::map(function(x) {
    subset(est_flow, outcome == x) %>%
      ggplot(aes(x = within, y = estimate, color = term, shape = term)) +
      geom_hline(aes(yintercept = 0), linetype = 2) +
      geom_point(size = 3, position = position_dodge(2)) +
      geom_errorbar(
        aes(ymin = conf.low, ymax = conf.high),
        position = position_dodge(2),
        width = 0
      ) +
      scale_x_continuous(
        breaks = subset(ctrl_avg, outcome == x)$within,
        labels = subset(ctrl_avg, outcome == x)$mean
      ) +
      scale_y_continuous(
        breaks = seq(-0.2, 0.2, by = 0.025), limits = c(-0.1, 0.05)
      ) +
      labs(
        title = paste("Outcome:", x),
        x = "Days after sending notification\n(Control average)",
        y = "Estimated Effects (95%CI)",
        color = "Treatment", shape = "Treatment"
      ) +
      simplegg()
  })

wrap_plots(plot_list, ncol = 2) +
  plot_layout(guides = "collect") &
  theme(legend.position = "bottom")
```

```{r reg-reply-flow-subsample, echo=FALSE, message=FALSE}
est_flow_sub <- flow %>%
  mutate(age_less30 = if_else(age < 30, 1, 0)) %>%
  group_by(outcome, within, male, age_less30) %>%
  nest() %>%
  mutate(fit = map(data, ~ lm_robust(
    update(mod, . ~ . - male - age_demean),
    cluster = RCTweek,
    se_type = "stata",
    data = .x
  ))) %>%
  mutate(
    tidy = map(fit, tidy),
    tidy = map(tidy, ~ subset(.x, str_detect(term, "treat"))),
    tidy = map(tidy, ~ dplyr::select(.x, -outcome))
  ) %>%
  dplyr::select(-data, -fit) %>%
  unnest(cols = tidy) %>%
  mutate(
    term = str_replace(term, "treat", ""),
    term = factor(term, LETTERS[2:4])
  )
```

```{r plot1-reg-reply-flow-subsample, echo=FALSE, message=FALSE, fig.width=15, fig.height=10, fig.cap="Effect on Reply within Specific Days after Sending (Females aged less than 30)."}
plot_list <- unique(est_flow_sub$outcome) %>%
  purrr::map(function(x) {
    subset(est_flow_sub, outcome == x & male == 0 & age_less30 == 1) %>%
      ggplot(aes(x = within, y = estimate, color = term, shape = term)) +
      geom_hline(aes(yintercept = 0), linetype = 2) +
      geom_point(size = 3, position = position_dodge(2)) +
      geom_errorbar(
        aes(ymin = conf.low, ymax = conf.high),
        position = position_dodge(2),
        width = 0
      ) +
      scale_x_continuous(breaks = unique(est_flow_sub$within)) +
      scale_y_continuous(
        breaks = seq(-0.2, 0.2, by = 0.05), limits = c(-0.2, 0.15)
      ) +
      labs(
        title = paste("Outcome:", x),
        x = "Days after sending notification",
        y = "Estimated Effects (95%CI)",
        color = "Treatment", shape = "Treatment"
      ) +
      simplegg()
  })

wrap_plots(plot_list, ncol = 2) +
  plot_layout(guides = "collect") &
  theme(legend.position = "bottom")
```

```{r plot2-reg-reply-flow-subsample, echo=FALSE, message=FALSE, fig.width=15, fig.height=10, fig.cap="Effect on Reply within Specific Days after Sending (Males aged less than 30)."}
plot_list <- unique(est_flow_sub$outcome) %>%
  purrr::map(function(x) {
    subset(est_flow_sub, outcome == x & male == 1 & age_less30 == 1) %>%
      ggplot(aes(x = within, y = estimate, color = term, shape = term)) +
      geom_hline(aes(yintercept = 0), linetype = 2) +
      geom_point(size = 3, position = position_dodge(2)) +
      geom_errorbar(
        aes(ymin = conf.low, ymax = conf.high),
        position = position_dodge(2),
        width = 0
      ) +
      scale_x_continuous(breaks = unique(est_flow_sub$within)) +
      scale_y_continuous(
        breaks = seq(-0.2, 0.2, by = 0.05), limits = c(-0.1, 0.2)
      ) +
      labs(
        title = paste("Outcome:", x),
        x = "Days after sending notification",
        y = "Estimated Effects (95%CI)",
        color = "Treatment", shape = "Treatment"
      ) +
      simplegg()
  })

wrap_plots(plot_list, ncol = 2) +
  plot_layout(guides = "collect") &
  theme(legend.position = "bottom")
```