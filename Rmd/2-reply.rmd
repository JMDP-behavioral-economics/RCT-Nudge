
# Effect on Reply and Intention

## アウトカム変数

- 最も個人の意向が現れる**適合通知への返信**と**移植の意向**をアウトカム変数とする
  - 外生的な要因である患者側の都合でこの工程の段階でコーディネーションが中止した人は除外して分析をする
- 意向という観点から返信に対する効果を二つに分解する
    1. **Positive intention**：提供を希望して返信したかどうか
    1. **Negative intention**：提供を希望しないで返信したかどうか

```{r load-packages, include = FALSE}
library(here)
source(here("R", "_library.r"))
source(here("R", "_outcome_labels.r"))
```

```{r load-data, include = FALSE}
root <- "D:/JMDPフィールド実験"

rawdt <- read_csv(
  here(root, "shaped.csv"),
  locale = locale(encoding = "cp932")
)

use <- rawdt %>%
  mutate(treat = factor(treat, levels = LETTERS[1:4])) %>%
  dplyr::filter(ongoing == 0 & prefecture != "海外") %>%
  dplyr::filter(exg_stop_reply == 0) %>%
  select(
    id,
    treat,
    RCTweek,
    month,
    week,
    toka,
    male,
    age,
    coordinate1,
    days_reply,
    reply,
    positive = intention
  ) %>%
  mutate(
    negative = reply * (1 - positive),
    age_less30 = if_else(age <= 30, 1, 0),
    age_demean = age - mean(rawdt$age),
  ) %>%
  pivot_longer(reply:negative, "outcome") %>%
  mutate(outcome = factor(
    outcome,
    levels = c("reply", "positive", "negative"),
    labels = c("Reply", "Positive intention", "Negative intention")
  ))
```

## 返信・意向に対するメッセージ効果

```{r reg-stock, include = FALSE}
mod <- value ~ treat + age_demean + male + coordinate1 + toka +
  factor(month) + factor(week)

est_stock <- use %>%
  group_by(outcome) %>%
  do(fit = lm_robust(
      mod,
      cluster = RCTweek,
      se_type = "stata",
      data = .
  ))
```

```{r tab-reg-stock}
ctrl_avg <- use %>%
  dplyr::filter(treat == "A") %>%
  group_by(outcome) %>%
  summarize(mean = mean(value)) %>%
  pivot_wider(names_from = outcome, values_from = mean) %>%
  bind_cols(tibble(terms = "Control Avg."), .)

attr(ctrl_avg, "position") <- 7

est_stock %>%
  pull(fit) %>%
  setNames(paste0("(", seq(length(.)), ")")) %>%
  modelsummary(
    stars = c("*" = 0.1, "**" = 0.05, "***" = 0.01),
    coef_map = c(
      "treatB" = "B",
      "treatC" = "C",
      "treatD" = "D"
    ),
    gof_omit = "R2|AIC|BIC|Log|Std|FE|se_type",
    add_rows = ctrl_avg
  ) %>%
  kableExtra::kable_styling(font_size = 8) %>%
  kableExtra::add_header_above(c(
    " " = 1, "Reply" = 1,
    "Positive" = 1, "Negative" = 1
  )) %>%
  kableExtra::add_header_above(c(
    " " = 2,
    "Intention" = 2
  )) %>%
  kableExtra::column_spec(2:4, width = "10em")
```

## コントロール変数の影響

- 女性の方が男性よりも返信率が高いが、ネガティブな意向を示しやすい
- 高齢であるほど、ネガティブな意向を示して返信しなくなる一方で、
ポジティブな意向を示して返信しやすくなる。全体的に、高齢であるほど、返信率が高くなる
- 初めてコーディネートを経験する人はそうでない人よりもネガティブな意向を示して返信しやすいが、
ポジティブな意向を示して返信しなくなる。全体的に、初回コーディネートの方が返信率は高い。
- 東京・大阪・神奈川・愛知に在住している人はそうでない人よりもネガティブな意向を示して返信しなくなる一方で、
ポジティブな意向を示して返信しやすくなる。全体的に、返信率が高くなる
  - 東京・大阪・神奈川・愛知：10平方キロメートル当たりの面談施設が0.5カ所以上の地域

## 性別×年齢による効果の異質性

```{r reg-stock-by-genage, include = FALSE}
est_stock_genage <- use %>%
  group_by(outcome, male, age_less30) %>%
  nest() %>%
  mutate(est = map(data, ~ lm_robust(
    update(mod, . ~ . - male - age_demean),
    cluster = RCTweek,
    se_type = "stata",
    data = .x
  ))) %>%
  mutate(
    fit = map(est, tidy),
    fit = map(fit, ~ subset(.x, str_detect(term, "treat"))),
    fit = map(fit, ~ dplyr::select(.x, -outcome)),
    N = map_chr(est, ~ paste0("N=", nobs(.x)))
  ) %>%
  select(-data, -est) %>%
  unnest(cols = fit) %>%
  mutate(
    pos = paste0(male, age_less30),
    pos = factor(
      pos,
      levels = c("01", "00", "11", "10"),
      labels = c(
        "Female\u00d7\nAge\u226430",
        "Female\u00d7\n30<Age",
        "Male\u00d7\nAge\u226430",
        "Male\u00d7\n30<Age"
      )
    ),
    term = str_replace(term, "treat", ""),
    term = factor(term, LETTERS[2:4])
  )
```

```{r plot-reg-stock-by-genage, fig.width = 10, fig.height=7}
plot_list <- unique(est_stock_genage$outcome) %>%
  purrr::map(function(x) {
    subset(est_stock_genage, outcome == x) %>%
      ggplot(aes(x = pos, y = estimate)) +
        geom_hline(aes(yintercept = 0), linetype = 2) +
        geom_point(
          aes(color = term, shape = term),
          size = 3, position = position_dodge(0.5)
        ) +
        geom_errorbar(
          aes(ymin = conf.low, ymax = conf.high, color = term),
          position = position_dodge(0.5),
          width = 0
        ) +
        geom_text(
          aes(y = -0.125, label = N),
          data = ungroup(est_stock_genage) %>%
            select(male, age_less30, N, pos) %>%
            distinct(),
          color = "black"
        ) +
        scale_y_continuous(
          breaks = seq(-0.2, 0.2, by = 0.05), limits = c(-0.17, 0.17)
        ) +
        labs(
          title = paste("Outcome:", x),
          x = "Subset",
          y = "Estimated Effects (95%CI)",
          color = "Treatment", shape = "Treatment"
        ) +
        simplegg()
  })

wrap_plots(plot_list, ncol = 2) +
  plot_layout(guides = "collect") &
  theme(legend.position = "bottom")
```

## フロー変数（返信日数）の分析

- 適合通知を送付してから$X$日以内に返信したかどうか（提供を希望して返信したかどうか／提供を希望しないで返信したかどうか）をアウトカム変数として、効果の経時的変化を分析する
  - 適合通知には、**7日以内**の返信をお願いしている

## 返信日数の分布

```{r dist-days-reply}
reply_rate <- subset(use, outcome == "Reply") %>%
  with(table(treat, days_reply)) %>%
  as.data.frame(stringsAsFactors = FALSE) %>%
  tibble() %>%
  mutate(
    treat = factor(treat, levels = LETTERS[1:4]),
    days_reply = as.numeric(days_reply)
  ) %>%
  rename(N = Freq) %>%
  left_join(
    subset(use, outcome == "Reply") %>% with(table(treat)) %>% as.data.frame(),
    by = "treat"
  ) %>%
  group_by(treat) %>%
  mutate(prop =  cumsum(N) / Freq)

ggplot(reply_rate, aes(x = days_reply, y = prop * 100)) +
  geom_line(aes(group = treat, color = treat)) +
  geom_point(aes(shape = treat, color = treat), size = 3) +
  scale_x_continuous(breaks = seq(0, 90, by = 5)) +
  scale_y_continuous(breaks = seq(0, 100, by = 10)) +
  labs(
    x = "Days after sending notification",
    y = "Cumulative reply rate (%)",
    color = "Treat",
    shape = "Treat"
  ) +
  simplegg()
``` 

```{r flow-data}
flow_use <- use %>%
  mutate(
    days_reply = if_else(
      is.na(days_reply),
      10000,
      days_reply
    ),
    days4 = if_else(days_reply <= 4, value, 0),
    days7 = if_else(days_reply <= 7, value, 0),
    days14 = if_else(days_reply <= 14, value, 0),
    days21 = if_else(days_reply <= 21, value, 0),
    days28 = if_else(days_reply <= 28, value, 0)
  ) %>%
  select(-value) %>%
  pivot_longer(days4:days28, "within", "days") %>%
  mutate(within = as.numeric(within))
```

## フルサンプルの分析結果

```{r reg-flow}
est_flow <- flow_use %>%
  group_by(outcome, within) %>%
  nest() %>%
  mutate(fit = map(data, ~ lm_robust(
    mod,
    cluster = RCTweek,
    se_type = "stata",
    data = .x
  ))) %>%
  mutate(
    tidy = map(fit, tidy),
    tidy = map(tidy, ~ subset(.x, str_detect(term, "treat"))),
    tidy = map(tidy, ~ dplyr::select(.x, -outcome))
  ) %>%
  dplyr::select(-data, -fit) %>%
  unnest(cols = tidy) %>%
  mutate(
    term = str_replace(term, "treat", ""),
    term = factor(term, LETTERS[2:4])
  )
```

```{r plot-reg-flow}
plot_list <- unique(est_flow$outcome) %>%
  purrr::map(function(x) {
    subset(est_flow, outcome == x) %>%
      ggplot(aes(x = within, y = estimate, color = term, shape = term)) +
      geom_hline(aes(yintercept = 0), linetype = 2) +
      geom_point(size = 3, position = position_dodge(2)) +
      geom_errorbar(
        aes(ymin = conf.low, ymax = conf.high),
        position = position_dodge(2),
        width = 0
      ) +
      scale_x_continuous(breaks = unique(est_flow$within)) +
      scale_y_continuous(
        breaks = seq(-0.2, 0.2, by = 0.05), limits = c(-0.1, 0.1)
      ) +
      labs(
        title = paste("Outcome:", x),
        x = "Days after sending notification",
        y = "Estimated Effects (95%CI)",
        color = "Treatment", shape = "Treatment"
      ) +
      simplegg()
  })

wrap_plots(plot_list, ncol = 2) +
  plot_layout(guides = "collect") &
  theme(legend.position = "bottom")
```

## 異質性：30歳以下の女性

```{r reg-flow-by-genage}
est_flow_genage <- flow_use %>%
  group_by(outcome, within, male, age_less30) %>%
  nest() %>%
  mutate(fit = map(data, ~ lm_robust(
    update(mod, . ~ . - male - age_demean),
    cluster = RCTweek,
    se_type = "stata",
    data = .x
  ))) %>%
  mutate(
    tidy = map(fit, tidy),
    tidy = map(tidy, ~ subset(.x, str_detect(term, "treat"))),
    tidy = map(tidy, ~ dplyr::select(.x, -outcome))
  ) %>%
  dplyr::select(-data, -fit) %>%
  unnest(cols = tidy) %>%
  mutate(
    term = str_replace(term, "treat", ""),
    term = factor(term, LETTERS[2:4])
  )
```

```{r plot-reg-flow-female-less30}
plot_list <- unique(est_flow$outcome) %>%
  purrr::map(function(x) {
    subset(est_flow_genage, outcome == x & male == 0 & age_less30 == 1) %>%
      ggplot(aes(x = within, y = estimate, color = term, shape = term)) +
      geom_hline(aes(yintercept = 0), linetype = 2) +
      geom_point(size = 3, position = position_dodge(2)) +
      geom_errorbar(
        aes(ymin = conf.low, ymax = conf.high),
        position = position_dodge(2),
        width = 0
      ) +
      scale_x_continuous(breaks = unique(est_flow$within)) +
      scale_y_continuous(
        breaks = seq(-0.2, 0.2, by = 0.05), limits = c(-0.2, 0.15)
      ) +
      labs(
        title = paste("Outcome:", x),
        x = "Days after sending notification",
        y = "Estimated Effects (95%CI)",
        color = "Treatment", shape = "Treatment"
      ) +
      simplegg()
  })

wrap_plots(plot_list, ncol = 2) +
  plot_layout(guides = "collect") &
  theme(legend.position = "bottom")
```

## 異質性：30歳を上回る女性

```{r plot-reg-flow-female-over30}
plot_list <- unique(est_flow$outcome) %>%
  purrr::map(function(x) {
    subset(est_flow_genage, outcome == x & male == 0 & age_less30 == 0) %>%
      ggplot(aes(x = within, y = estimate, color = term, shape = term)) +
      geom_hline(aes(yintercept = 0), linetype = 2) +
      geom_point(size = 3, position = position_dodge(2)) +
      geom_errorbar(
        aes(ymin = conf.low, ymax = conf.high),
        position = position_dodge(2),
        width = 0
      ) +
      scale_x_continuous(breaks = unique(est_flow$within)) +
      scale_y_continuous(
        breaks = seq(-0.2, 0.2, by = 0.05), limits = c(-0.12, 0.1)
      ) +
      labs(
        title = paste("Outcome:", x),
        x = "Days after sending notification",
        y = "Estimated Effects (95%CI)",
        color = "Treatment", shape = "Treatment"
      ) +
      simplegg()
  })

wrap_plots(plot_list, ncol = 2) +
  plot_layout(guides = "collect") &
  theme(legend.position = "bottom")
```

## 異質性：30歳以下の男性

```{r plot-reg-flow-male-less30}
plot_list <- unique(est_flow$outcome) %>%
  purrr::map(function(x) {
    subset(est_flow_genage, outcome == x & male == 1 & age_less30 == 1) %>%
      ggplot(aes(x = within, y = estimate, color = term, shape = term)) +
      geom_hline(aes(yintercept = 0), linetype = 2) +
      geom_point(size = 3, position = position_dodge(2)) +
      geom_errorbar(
        aes(ymin = conf.low, ymax = conf.high),
        position = position_dodge(2),
        width = 0
      ) +
      scale_x_continuous(breaks = unique(est_flow$within)) +
      scale_y_continuous(
        breaks = seq(-0.2, 0.2, by = 0.05), limits = c(-0.1, 0.2)
      ) +
      labs(
        title = paste("Outcome:", x),
        x = "Days after sending notification",
        y = "Estimated Effects (95%CI)",
        color = "Treatment", shape = "Treatment"
      ) +
      simplegg()
  })

wrap_plots(plot_list, ncol = 2) +
  plot_layout(guides = "collect") &
  theme(legend.position = "bottom")
```

## 異質性：30歳を上回る男性

```{r plot-reg-flow-male-over30}
plot_list <- unique(est_flow$outcome) %>%
  purrr::map(function(x) {
    subset(est_flow_genage, outcome == x & male == 1 & age_less30 == 0) %>%
      ggplot(aes(x = within, y = estimate, color = term, shape = term)) +
      geom_hline(aes(yintercept = 0), linetype = 2) +
      geom_point(size = 3, position = position_dodge(2)) +
      geom_errorbar(
        aes(ymin = conf.low, ymax = conf.high),
        position = position_dodge(2),
        width = 0
      ) +
      scale_x_continuous(breaks = unique(est_flow$within)) +
      scale_y_continuous(
        breaks = seq(-0.2, 0.2, by = 0.05), limits = c(-0.15, 0.1)
      ) +
      labs(
        title = paste("Outcome:", x),
        x = "Days after sending notification",
        y = "Estimated Effects (95%CI)",
        color = "Treatment", shape = "Treatment"
      ) +
      simplegg()
  })

wrap_plots(plot_list, ncol = 2) +
  plot_layout(guides = "collect") &
  theme(legend.position = "bottom")
```

## 地域による異質性の検討

- メッセージBは面談施設が多い都道府県（東京・大阪・愛知・神奈川）に在住している人に対しても有効
- 性別×地域による異質性を分析すると、メッセージBは面談施設が多い地域に住む女性に対して有効ではないが、
面談施設が多い地域に住む男性に対して有効である。
