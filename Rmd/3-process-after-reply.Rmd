
# Effect on Coordination Process

## アウトカム変数

返信以降の4工程をそれぞれアウトカム変数とする

1. **CT**: 確認検査を実施したならば1を取る二値変数
1. **Candidate**: 第一候補者に選定されたならば1を取る二値変数
1. **Consent**: 最終同意をしたならば1を取る二値変数
1. **Donation**: 採取をしたならば1を取る二値変数

各アウトカム変数に対するサンプルの除外条件は以下の通り

- CT: 患者側の都合で確認検査を実施しなかった人
- Candidate～Donation: 患者側の都合で確認検査を実施しなかった人
もしくは、患者側の都合や健康上の理由で候補者選定以降にコーディネーションが中止した人

```{r load-packages, include = FALSE}
library(here)
source(here("R", "_library.r"))
source(here("R", "_outcome_labels.r"))
```

```{r load-data, include = FALSE}
root <- "D:/JMDPフィールド実験"

rawdt <- read_csv(
  here(root, "shaped.csv"),
  locale = locale(encoding = "cp932")
)

use <- rawdt %>%
  dplyr::filter(ongoing == 0 & prefecture != "海外") %>%
  mutate(treat = factor(treat, levels = LETTERS[1:4]))

outcomes <- use %>%
  select(
    id,
    test,
    candidate,
    consent,
    donate,
    treat,
    RCTweek,
    month,
    week,
    toka,
    male,
    age,
    coordinate1,
    exg_stop_reply
  ) %>%
  pivot_longer(test:donate, names_to = "outcome")

exclude <- use %>%
  select(id, starts_with("exg_stop")) %>%
  pivot_longer(
    -id, names_to = "outcome", values_to = "exclude",
    names_prefix = "exg_stop_"
  )

testdt <- outcomes %>%
  dplyr::left_join(exclude, by = c("id", "outcome")) %>%
  mutate(
    age_less30 = if_else(age <= 30, 1, 0),
    age_demean = age - mean(rawdt$age),
    outcome = factor(
      outcome,
      levels = c("test", "candidate", "consent", "donate"),
      labels = c("CT", "Candidate", "Consent", "Donation")
    )
  )
```

## 回帰分析の結果

```{r reg-process, include = FALSE}
model <- value ~ treat + age_demean + male + coordinate1 + toka +
  factor(month) + factor(week)

est_process1 <- testdt %>%
  dplyr::filter(exg_stop_reply == 0) %>%
  group_by(outcome) %>%
  do(fit = lm_robust(
      model,
      cluster = RCTweek,
      se_type = "stata",
      data = .
  ))

est_process2 <- testdt %>%
  group_by(outcome) %>%
  do(fit = lm_robust(
    model,
    cluster = RCTweek,
    se_type = "stata",
    data = subset(., exclude == 0)
  ))
```

```{r tab-reg-process}
ctrl_avg <- testdt %>%
  dplyr::filter(exclude == 0) %>%
  dplyr::filter(treat == "A") %>%
  group_by(outcome) %>%
  summarize(mean = mean(value)) %>%
  pivot_wider(names_from = outcome, values_from = mean) %>%
  bind_cols(tibble(terms = "Control Avg."), .)

est_process2 %>%
  pull(fit) %>%
  setNames(paste0("(", seq_len(length(.)), ")")) %>%
  modelsummary(
    stars = c("*" = 0.1, "**" = 0.05, "***" = 0.01),
    coef_map = c(
      "treatB" = "B",
      "treatC" = "C",
      "treatD" = "D"
    ),
    gof_omit = "R2|AIC|BIC|Log|Std|FE|se_type",
    add_rows = ctrl_avg
  ) %>%
  kableExtra::kable_styling(font_size = 8) %>%
  kableExtra::add_header_above(
    c(" ", as.character(est_model$outcome))
  ) %>%
  kableExtra::column_spec(2:5, width = "5em")
```

## コントロール変数に関する結果

- 男性は女性よりも各工程にたどり着きやすい
- 若い人ほど、各工程にたどり着きやすい
- 初めてコーディネーションを経験する人はそうでない人よりも各工程にたどり着きづらい（その差は小さくなっていく）
- 面談施設が多い地域に住む人はそうでない人よりも各工程にたどり着きやすい

## 性別×年齢による効果の異質性

```{r reg-process-by-genage, include = FALSE}
est_process_genage <- testdt %>%
  dplyr::filter(exclude == 0) %>%
  group_by(outcome, male, age_less30) %>%
  nest() %>%
  mutate(fit = map(data, ~ lm_robust(
    update(model, . ~ . - male - age_demean),
    cluster = RCTweek,
    se_type = "stata",
    data = .x
  ))) %>%
  mutate(
    tidy = map(fit, tidy),
    tidy = map(tidy, ~ subset(.x, str_detect(term, "treat"))),
    tidy = map(tidy, ~ dplyr::select(.x, -outcome)),
    N = map_chr(fit, ~ paste0("N=", nobs(.x)))
  ) %>%
  select(-data, -fit) %>%
  unnest(cols = tidy) %>%
  mutate(
    pos = paste0(male, age_less30),
    pos = factor(
      pos,
      levels = c("01", "00", "11", "10"),
      labels = c(
        "Female\u00d7\nAge\u226430",
        "Female\u00d7\n30<Age",
        "Male\u00d7\nAge\u226430",
        "Male\u00d7\n30<Age"
      )
    )
  )
```

```{r plot-reg-process-by-genage, fig.width = 10, fig.height=7}
est_process_genage %>%
  ggplot(aes(x = pos, y = estimate)) +
  geom_hline(aes(yintercept = 0), linetype = 2) +
  geom_point(
    aes(shape = term, color = term),
    size = 3,
    position = position_dodge(0.5)
  ) +
  geom_errorbar(
    aes(ymin = conf.low, ymax = conf.high, color = term),
    position = position_dodge(0.5), width = 0
  ) +
  geom_text(
    aes(y = -0.15, label = N, group = outcome),
    data = ungroup(est_process_genage) %>%
      select(outcome, male, age_less30, N, pos) %>%
      distinct(),
    color = "black"
  ) +
  facet_wrap(~outcome, ncol = 2) +
  scale_y_continuous(
    limits = c(-0.2, 0.2),
    breaks = seq(-0.2, 0.2, by = 0.05)
  ) +
  labs(
    x = "Subset",
    y = "Estimated Effects (95%CI)",
    shape = "Treatments", color = "Treatments"
  ) +
  simplegg()
```
