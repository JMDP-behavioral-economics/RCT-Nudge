
```{r load-packages, include = FALSE}
library(here)
source(here("R", "_library.r"))
source(here("R", "_outcome_labels.r"))
```

```{r load-data, include = FALSE}
root <- "D:/JMDPフィールド実験"

hospital <- read_csv(
  here(root, "hospital-list.csv"),
  locale = locale(encoding = "cp932")
) %>%
  mutate(
    qt_hospital = ntile(hospital_per_area, n = 4),
    qt_hospital = factor(
      qt_hospital,
      labels = c("bottom", "2nd", "3rd", "top")
    )
  )

rawdt <- read_csv(
  here(root, "shaped.csv"),
  locale = locale(encoding = "cp932")
)

use <- rawdt %>%
  mutate(treat = factor(treat, levels = LETTERS[1:4]))

testdt <- use %>%
  dplyr::filter(exg_stop_reply == 0  & prefecture != "海外") %>%
  select(
    id,
    reply,
    intention,
    days_reply,
    treat,
    RCTweek,
    month,
    week,
    prefecture,
    male,
    age,
    coordinate
  ) %>%
  mutate(
    prefecture = factor(prefecture, c("東京都", unique(rawdt$prefecture)[-11])),
    age_less30 = if_else(age <= 30, 1, 0),
    age_demean = age - mean(rawdt$age),
    coordinate1 = if_else(coordinate == 1, 1, 0),
    days_reply = if_else(
      is.na(days_reply),
      max(use$days_reply, na.rm = TRUE),
      days_reply
    ),
    reply_full = reply,
    reply_5 = if_else(days_reply <= 5, 1, 0),
    reply_10 = if_else(days_reply <= 10, 1, 0),
    reply_20 = if_else(days_reply <= 20, 1, 0),
    reply_30 = if_else(days_reply <= 30, 1, 0),
    intention_full = intention,
    intention_5 = if_else(days_reply <= 5, intention, 0),
    intention_10 = if_else(days_reply <= 10, intention, 0),
    intention_20 = if_else(days_reply <= 20, intention, 0),
    intention_30 = if_else(days_reply <= 30, intention, 0)
  ) %>%
  select(-reply, -intention, -days_reply) %>%
  pivot_longer(
    reply_full:intention_30,
    names_to = c(".value", "within"),
    names_pattern = "(.*)_(.*)"
  ) %>%
  mutate(within = factor(
    within,
    levels = c("full", "5", "10", "20", "30")
  )) %>%
  pivot_longer(reply:intention, names_to = "outcome")
```

## Linear Probability Model

$m$月の第$w$週に適合通知を受け取った個人$i$について、

$$
  Y_{imw} =
  \beta_1 \cdot \text{B}_{mw} + \beta_2 \cdot \text{C}_{mw}
  + \beta_3 \cdot \text{D}_{mw}
  + X'_i \gamma + \lambda_m + \theta_w + u_{imw}
$$

- $X_i$は性別・年齢・居住する都道府県・コーディネーション回数
- $\lambda_m$と$\theta_w$は週・月の固定効果
- $\beta_1 = \beta_2$、$\beta_1 = \beta_3$、$\beta_2 = \beta_3$の帰無仮説に対する
F検定を実施

## Effect on Reply and Intention

返信に関するアウトカム変数$Y_{imw}$

- 返信したかどうか
- $X \in \{5, 10, 20, 30\}$日以内に返信したかどうか

意向に関するアウトカム変数$Y_{imw}$

- 提供を希望するという意向を示して返信した
- $X \in \{5, 10, 20, 30\}$日以内に返信し、意向を示したかどうか

## Linear Probability Model of Reply

```{r reg-reply, include = FALSE}
mod <- value ~ treat + age_demean + male + coordinate1 + prefecture +
  factor(month) + factor(week)

est_mod <- testdt %>%
  group_by(outcome, within) %>%
  do(
    est = lm_robust(
      mod,
      cluster = RCTweek,
      se_type = "stata",
      data = .
    ),
    ftestBC = lh_robust(
      mod,
      cluster = RCTweek,
      se_type = "stata",
      linear_hypothesis = "treatB - treatC = 0",
      data = .
    )$lh %>% tidy(),
    ftestBD = lh_robust(
      mod,
      cluster = RCTweek,
      se_type = "stata",
      linear_hypothesis = "treatB - treatD = 0",
      data = .
    )$lh %>% tidy(),
    ftestCD = lh_robust(
      mod,
      cluster = RCTweek,
      se_type = "stata",
      linear_hypothesis = "treatC - treatD = 0",
      data = .
    )$lh %>% tidy()
  )
```

```{r tab-reg-reply}
est_mod_reply <- est_mod %>%
  dplyr::filter(outcome == "reply")

est_mod_reply %>%
  pull(est) %>%
  setNames(paste0("(", seq(length(.)), ")")) %>%
  modelsummary(
    stars = c("*" = 0.1, "**" = 0.05, "***" = 0.01),
    coef_map = c(
      "treatB" = "B",
      "treatC" = "C",
      "treatD" = "D"
    ),
    gof_omit = "R2|AIC|BIC|Log|Std|FE|se_type",
    add_rows = bind_rows(est_mod_reply$ftestBC)$p.value %>%
      rbind(bind_rows(est_mod_reply$ftestBD)$p.value) %>%
      rbind(bind_rows(est_mod_reply$ftestCD)$p.value) %>%
      data.frame(term = c("B = C", "B = D", "C = D"), .)
  ) %>%
  kableExtra::kable_styling(font_size = 9) %>%
  kableExtra::add_header_above(c(
    " " = 1, "Reply" = 1,
    "5 days" = 1, "10 days" = 1, "20 days" = 1, "30 days" = 1
  )) %>%
  kableExtra::add_header_above(c(
    " " = 2,
    "Reply within specific day" = 4
  )) %>%
  kableExtra::column_spec(2:6, width = "6em") %>%
  kableExtra::group_rows(
    "F-tests, p-value", 8, 10,
    bold = FALSE, italic = TRUE
  )
```

## Linear Probability Model of Intention

```{r tab-reg-int}
est_mod_int <- est_mod %>%
  dplyr::filter(outcome == "intention")

est_mod_int %>%
  pull(est) %>%
  setNames(paste0("(", seq(length(.)), ")")) %>%
  modelsummary(
    stars = c("*" = 0.1, "**" = 0.05, "***" = 0.01),
    coef_map = c(
      "treatB" = "B",
      "treatC" = "C",
      "treatD" = "D"
    ),
    gof_omit = "R2|AIC|BIC|Log|Std|FE|se_type",
    add_rows = bind_rows(est_mod_int$ftestBC)$p.value %>%
      rbind(bind_rows(est_mod_int$ftestBD)$p.value) %>%
      rbind(bind_rows(est_mod_int$ftestCD)$p.value) %>%
      data.frame(term = c("B = C", "B = D", "C = D"), .)
  ) %>%
  kableExtra::kable_styling(font_size = 9) %>%
  kableExtra::add_header_above(c(
    " " = 1, "Intention" = 1,
    "5 days" = 1, "10 days" = 1, "20 days" = 1, "30 days" = 1
  )) %>%
  kableExtra::add_header_above(c(
    " " = 2,
    "Intention with reply within specific day" = 4
  )) %>%
  kableExtra::column_spec(2:6, width = "6em") %>%
  kableExtra::group_rows(
    "F-tests, p-value", 8, 10,
    bold = FALSE, italic = TRUE
  )
```

<!-- ## Heterogenous Effect on Reply within X days by Gender x Age

- 性別と年齢（30歳以下どうか）でサンプルを分割して、
$X$日以内に返信したかどうかをアウトカム変数としたLinear probability modelを推定 -->

```{r hetero-gender-age-secandary, include = FALSE, eval = FALSE}
est_within_reply_hetero <- testdt %>%
  group_by(within, male, age_less30) %>%
  do(est = lm_robust(
    update(model, . ~ . - male - age_demean),
    cluster = RCTweek,
    se_type = "stata",
    data = .
  )) %>%
  rowwise(within, male, age_less30) %>%
  summarize(
    estimate.B = subset(tidy(est), term == "treatB")$estimate,
    lwr_conf.B = subset(tidy(est), term == "treatB")$conf.low,
    upr_conf.B = subset(tidy(est), term == "treatB")$conf.high,
    estimate.C = subset(tidy(est), term == "treatC")$estimate,
    lwr_conf.C = subset(tidy(est), term == "treatC")$conf.low,
    upr_conf.C = subset(tidy(est), term == "treatC")$conf.high,
    estimate.D = subset(tidy(est), term == "treatD")$estimate,
    lwr_conf.D = subset(tidy(est), term == "treatD")$conf.low,
    upr_conf.D = subset(tidy(est), term == "treatD")$conf.high,
    nobs = nobs(est)
  ) %>%
  pivot_longer(
    estimate.B:upr_conf.D,
    names_to = c(".value", "treat"),
    names_pattern = "(.*).(.)"
  ) %>%
  ungroup() %>%
  mutate(
    pos = paste0(male, age_less30),
    N = paste0("N=", nobs)
  )
```

<!-- ## Message B on Reply within X days -->

```{r plotB-hetero-gender-age-secondary, fig.width = 10, fig.height=7, eval = FALSE}
est_within_reply_hetero %>%
  dplyr::filter(treat == "B") %>%
  ggplot(aes(x = pos, y = estimate)) +
    geom_hline(aes(yintercept = 0), linetype = 2) +
    geom_pointrange(aes(ymin = lwr_conf, ymax = upr_conf)) +
    geom_text(aes(y = -0.15, label = N)) +
    facet_wrap(~ within, ncol = 2) +
    scale_y_continuous(
      breaks = seq(-0.2, 0.2, by = 0.05), limits = c(-0.17, 0.17)
    ) +
    scale_x_discrete(
      breaks = c("00", "01", "10", "11"),
      labels = c(
        "Female\u00d7\n30<Age",
        "Female\u00d7\nAge\u226430",
        "Male\u00d7\n30<Age",
        "Male\u00d7\nAge\u226430"
      )
    ) +
    labs(x = "Subset", y = "Estimate (95%CI)") +
    simplegg()
```

<!-- ## Message C on Reply within X days -->

```{r plotC-hetero-gender-age-secondary, fig.width = 10, fig.height=7, eval = FALSE}
est_within_reply_hetero %>%
  dplyr::filter(treat == "C") %>%
  ggplot(aes(x = pos, y = estimate)) +
    geom_hline(aes(yintercept = 0), linetype = 2) +
    geom_pointrange(aes(ymin = lwr_conf, ymax = upr_conf)) +
    geom_text(aes(y = -0.15, label = N)) +
    facet_wrap(~ within, ncol = 2) +
    scale_y_continuous(
      breaks = seq(-0.2, 0.2, by = 0.05), limits = c(-0.17, 0.17)
    ) +
    scale_x_discrete(
      breaks = c("00", "01", "10", "11"),
      labels = c(
        "Female\u00d7\n30<Age",
        "Female\u00d7\nAge\u226430",
        "Male\u00d7\n30<Age",
        "Male\u00d7\nAge\u226430"
      )
    ) +
    labs(x = "Subset", y = "Estimate (95%CI)") +
    simplegg()
```

<!-- ## Message D on Reply within X days -->

```{r plotD-hetero-gender-age-secondary, fig.width = 10, fig.height=7, eval = FALSE}
est_within_reply_hetero %>%
  dplyr::filter(treat == "D") %>%
  ggplot(aes(x = pos, y = estimate)) +
    geom_hline(aes(yintercept = 0), linetype = 2) +
    geom_pointrange(aes(ymin = lwr_conf, ymax = upr_conf)) +
    geom_text(aes(y = -0.15, label = N)) +
    facet_wrap(~ within, ncol = 2) +
    scale_y_continuous(
      breaks = seq(-0.2, 0.2, by = 0.05), limits = c(-0.17, 0.17)
    ) +
    scale_x_discrete(
      breaks = c("00", "01", "10", "11"),
      labels = c(
        "Female\u00d7\n30<Age",
        "Female\u00d7\nAge\u226430",
        "Male\u00d7\n30<Age",
        "Male\u00d7\nAge\u226430"
      )
    ) +
    labs(x = "Subset", y = "Estimate (95%CI)") +
    simplegg()
```

<!-- ## Change Threshold of Younger Group

- 若年層の区切りを30～40歳の範囲で変えて、
若年層の男性と女性におけるメッセージの効果を推定した -->

```{r change-age-threshold-secondary, eval = FALSE}
age_criterion_secondary <- 30:40 %>%
  purrr::map(function(x) {
    testdt %>%
      dplyr::filter(age <= x) %>%
      group_by(within, male) %>%
      do(
        lm_robust(
          update(model, . ~ . - male - age_demean),
          cluster = RCTweek,
          se_type = "stata",
          data = .
        ) %>%
          tidy() %>%
          dplyr::filter(str_detect(term, "treat")) %>%
          select(-outcome)
      ) %>%
      ungroup() %>%
      mutate(age = x)
  }) %>%
  reduce(bind_rows) %>%
  mutate(male = factor(male, levels = 0:1, labels = c("Females", "Males")))
```


<!-- ## Message B Effect among Younger Group -->

```{r plotB-change-age-threshold-secondary, fig.width=15, fig.height=10, eval = FALSE}
age_criterion_secondary %>%
  dplyr::filter(term == "treatB") %>%
  ggplot(aes(x = age, y = estimate, color = male, group = male)) +
    geom_hline(aes(yintercept = 0), linetype = 2) +
    geom_point(size = 3) +
    geom_line(size = 1) +
    geom_line(aes(y = conf.low), linetype = 2) +
    geom_line(aes(y = conf.high), linetype = 2) +
    facet_wrap(~ within, ncol = 2) +
    scale_x_continuous(breaks = 30:40) +
    scale_y_continuous(
      limits = c(-0.17, 0.17), breaks = seq(-0.2, 0.2, by = 0.05)
    ) +
    labs(x = "Age Thresholds", y = "Estimates (95%CI)", color = "Gender") +
    simplegg()
```

<!-- ## Message C Effect among Younger Group -->

```{r plotC-change-age-threshold-secondary, fig.width=15, fig.height=10, eval=FALSE}
age_criterion_secondary %>%
  dplyr::filter(term == "treatC") %>%
  ggplot(aes(x = age, y = estimate, color = male, group = male)) +
    geom_hline(aes(yintercept = 0), linetype = 2) +
    geom_point(size = 3) +
    geom_line(size = 1) +
    geom_line(aes(y = conf.low), linetype = 2) +
    geom_line(aes(y = conf.high), linetype = 2) +
    facet_wrap(~ within, ncol = 2) +
    scale_x_continuous(breaks = 30:40) +
    scale_y_continuous(
      limits = c(-0.17, 0.17), breaks = seq(-0.2, 0.2, by = 0.05)
    ) +
    labs(x = "Age Thresholds", y = "Estimates (95%CI)", color = "Gender") +
    simplegg()
```

<!-- ## Message D Effect among Younger Group -->

```{r plotD-change-age-threshold-secondary, fig.width=15, fig.height=10, eval=FALSE}
age_criterion_secondary %>%
  dplyr::filter(term == "treatD") %>%
  ggplot(aes(x = age, y = estimate, color = male, group = male)) +
    geom_hline(aes(yintercept = 0), linetype = 2) +
    geom_point(size = 3) +
    geom_line(size = 1) +
    geom_line(aes(y = conf.low), linetype = 2) +
    geom_line(aes(y = conf.high), linetype = 2) +
    facet_wrap(~ within, ncol = 2) +
    scale_x_continuous(breaks = 30:40) +
    scale_y_continuous(
      limits = c(-0.17, 0.17), breaks = seq(-0.2, 0.2, by = 0.05)
    ) +
    labs(x = "Age Thresholds", y = "Estimates (95%CI)", color = "Gender") +
    simplegg()
```

<!-- ## Geographical Heterogenous Effect

- 都道府県ごとに10平方キロメートル当たりの病院数を計算し、
4分位グループを作り、それに基づいてサンプルを分割する
- それぞれのサンプルで効果を推定する -->

```{r geographical-hetero-secondaries, include = FALSE, eval=FALSE}
est <- testdt %>%
  dplyr::left_join(hospital, by = "prefecture") %>%
  group_by(within, qt_hospital) %>%
  do(est = lm_robust(
    update(model, . ~ . - prefecture),
    cluster = RCTweek,
    se_type = "stata",
    data = .
  )) %>%
  rowwise(within, qt_hospital) %>%
  summarize(
    estimate.B = subset(tidy(est), term == "treatB")$estimate,
    lwr_conf.B = subset(tidy(est), term == "treatB")$conf.low,
    upr_conf.B = subset(tidy(est), term == "treatB")$conf.high,
    estimate.C = subset(tidy(est), term == "treatC")$estimate,
    lwr_conf.C = subset(tidy(est), term == "treatC")$conf.low,
    upr_conf.C = subset(tidy(est), term == "treatC")$conf.high,
    estimate.D = subset(tidy(est), term == "treatD")$estimate,
    lwr_conf.D = subset(tidy(est), term == "treatD")$conf.low,
    upr_conf.D = subset(tidy(est), term == "treatD")$conf.high,
    nobs = nobs(est)
  ) %>%
  pivot_longer(
    estimate.B:upr_conf.D,
    names_to = c(".value", "treat"),
    names_pattern = "(.*).(.)"
  ) %>%
  ungroup() %>%
  mutate(N = paste0("N=", nobs))
```

<!-- ## Message B -->

```{r plotB-geographical-hetero-secondaries, fig.width = 10, fig.height=7, eval=FALSE}
est %>%
  dplyr::filter(treat == "B") %>%
  ggplot(aes(x = qt_hospital, y = estimate)) +
    geom_hline(aes(yintercept = 0), linetype = 2) +
    geom_pointrange(aes(ymin = lwr_conf, ymax = upr_conf)) +
    geom_text(aes(y = -0.2, label = N)) +
    facet_wrap(~ within, ncol = 2) +
    scale_y_continuous(
      limits = c(-0.2, 0.1),
      breaks = seq(-0.2, 0.2, by = 0.05)
    ) +
    labs(x = "Subset", y = "Estimate (95%CI)") +
    simplegg()
```

<!-- ## Message C -->

```{r plotC-geographical-hetero-secondaries, fig.width = 10, fig.height=7, eval=FALSE}
est %>%
  dplyr::filter(treat == "C") %>%
  ggplot(aes(x = qt_hospital, y = estimate)) +
    geom_hline(aes(yintercept = 0), linetype = 2) +
    geom_pointrange(aes(ymin = lwr_conf, ymax = upr_conf)) +
    geom_text(aes(y = -0.2, label = N)) +
    facet_wrap(~ within, ncol = 2) +
    scale_y_continuous(
      limits = c(-0.2, 0.1),
      breaks = seq(-0.2, 0.2, by = 0.05)
    ) +
    labs(x = "Subset", y = "Estimate (95%CI)") +
    simplegg()
```

<!-- ## Message D -->

```{r plotD-geographical-hetero-secondaries, fig.width = 10, fig.height=7, eval=FALSE}
est %>%
  dplyr::filter(treat == "D") %>%
  ggplot(aes(x = qt_hospital, y = estimate)) +
    geom_hline(aes(yintercept = 0), linetype = 2) +
    geom_pointrange(aes(ymin = lwr_conf, ymax = upr_conf)) +
    geom_text(aes(y = -0.2, label = N)) +
    facet_wrap(~ within, ncol = 2) +
    scale_y_continuous(
      limits = c(-0.2, 0.1),
      breaks = seq(-0.2, 0.2, by = 0.05)
    ) +
    labs(x = "Subset", y = "Estimate (95%CI)") +
    simplegg()
```