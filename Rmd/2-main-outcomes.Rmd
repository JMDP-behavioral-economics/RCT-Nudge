
# Effect on Primary Outcomes

```{r load-packages, include = FALSE}
library(here)
source(here("R", "_library.r"))
source(here("R", "_outcome_labels.r"))
```

```{r load-data, include = FALSE}
root <- "D:/JMDPフィールド実験"

rawdt <- read_csv(
  here(root, "shaped.csv"),
  locale = locale(encoding = "cp932")
)

use <- rawdt %>%
  mutate(treat = factor(treat, levels = LETTERS[1:4]))

outcomes <- use %>%
  select(
    id,
    reply,
    intention,
    test,
    candidate,
    consent,
    donate,
    treat,
    RCTweek,
    month,
    week,
    prefecture,
    male,
    age,
    coordinate
  ) %>%
  pivot_longer(reply:donate, names_to = "outcome")

exclude <- use %>%
  select(id, starts_with("exg_stop")) %>%
  pivot_longer(
    -id, names_to = "outcome", values_to = "exclude",
    names_prefix = "exg_stop_"
  )

testdt <- outcomes %>%
  dplyr::left_join(exclude, by = c("id", "outcome")) %>%
  dplyr::filter(exclude == 0 & prefecture != "海外") %>%
  mutate(
    prefecture = factor(prefecture, c("東京都", unique(rawdt$prefecture)[-11])),
    age_less30 = if_else(age <= 30, 1, 0),
    age_demean = age - mean(rawdt$age),
    coordinate1 = if_else(coordinate == 1, 1, 0)
  )
```

## Primary Outcomes

アウトカム変数は提供に至るまでのプロセスであり、具体的に以下の6つの工程がある。

- Reply: 適合通知に返信したならば1を取る二値変数
- Intention: 提供を希望するという意向を示して返信したならば1を取る二値変数
- CT: 確認検査を実施したならば1を取る二値変数
- Candidate: 第一候補者に選定されたならば1を取る二値変数
- Consent: 最終同意をしたならば1を取る二値変数
- Donation: 採取をしたならば1を取る二値変数

平均値の差の検定（t検定）を行う。

```{r ttest, include = FALSE}
stat <- testdt %>%
  group_by(outcome, treat) %>%
  summarize(mean = mean(value), se = se(value), n = n()) %>%
  ungroup() %>%
  mutate(
    lwr.mean = mean - se,
    upr.mean = mean + se,
    outcome = factor(outcome, out_lev, out_lab)
  )

ttest_info <- expand.grid(
  outcome = out_lev,
  group1 = LETTERS[1:4],
  group2 = LETTERS[1:4],
  stringsAsFactors = FALSE) %>%
  dplyr::filter(group1 < group2) %>%
  arrange(outcome) %>%
  mutate(id = seq(n()))

ttest <- ttest_info %>%
  group_by(id) %>%
  do(test = t.test(
    subset(
      testdt, treat == .$group1 & outcome == .$outcome
    )$value,
    subset(
      testdt, treat == .$group2 & outcome == .$outcome
    )$value
  )) %>%
  summarize(
    id = id,
    p = test$p.value,
    est1 = test$estimate[1],
    est2 = test$estimate[2]
  )

show_ttest_info <- ttest_info %>%
  dplyr::left_join(ttest, by = "id") %>%
  dplyr::filter(p <= 0.1) %>%
  mutate_at(vars(group1, group2), list(~factor(., levels = LETTERS[1:4]))) %>%
  mutate(outcome = factor(outcome, out_lev, out_lab)) %>%
  group_by(id) %>%
  do(data.frame(
    outcome = .$outcome,
    group1 = .$group1,
    group2 = .$group2,
    p = .$p,
    y_g1 = subset(stat, outcome == .$outcome & treat == .$group1)$upr.mean,
    y_g2 = subset(stat, outcome == .$outcome & treat == .$group2)$upr.mean
  )) %>%
  ungroup() %>%
  mutate(
    y = if_else(y_g1 > y_g2, y_g1, y_g2) + 0.02,
    y = if_else(id == 21, y + 0.02, y),
    y = if_else(id == 34, y + 0.06, y),
    sign = case_when(
      p < 0.01 ~ "***",
      p < 0.05 ~ "**",
      p < 0.1 ~ "*",
      TRUE ~ "",
    )
  )
```


## Difference-in-mean Test: Reply to CT


```{r ttest-first-3step, echo = FALSE}
stat %>%
  dplyr::filter(outcome %in% out_lab[1:3]) %>%
  ggplot(aes(x = treat, y = mean)) +
    geom_bar(
      color = "black",
      fill = "grey90",
      stat = "identity"
    ) +
    geom_errorbar(
      aes(ymin = lwr.mean, ymax = upr.mean),
      width = 0.5, position = position_dodge(0.9)
    ) +
    geom_text(
      aes(y = 0, label = sprintf("%1.3f\nN=%1d", mean, n)),
      vjust = -1, size = 4
    ) +
    geom_signif(
      data = show_ttest_info,
      aes(xmin = group1, xmax = group2, annotations = sign, y_position = y),
      textsize = 5, tip_length = 0.01,
      manual = TRUE
    ) +
    facet_wrap(~ outcome) +
    scale_y_continuous(breaks = seq(0, 1, 0.1)) +
    labs(
      x = "Experimental Arms",
      y = "Sample average",
      caption = "*** p < 0.01, ** p < 0.05, * p < 0.1"
    ) +
    simplegg(caption_size = 13)
```

## Difference-in-mean Test: Candidate to Donation

```{r ttest-last-3step, echo = FALSE}
stat %>%
  dplyr::filter(outcome %in% out_lab[4:6]) %>%
  ggplot(aes(x = treat, y = mean)) +
    geom_bar(
      color = "black",
      fill = "grey90",
      stat = "identity"
    ) +
    geom_errorbar(
      aes(ymin = lwr.mean, ymax = upr.mean),
      width = 0.5, position = position_dodge(0.9)
    ) +
    geom_text(
      aes(y = 0, label = sprintf("%1.3f\nN=%1d", mean, n)),
      vjust = -1, size = 4
    ) +
    facet_wrap(~ outcome) +
    scale_y_continuous(
      limits = c(0, 0.16),
      breaks = seq(0, 0.16, 0.02)
    ) +
    labs(
      x = "Experimental Arms",
      y = "Sample average",
      fill = "Experimental Arms"
    ) +
    simplegg()
```

## Lineary Probability Model

$m$月の第$w$週に適合通知を受け取った個人$i$について、

$$
  Y_{imw} =
  \beta_1 \cdot \text{B}_{mw} + \beta_2 \cdot \text{C}_{mw}
  + \beta_3 \cdot \text{D}_{mw}
  + X'_i \gamma + \lambda_m + \theta_w + u_{imw}
$$

- $X_i$は性別・年齢・居住する都道府県・コーディネーション回数
- $\lambda_m$と$\theta_w$は週・月の固定効果
- $\beta_1 = \beta_2$、$\beta_1 = \beta_3$、$\beta_2 = \beta_3$の帰無仮説に対する
F検定を実施

```{r reg-primaries, include = FALSE}
model <- value ~ treat + age_demean + male + coordinate1 + prefecture +
  factor(month) + factor(week)

reg_primaries <- testdt %>%
  mutate(outcome = factor(outcome, out_lev, out_lab)) %>%
  group_by(outcome) %>%
  do(
    est = lm_robust(
      model,
      cluster = RCTweek,
      se_type = "stata",
      data = .
    ),
    ftestBC = lh_robust(
      model,
      cluster = RCTweek,
      se_type = "stata",
      linear_hypothesis = "treatB - treatC = 0",
      data = .
    )$lh,
    ftestBD = lh_robust(
      model,
      cluster = RCTweek,
      se_type = "stata",
      linear_hypothesis = "treatB - treatD = 0",
      data = .
    )$lh,
    ftestCD = lh_robust(
      model,
      cluster = RCTweek,
      se_type = "stata",
      linear_hypothesis = "treatC - treatD = 0",
      data = .
    )$lh
  )
```

## Estimation Results

```{r tab-reg-primaries}
reg_primaries %>%
  pull(est, name = outcome) %>%
  modelsummary(
    stars = c("*" = 0.1, "**" = 0.05, "***" = 0.01),
    coef_map = c(
      "treatB" = "B",
      "treatC" = "C",
      "treatD" = "D"
    ),
    gof_omit = "R2|AIC|BIC|Log|Std|FE|se_type",
    add_rows = bind_rows(reg_primaries$ftestBC)[, 4] %>%
      rbind(bind_rows(reg_primaries$ftestBD)[, 4]) %>%
      rbind(bind_rows(reg_primaries$ftestCD)[, 4]) %>%
      data.frame(term = c("B = C", "B = D", "C = D"), .)
  ) %>%
  kableExtra::kable_styling(font_size = 9) %>%
  kableExtra::column_spec(2:7, width = "5em") %>%
  kableExtra::group_rows(
    "F-tests, p-value", 8, 10, bold = FALSE, italic = TRUE
  )
```

## Heterogenous Effect by Gender and Age

- 性別と年齢（30歳以下どうか）でサンプルを分割して、
各サブサンプル内でメッセージの効果を推定した

```{r hetero-gender-age-primaries, include = FALSE}
est <- testdt %>%
  mutate(outcome = factor(outcome, out_lev, out_lab)) %>%
  group_by(outcome, male, age_less30) %>%
  do(est = lm_robust(
    update(model, . ~ . - male - age_demean),
    cluster = RCTweek,
    se_type = "stata",
    data = .
  )) %>%
  rowwise(outcome, male, age_less30) %>%
  summarize(
    estimate.B = subset(tidy(est), term == "treatB")$estimate,
    lwr_conf.B = subset(tidy(est), term == "treatB")$conf.low,
    upr_conf.B = subset(tidy(est), term == "treatB")$conf.high,
    estimate.C = subset(tidy(est), term == "treatC")$estimate,
    lwr_conf.C = subset(tidy(est), term == "treatC")$conf.low,
    upr_conf.C = subset(tidy(est), term == "treatC")$conf.high,
    estimate.D = subset(tidy(est), term == "treatD")$estimate,
    lwr_conf.D = subset(tidy(est), term == "treatD")$conf.low,
    upr_conf.D = subset(tidy(est), term == "treatD")$conf.high,
    nobs = nobs(est)
  ) %>%
  pivot_longer(
    estimate.B:upr_conf.D,
    names_to = c(".value", "treat"),
    names_pattern = "(.*).(.)"
  ) %>%
  ungroup() %>%
  mutate(
    pos = paste0(male, age_less30),
    N = paste0("N=", nobs)
  )
```

## Message B

```{r plotB-hetero-gender-age-primaries, fig.width = 10, fig.height=7}
est %>%
  dplyr::filter(treat == "B") %>%
  ggplot(aes(x = pos, y = estimate)) +
    geom_hline(aes(yintercept = 0), linetype = 2) +
    geom_pointrange(aes(ymin = lwr_conf, ymax = upr_conf)) +
    geom_text(aes(y = -0.15, label = N)) +
    facet_wrap(~ outcome, ncol = 3) +
    scale_y_continuous(breaks = seq(-0.2, 0.2, by = 0.05)) +
    scale_x_discrete(
      breaks = c("00", "01", "10", "11"),
      labels = c(
        "Female\u00d7\n30<Age",
        "Female\u00d7\nAge\u226430",
        "Male\u00d7\n30<Age",
        "Male\u00d7\nAge\u226430"
      )
    ) +
    labs(x = "Subset", y = "Estimate (95%CI)") +
    simplegg()
```

## Message C

```{r plotC-hetero-gender-age-primaries, fig.width = 10, fig.height=7}
est %>%
  dplyr::filter(treat == "C") %>%
  ggplot(aes(x = pos, y = estimate)) +
    geom_hline(aes(yintercept = 0), linetype = 2) +
    geom_pointrange(aes(ymin = lwr_conf, ymax = upr_conf)) +
    geom_text(aes(y = -0.15, label = N)) +
    facet_wrap(~ outcome, ncol = 3) +
    scale_y_continuous(breaks = seq(-0.2, 0.2, by = 0.05)) +
    scale_x_discrete(
      breaks = c("00", "01", "10", "11"),
      labels = c(
        "Female\u00d7\n30<Age",
        "Female\u00d7\nAge\u226430",
        "Male\u00d7\n30<Age",
        "Male\u00d7\nAge\u226430"
      )
    ) +
    labs(x = "Subset", y = "Estimate (95%CI)") +
    simplegg()
```

## Message D

```{r plotD-hetero-gender-age-primaries, fig.width = 10, fig.height=7}
est %>%
  dplyr::filter(treat == "D") %>%
  ggplot(aes(x = pos, y = estimate)) +
    geom_hline(aes(yintercept = 0), linetype = 2) +
    geom_pointrange(aes(ymin = lwr_conf, ymax = upr_conf)) +
    geom_text(aes(y = -0.15, label = N)) +
    facet_wrap(~ outcome, ncol = 3) +
    scale_y_continuous(breaks = seq(-0.2, 0.2, by = 0.05)) +
    scale_x_discrete(
      breaks = c("00", "01", "10", "11"),
      labels = c(
        "Female\u00d7\n30<Age",
        "Female\u00d7\nAge\u226430",
        "Male\u00d7\n30<Age",
        "Male\u00d7\nAge\u226430"
      )
    ) +
    labs(x = "Subset", y = "Estimate (95%CI)") +
    simplegg()
```

## Geographical Heterogenous Effect

```{r load-hospital-list}
hospital <- read_csv(
  here(root, "hospital-list.csv"),
  locale = locale(encoding = "cp932")
)

aggregate_hospital <- hospital %>%
  group_by(prefecture) %>%
  summarize(hospital = n()) %>%
  ungroup() %>%
  mutate(qt_hospital = ntile(hospital, 4))

testdt_hospital <- testdt %>%
  dplyr::left_join(aggregate_hospital, by = "prefecture")
```

```{r , include = FALSE}
testdt_hospital %>%
  with(table(qt_hospital, treat, outcome))


est <- testdt_hospital %>%
  mutate(outcome = factor(outcome, out_lev, out_lab)) %>%
  group_by(outcome, qt_hospital) %>%
  do(est = lm_robust(
    update(model, . ~ . - prefecture),
    cluster = RCTweek,
    se_type = "stata",
    data = .
  )) %>%
  rowwise(outcome, qt_hospital) %>%
  summarize(
    estimate.B = subset(tidy(est), term == "treatB")$estimate,
    lwr_conf.B = subset(tidy(est), term == "treatB")$conf.low,
    upr_conf.B = subset(tidy(est), term == "treatB")$conf.high,
    estimate.C = subset(tidy(est), term == "treatC")$estimate,
    lwr_conf.C = subset(tidy(est), term == "treatC")$conf.low,
    upr_conf.C = subset(tidy(est), term == "treatC")$conf.high,
    estimate.D = subset(tidy(est), term == "treatD")$estimate,
    lwr_conf.D = subset(tidy(est), term == "treatD")$conf.low,
    upr_conf.D = subset(tidy(est), term == "treatD")$conf.high,
    nobs = nobs(est)
  ) %>%
  pivot_longer(
    estimate.B:upr_conf.D,
    names_to = c(".value", "treat"),
    names_pattern = "(.*).(.)"
  ) %>%
  ungroup() %>%
  mutate(N = paste0("N=", nobs))
```

```{r , fig.width = 10, fig.height=7}
est %>%
  dplyr::filter(treat == "B") %>%
  ggplot(aes(x = qt_hospital, y = estimate)) +
    geom_hline(aes(yintercept = 0), linetype = 2) +
    geom_pointrange(aes(ymin = lwr_conf, ymax = upr_conf)) +
    geom_text(aes(y = -0.15, label = N)) +
    facet_wrap(~ outcome, ncol = 3) +
    scale_y_continuous(breaks = seq(-0.2, 0.2, by = 0.05)) +
    # scale_x_discrete(
    #   breaks = c("00", "01", "10", "11"),
    #   labels = c(
    #     "Female\u00d7\n30<Age",
    #     "Female\u00d7\nAge\u226430",
    #     "Male\u00d7\n30<Age",
    #     "Male\u00d7\nAge\u226430"
    #   )
    # ) +
    labs(x = "Subset", y = "Estimate (95%CI)") +
    simplegg()
```

```{r , fig.width = 10, fig.height=7}
est %>%
  dplyr::filter(treat == "C") %>%
  ggplot(aes(x = qt_hospital, y = estimate)) +
    geom_hline(aes(yintercept = 0), linetype = 2) +
    geom_pointrange(aes(ymin = lwr_conf, ymax = upr_conf)) +
    geom_text(aes(y = -0.15, label = N)) +
    facet_wrap(~ outcome, ncol = 3) +
    scale_y_continuous(breaks = seq(-0.2, 0.2, by = 0.05)) +
    # scale_x_discrete(
    #   breaks = c("00", "01", "10", "11"),
    #   labels = c(
    #     "Female\u00d7\n30<Age",
    #     "Female\u00d7\nAge\u226430",
    #     "Male\u00d7\n30<Age",
    #     "Male\u00d7\nAge\u226430"
    #   )
    # ) +
    labs(x = "Subset", y = "Estimate (95%CI)") +
    simplegg()
```

```{r , fig.width = 10, fig.height=7}
est %>%
  dplyr::filter(treat == "D") %>%
  ggplot(aes(x = qt_hospital, y = estimate)) +
    geom_hline(aes(yintercept = 0), linetype = 2) +
    geom_pointrange(aes(ymin = lwr_conf, ymax = upr_conf)) +
    geom_text(aes(y = -0.15, label = N)) +
    facet_wrap(~ outcome, ncol = 3) +
    scale_y_continuous(breaks = seq(-0.2, 0.2, by = 0.05)) +
    # scale_x_discrete(
    #   breaks = c("00", "01", "10", "11"),
    #   labels = c(
    #     "Female\u00d7\n30<Age",
    #     "Female\u00d7\nAge\u226430",
    #     "Male\u00d7\n30<Age",
    #     "Male\u00d7\nAge\u226430"
    #   )
    # ) +
    labs(x = "Subset", y = "Estimate (95%CI)") +
    simplegg()
```