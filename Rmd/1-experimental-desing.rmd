---
title: |
  Only You: A Field Experiment of Text Message
  to Prevent Free-riding in Japan Marrow Donor Program
subtitle: Field Experiment
---

```{r include=FALSE}
library(here)
source(here("R", "_library.r"))
source(here("R", "_outcome_labels.r"))
```

## Background

骨髄バンクに登録したドナー候補者が幹細胞を提供するために、以下の工程がある

1. 適合通知の返信
    - 骨髄バンクに登録した患者のHLAが一致すると、骨髄バンクはその候補者に幹細胞提供を依頼する適合通知を受け取る
    - 適合通知を受け取ったドナー候補者は提供の意向を示して返信する
1. 確認検査
    - 1カ月以内に実施される
    - コーディネーターが提供方法を詳細に説明をし、ドナーの意思や家族の同意について調査する
    - 調整医師が問診、診察、感染症の有無や血液型を調べる一般血液検査を実施する
    - 骨髄バンクが設定している基準を満たしているかどうかを検査する
1. 第一候補者選定
    - 患者は同時に最大10人のドナーとのコーディネーションを進められる
    - 患者の主治医はその中から最もドナーに適した候補者を選ぶ
    - 重要なことは、ドナー候補者は患者が何人のドナーとのコーディネーションを進めているかを知ることができない。また、コーディネーターや調整医師も知らないので、ドナー候補者はその情報を得られない。
1. 最終同意
    - 第一候補者に選定されたドナーは、コーディネーターと調整医師からの説明を再度受けて、最終的な意思決定をする
    - ドナーは自身の意思だけでなく、家族の代表者の同意も必要である
    - 最終同意後、ドナーは自身の意向を変えられない
1. 採取
    - 最終同意後、術前検査と採取準備（貧血を防ぐための自己血採血）を実施する
    - 採取のために1週間程度の入院が必要である
    - 確認検査から採取まで3～4カ月程度かかる

## Experimental Design

- ドナー候補者確定後、骨髄バンクは対象者に幹細胞提供を依頼する「適合通知」と、それを郵送した旨を伝えるSNSメッセージを送付する。
- 適合通知の全文
  - この度、あなたと骨髄バンクの登録患者さんのHLA型（白血球の型）が一致し、ドナー候補者のおひとりに選ばれました。今後、ご提供に向け詳しい検査や面談を希望されるかをお伺いしたく連絡させていただきました。同封の資料をよくお読みいただき、コーディネートが可能かどうか検討の上、この案内が届いてから7日以内に返信用紙ほかをご返送ください。返送後、コーディネートを進めさせていただく場合は、担当者よりご相談のお電話を差し上げますのでよろしくお願い申し上げます。
- 我々の介入は行動科学の知見に基づくメッセージを適合通知に加える。
  - 確率メッセージ「1人の登録患者さんとHLA型が一致するドナー登録者は数百〜数万人に1人です。ドナー候補者が複数みつかる場合もありますが、多くはないこともご理解頂ければ幸いです。」
  - 患者情報メッセージ「骨髄バンクを介して移植ができる患者さんは約6割です。骨髄等を提供するドナーが早く見つかれば、その比率を高めることができます。」
- これらのメッセージの目的はコーディネーションを促進することである。ただし、我々はドナー候補者に過度なプレッシャーを与えないように適切な配慮をして、メッセージを作成した。
  - 嘆願調のようなメッセージを避けている
  - メッセージの作成に際して、骨髄バンクが公開している情報のみを使用している
  - 移植リスクに関する説明はこれまでと同様の方法で実施している
- 二つの介入メッセージの効果を推定するために、我々は3つの実験群を設ける。
  - 実験群A：介入メッセージなし
  - 実験群B：確率メッセージ
  - 実験群C：患者情報メッセージ
- さらに、情報過多による認知負荷の負の影響を検証するために、二つの介入メッセージを両方加えた適合通知を送付する実験群Dも設ける。
- 各実験群の介入を下表のパネルAにまとめた。

```{r overview-experiment, echo = FALSE, message=FALSE}
root <- "D:/JMDPフィールド実験"

rawdt <- read_csv(
  here(root, "shaped.csv"),
  locale = locale(encoding = "cp932")
)

use <- rawdt %>%
  dplyr::filter(ongoing == 0) %>%
  mutate(treat = factor(treat, levels = LETTERS[1:4]))

balance_test <- use %>%
  select(male, age, coordinate, toka, treat, RCTweek) %>%
  pivot_longer(male:toka, values_to = "value", names_to = "vars") %>%
  group_by(vars) %>%
  do(est = lm_robust(
    value ~ treat,
    clusters = RCTweek,
    se_type = "stata",
    data = .
  )) %>%
  summarize(
    vars = vars,
    f = summary(est)$fstatistic[1],
    numdf = summary(est)$fstatistic[2],
    dendf = summary(est)$fstatistic[3],
    "p-value" = pf(f, numdf, dendf, lower.tail = FALSE)
  )

size <- with(use, sprintf("%1d", table(treat))) %>%
  {
    tribble(
      ~terms, ~A, ~B, ~C, ~D, ~"p-value",
      "通常の適合通知", "X", "X", "X", "X", "",
      "確率メッセージ", "", "X", "", "X", "",
      "患者情報メッセージ", "", "", "X", "X", "",
      "サンプルサイズ", .[1], .[2], .[3], .[4], ""
    )
  }

attr(size, "position") <- seq(nrow(size))

note <- paste(
  "Note: p値はバランステストの結果である。",
  "バランステストは実験群を共変量に線形回帰したF検定を用いている。"
)

use %>%
  datasummary(
    (`年齢` = age) +
    (`コーディネーション回数` = coordinate) +
    (`男性` = male) +
    (`東京・大阪・神奈川・愛知` = toka) ~ mean * treat,
    data = .,
    title = "Overview of Field Experiment",
    add_rows = size,
    add_columns = balance_test[, 5],
    align = "lccccc"
  ) %>%
  kableExtra::kable_styling() %>%
  add_header_above(c(" " = 1, "実験群" = 4, " " = 1)) %>%
  group_rows("A. 介入", 1, 3) %>%
  group_rows("B. サンプルサイズ", 4, 4) %>%
  group_rows("C. 共変量", 5, 8)
```

- 我々は2021年9月から2022年2月にかけて骨髄バンクが適合通知を送付したドナー候補者11,154名をフィールド実験の対象とした。
- 実験群の割り当ては骨髄バンク事務局の業務の無理のない範囲で週単位でクラスターランダム化した。
  - 週・月の固定効果を取り除けるように、実験群が週・月でバランスするように割り当てた。
- 割り当てのスケジュールを下表にまとめた。

```{r assignment-schedule, echo=FALSE, message=FALSE}
schedule <- read_csv(here(root, "RCT-schedule.csv"))

treat_value <- function(x) {
  x <- as.character(x)
  switch(x, '1' = 'A', '2' = 'B', '3' = 'C', '4' = 'D')
}

schedule %>%
  mutate(
    my = paste0(month, "/", year - 2000),
    my = factor(
      my,
      levels = c("9/21", "10/21", "11/21", "12/21", "1/22", "2/22"),
      labels = c("Sep 21", "Oct 21", "Nov 21", "Dec 21", "Jan 22", "Feb 22")
    ),
    week = factor(week, levels = 1:4, labels = paste("Week", 1:4)),
    treat = case_when(
      treat == "A" ~ 1,
      treat == "B" ~ 2,
      treat == "C" ~ 3,
      treat == "D" ~ 4
    )
  ) %>%
  datasummary(
    (` ` = week) ~ treat * treat_value * my,
    data = .,
    title = "Assignment Schedule",
    align = "lcccccc"
  ) %>%
  kableExtra::kable_styling() %>%
  kableExtra::add_header_above(c(" " = 1, "Month, Year" = 6))
```

## Data and Estimation Strategy

- 我々は2022年6月末に骨髄バンクが管理するコーディネーションデータの提供を受けた。
  - 観測単位はフィールド実験の対象であるドナー候補者である
  - データは性別・年齢・過去のコーディネーション回数・居住地域（都道府県レベル）の個人属性とコーディネーション過程が記録されている
- コーディネーション過程は提供に至るまでの各工程に到達したかどうかを記録している
  - 適合通知の返信については、返信したかどうかに加えて、返信日数・提供の意向についても記録している
  - 我々はコーディネーション過程に関する変数をアウトカムとして用いる
- 分析対象は国内在住でコーディネーションが完全に終了している`r sum(table(use$treat))`名とする。
  - 海外に在住する人が1名いた
  - 現在もコーディネーションが進行している人が`r sum(rawdt$ongoing)`名いた
  - 各実験群のサンプルサイズを二つ上の表のパネルBにまとめた
- 個人属性に関するバランステストを二つ上の表のパネルCにまとめた
  - ドナー候補者の年齢は実験群間でアンバランスである（F検定、P値=$0.07$）。実験群C・Dのドナー候補者は実験群A・Bのドナー候補者よりも若い。
- ドナー候補者は実験群を選択できない、すなわち、実験群は外生的であるので、単純な二群比較は平均処置効果を識別できる。
  - 一部の共変量、および割り当ての週と月が実験群間で完全にバランスしていないので、単純な二群比較はバイアスを伴う可能性がある
  - そこで、我々は以下の線形確率モデルを推定する

$$
  Y_{imw} =
  \beta_1 \cdot \text{B}_{mw} + \beta_2 \cdot \text{C}_{mw}
  + \beta_3 \cdot \text{D}_{mw}
  + X'_i \gamma + \lambda_m + \theta_w + u_{imw}
$$

- $X_i$は個人属性ベクトル
- $\lambda_m$と$\theta_w$はそれぞれ週・月のダミー変数