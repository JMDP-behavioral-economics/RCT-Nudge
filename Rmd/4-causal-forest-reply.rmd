
---
title: Random Causal Forest
---

```{r load-packages, include = FALSE}
library(here)
source(here("R", "_library.r"))
source(here("R", "_outcome_labels.r"))
```

```{r load-data, include = FALSE}
root <- "D:/JMDPフィールド実験"

rawdt <- read_csv(
  here(root, "shaped.csv"),
  locale = locale(encoding = "cp932")
)

use <- rawdt %>%
  mutate(treat = factor(treat, levels = LETTERS[1:4])) %>%
  dplyr::filter(ongoing == 0 & prefecture != "海外") %>%
  dplyr::filter(exg_stop_reply == 0) %>%
  select(
    id,
    treat,
    RCTweek,
    month,
    week,
    toka,
    male,
    age,
    coordinate1,
    reply,
    positive = intention
  ) %>%
  mutate(negative = reply * (1 - positive))
```

```{r rcf-setup}
# outcome variabes
reply <- use$reply
positive <- use$positive
negative <- use$negative

# observed characteristics
X <- as.matrix(use[, c("male", "age", "coordinate1", "toka")])

# treatments
W <- use$treat
G <- use$RCTweek
```

# 返信率への効果の異質性

```{r rcf-reply}
est <- multi_arm_causal_forest(X, reply, W, num.trees = 4000)
tau <- predict(est, X, estimate.variance = TRUE)

plotdt <- data.frame(X) %>%
  cbind(tau$predictions) %>%
  rename(
    effect_B = `B - A.Y.1`,
    effect_C = `C - A.Y.1`,
    effect_D = `D - A.Y.1`
  ) %>%
  cbind(sqrt(tau$variance.estimates)) %>%
  rename(
    se_B = `1`,
    se_C = `2`,
    se_D = `3`
  ) %>%
  pivot_longer(
    effect_B:se_D,
    names_to = c(".value", "treat"),
    names_sep = "_"
  ) %>%
  mutate(treat = factor(treat, labels = paste("Message", LETTERS[2:4])))
```

```{r rcf-reply-dist, fig.width = 10}
average_tau <- average_treatment_effect(est) %>%
  data.frame() %>%
  mutate(treat = str_extract(contrast, "[B-D]")) %>%
  mutate(treat = factor(treat, labels = paste("Message", treat)))

negative_effect <- plotdt %>%
  mutate(negative = if_else(effect < 0, 1, 0)) %>%
  group_by(treat) %>%
  summarize(negative = mean(negative))

cate_summary <- average_tau %>%
  left_join(negative_effect, by = "treat") %>%
  mutate(summary = sprintf(
    "ATE: %1.3f (s.e. = %1.3f)\n%1.1f%% negative effect",
    estimate, std.err, negative * 100
  ))

plotdt %>%
  ggplot(aes(x = effect, y = ..count.. / sum(..count..))) +
  geom_histogram(aes(fill = effect < 0), breaks = seq(-.2, .25, by = .01)) +
  geom_vline(aes(xintercept = estimate), linetype = 2, data = cate_summary) +
  geom_text(
    aes(x = 0.2, y = 0.05, label = summary),
    size = 4, data = cate_summary
  ) +
  scale_y_continuous(expand = c(0, 0), limits = c(0, 0.06)) +
  scale_x_continuous(limits = c(-0.2, 0.4)) +
  scale_fill_manual(values = c("grey80", "blue")) +
  facet_wrap(~ treat) +
  labs(
    x = "Treatment effect (percentage points)",
    y = "Fraction",
    title = "Effect on Reply"
  ) +
  simplegg() +
  theme(legend.position = "none")
```

```{r rcf-reply-age, fig.width = 10, fig.height=10}
plotdt %>%
  mutate(male = factor(
    male, labels = c("Subset: Females", "Subset: Males")
  )) %>%
  ggplot(aes(x = age, y = effect)) +
  geom_point(size = 2, color = "grey50") +
  stat_smooth(se = FALSE, color = "red") +
  geom_hline(aes(yintercept = 0), linetype = 2) +
  facet_wrap(treat ~ male, ncol = 2) +
  labs(
    x = "Age",
    y = "Treatment effect (percentage points)",
    title = "Effect on Reply"
  ) +
  simplegg()
```

# ポジティブな返信への効果の異質性

```{r rcf-positive}
est <- multi_arm_causal_forest(X, positive, W, num.trees = 4000)
tau <- predict(est, X, estimate.variance = TRUE)

plotdt <- data.frame(X) %>%
  cbind(tau$predictions) %>%
  rename(
    effect_B = `B - A.Y.1`,
    effect_C = `C - A.Y.1`,
    effect_D = `D - A.Y.1`
  ) %>%
  cbind(sqrt(tau$variance.estimates)) %>%
  rename(
    se_B = `1`,
    se_C = `2`,
    se_D = `3`
  ) %>%
  pivot_longer(
    effect_B:se_D,
    names_to = c(".value", "treat"),
    names_sep = "_"
  ) %>%
  mutate(treat = factor(treat, labels = paste("Message", LETTERS[2:4])))
```

```{r rcf-positive-dist, fig.width = 10}
average_tau <- average_treatment_effect(est) %>%
  data.frame() %>%
  mutate(treat = str_extract(contrast, "[B-D]")) %>%
  mutate(treat = factor(treat, labels = paste("Message", treat)))

negative_effect <- plotdt %>%
  mutate(negative = if_else(effect < 0, 1, 0)) %>%
  group_by(treat) %>%
  summarize(negative = mean(negative))

cate_summary <- average_tau %>%
  left_join(negative_effect, by = "treat") %>%
  mutate(summary = sprintf(
    "ATE: %1.3f (s.e. = %1.3f)\n%1.1f%% negative effect",
    estimate, std.err, negative * 100
  ))

plotdt %>%
  ggplot(aes(x = effect, y = ..count.. / sum(..count..))) +
  geom_histogram(aes(fill = effect < 0), breaks = seq(-.2, .25, by = .01)) +
  geom_vline(aes(xintercept = estimate), linetype = 2, data = cate_summary) +
  geom_text(
    aes(x = 0.2, y = 0.05, label = summary),
    size = 4, data = cate_summary
  ) +
  scale_x_continuous(limits = c(-0.3, 0.4)) +
  scale_y_continuous(expand = c(0, 0), limits = c(0, 0.06)) +
  scale_fill_manual(values = c("grey80", "blue")) +
  facet_wrap(~ treat) +
  labs(
    x = "Treatment effect (percentage points)",
    y = "Fraction",
    title = "Effect on Reply with Positive Intention"
  ) +
  simplegg() +
  theme(legend.position = "none")
```

```{r rcf-positive-age, fig.width = 10, fig.height=10}
plotdt %>%
  mutate(male = factor(
    male, labels = c("Subset: Females", "Subset: Males")
  )) %>%
  ggplot(aes(x = age, y = effect)) +
  geom_point(size = 2, color = "grey50") +
  stat_smooth(se = FALSE, color = "red") +
  geom_hline(aes(yintercept = 0), linetype = 2) +
  facet_wrap(treat ~ male, ncol = 2) +
  labs(
    x = "Age",
    y = "Treatment effect (percentage points)",
    title = "Effect on Reply with Positive Intention"
  ) +
  simplegg()
```

# ネガティブな返信への効果の異質性

```{r rcf-negative}
est <- multi_arm_causal_forest(X, negative, W, num.trees = 4000)
tau <- predict(est, X, estimate.variance = TRUE)

plotdt <- data.frame(X) %>%
  cbind(tau$predictions) %>%
  rename(
    effect_B = `B - A.Y.1`,
    effect_C = `C - A.Y.1`,
    effect_D = `D - A.Y.1`
  ) %>%
  cbind(sqrt(tau$variance.estimates)) %>%
  rename(
    se_B = `1`,
    se_C = `2`,
    se_D = `3`
  ) %>%
  pivot_longer(
    effect_B:se_D,
    names_to = c(".value", "treat"),
    names_sep = "_"
  ) %>%
  mutate(treat = factor(treat, labels = paste("Message", LETTERS[2:4])))
```

```{r rcf-negative-dist, fig.width = 10}
average_tau <- average_treatment_effect(est) %>%
  data.frame() %>%
  mutate(treat = str_extract(contrast, "[B-D]")) %>%
  mutate(treat = factor(treat, labels = paste("Message", treat)))

negative_effect <- plotdt %>%
  mutate(negative = if_else(effect < 0, 1, 0)) %>%
  group_by(treat) %>%
  summarize(negative = mean(negative))

cate_summary <- average_tau %>%
  left_join(negative_effect, by = "treat") %>%
  mutate(summary = sprintf(
    "ATE: %1.3f (s.e. = %1.3f)\n%1.1f%% negative effect",
    estimate, std.err, negative * 100
  ))

plotdt %>%
  ggplot(aes(x = effect, y = ..count.. / sum(..count..))) +
  geom_histogram(aes(fill = effect < 0), breaks = seq(-.2, .25, by = .01)) +
  geom_vline(aes(xintercept = estimate), linetype = 2, data = cate_summary) +
  geom_text(
    aes(x = 0.2, y = 0.05, label = summary),
    size = 4, data = cate_summary
  ) +
  scale_x_continuous(limits = c(-0.2, 0.4)) +
  scale_y_continuous(expand = c(0, 0), limits = c(0, 0.06)) +
  scale_fill_manual(values = c("grey80", "blue")) +
  facet_wrap(~ treat) +
  labs(
    x = "Treatment effect (percentage points)",
    y = "Fraction",
    title = "Effect on Reply with Negative Intention"
  ) +
  simplegg() +
  theme(legend.position = "none")
```


```{r rcf-negative-age, fig.width = 10, fig.height=10}
plotdt %>%
  mutate(male = factor(
    male, labels = c("Subset: Females", "Subset: Males")
  )) %>%
  ggplot(aes(x = age, y = effect)) +
  geom_point(size = 2, color = "grey50") +
  stat_smooth(se = FALSE, color = "red") +
  geom_hline(aes(yintercept = 0), linetype = 2) +
  facet_wrap(treat ~ male, ncol = 2) +
  labs(
    x = "Age",
    y = "Treatment effect (percentage points)",
    title = "Effect on Reply with Negative Intention"
  ) +
  simplegg()
```