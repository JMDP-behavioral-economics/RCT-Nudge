---
title: |
  Only You:
  A Field Experiment of Text Message to Prevent Free-riding in Japan Marrow Donor Program
author:
  - name: Hiroki Kato
    affiliations:
      - 'Graduate School of Economics, Osaka University, Japan'
  - name: Fumio Ohtake
    affiliations:
      - 'Graduate School of Economics, Osaka University, Japan'
      - 'Center for Infectious Disease Education and Research (CiDER), Osaka University, Japan'
  - name: Saiko Kurosawa
    affiliations:
      - 'Department of Oncology, Ina Central Hospital, Japan'
  - name: Kazuhiro Yoshiuchi
    affiliations:
      - 'Graduate School of Medicine, Tokyo University, Japan'
  - name: Takahiro Fukuda
    affiliations:
      - 'Department of Hematopoietic Stem Cell Transplantation, National Cancer Center Hospital, Japan'
date: last-modified
date-format: '[Last Updated on] MMMM D, YYYY'
pdf-engine: lualatex
format:
  pdf:
    documentclass: bxjsarticle
    classoption:
      - pandoc
      - ja=standard
      - jafont=haranoaji
    papersize: a4
    fontsize: 11pt
    include-in-header:
      text: |
        \usepackage{authblk}
        \usepackage{siunitx}
        \usepackage{threeparttable, threeparttablex, multirow}
        \newcolumntype{d}{S[input-symbols = ()]}
        \usepackage{lscape}
    geometry:
      - top=30mm
      - left=30mm
      - right=30mm
      - bottom=30mm
    toc: false
    number-sections: true
    fig-format: pdf
    fig-pos: t
    template-partials:
      - tex/title.tex
  html:
    number-sections: true
    code-fold: true
    title-block-banner: true
  docx:
    number-sections: true
    toc: false
    fig-width: 15
    fig-height: 10
execute:
  echo: false
  warning: false
  error: false
  cache: false
  enabled: true
---


```{r}
#| label: library
#| include: false
#| vscode: {languageId: r}

library(here)
library(tidyverse)
library(lubridate)
library(estimatr)
library(fixest)
library(grf)
library(modelsummary)
library(kableExtra)
library(flextable)
library(officer)
library(RCTtoolbox)
library(patchwork)
lapply(list.files(here("R/func"), "r", full.names = TRUE), source)

options(
  knitr.table.format = "markdown",
  kableExtra.auto_format = FALSE,
  modelsummary_stars_note = FALSE,
  modelsummary_factory_default = "flextable",
  modelsummary_factory_html = "kableExtra",
  modelsummary_factory_latex = "kableExtra",
  modelsummary_factory_word = "flextable"
)
```


```{r}
#| label: outcome-label
#| include: false
#| vscode: {languageId: r}

root <- "D:/JMDPフィールド実験"

outcome_label <- list(
  reply = "Reply",
  positive = "Positive intention",
  negative = "Negative intention",
  test = "CT",
  candidate = "Candidate",
  consent = "Consent",
  donate = "Donation"
)
```

# Field Experiment
## Background: Coordination Process of JMDP


フィールド実験の介入のタイミングとデータの理解を促すために、骨髄バンクに登録したドナー候補者が幹細胞を提供するに至るまでの工程を概観しておく。はじめに、あるドナー候補者のHLAが骨髄バンクに登録した患者のHLAと一致すると、骨髄バンクの事務局はその候補者に幹細胞提供を依頼する適合通知を送付する[^SNS]。ドナー候補者は適合通知に対して提供の意向と問診表を記入して、返信する。

[^SNS]: 適合通知を送付したことを伝えるSMSメッセージも送付している。

提供を希望したドナー候補者はおよそ1カ月以内に確認検査を受ける。確認検査では、コーディネーターが提供方法（骨髄採取・末梢血幹細胞採取）を詳細に説明し、ドナー候補者とその家族の意向について調査する。このとき、ドナー候補者は希望する採取方法を選べる。また、調整医師が問診・診察・感染症の有無や血液型を調べるための一般血液検査を実施する。この検査を通じて、ドナー候補者が、骨髄バンクが設定した基準を満たしているかどうかを調べる。

骨髄バンクに登録したドナーは同時に最大10人のドナー候補者とのコーディネーションを進められる。患者の主治医は確認検査まで至った複数のドナー候補者の中から最も最適な候補者（第一候補者）を選ぶ。重要な点であるが、ドナー候補者は自身とマッチした患者が何人のドナーとのコーディネーションを進めているかを知ることができない。また、コーディネーターや調整医師もこの点を知らないので、ドナー候補者が他者からその情報を得ることもできない。

第一候補者となったドナーはコーディネーターと調整医師からの説明を再度受けて、最終的な意思決定をする（最終同意）。このとき、ドナーの家族の代表者も採取に同意する必要がある。また、最終同意後、ドナーは自分の意向を変えられない。最終的な同意をした後、ドナーは約1週間の入院をして、術前検査と採取準備（貧血を防ぐための自己血採血）を受ける。この後、ドナーは幹細胞を採取する処置を受ける。確認検査から採取までの期間はおよそ3～4カ月程度である。

## Experimental Design

![Intervention Messages](image/intervention.png){#fig-intervention}

我々は、骨髄バンクがドナー候補者に幹細胞提供を依頼する適合通知の内容に介入を施した。上図に介入の内容を示す。介入前の適合通知はドナー候補者として選ばれたこと、7日以内に提供意思と問診表を記入して返信してほしいことを記載している。また、適合通知と併せて同封した資料の一つは先の小節で述べた採取までの流れを示したハンドブックである。

我々はコーディネーションの促進を目的として、適合通知に行動科学の知見に基づく二種類のメッセージを追加した（@fig-intervention）[^pressure]。確率メッセージは骨髄バンクに登録した患者とHLA型が一致するドナー登録者が少ないことを強調している。これは同時に進行している他のドナー候補者の数に関する信念の過大評価を防ぎ、幹細胞提供の「ただ乗り」行動を抑制できる可能性がある。

[^pressure]: メッセージの作成の際、我々はドナー候補者に過度なプレッシャーを与えないように適切な配慮をしている。第一に、嘆願調のようなメッセージを避けている。第二に、メッセージの作成に際して、骨髄バンクが公開している情報のみを使用している。第三に、これまでと同様に移植リスクに関する説明をしている。

患者メッセージは骨髄バンクを通して移植を受けられる患者が半数しかいないことを強調している。これは自分が協力しなくても患者は助かるだろうという認識を修正し、ドナー候補者の利他性を刺激していることを目的としている。さらに、提供に至るまでの期間を短くすることの重要性を強調することで、適合通知への早い返信を促している。

二種類の介入メッセージの効果を推定するために、我々は四つの実験群を設ける。実験群Aは介入メッセージのない適合通知を送る（コントロール群）。実験群BとCはそれぞれ確率メッセージと患者情報メッセージを送る。さらに、情報過多による認知負荷の負の影響を検証するために、二つの介入メッセージを両方加えた適合通知を送付する実験群Dも設ける。

```{r}
#| label: read-schedule-data
#| include: false
#| vscode: {languageId: r}

schedule <- read_csv(here(root, "RCT-schedule.csv")) %>%
  mutate(
    my = paste0(month, "/", year - 2000),
    my = factor(
      my,
      levels = c("9/21", "10/21", "11/21", "12/21", "1/22", "2/22"),
      labels = c("Sep 21", "Oct 21", "Nov 21", "Dec 21", "Jan 22", "Feb 22")
    ),
    week = factor(week, levels = 1:4, labels = paste("Week", 1:4))
  ) %>%
  dplyr::select(week, my, treat) %>%
  pivot_wider(values_from = treat, names_from = my)
```

```{r}
#| label: tbl-assignment
#| tbl-cap: Assignment Schedule
#| vscode: {languageId: r}

flextable(schedule) %>%
  align(j = -1, align = "center", part = "all") %>%
  padding(j=1:7, padding.top = 5, padding.bottom = 5, part="all") %>%
  fontsize(size = 9, part = "all")  %>%
  ft_theme()
```

我々は2021年9月から2022年2月にかけて骨髄バンクが適合通知を送付したドナー候補者11,154名をフィールド実験の対象とした。実験群の割り当ては骨髄バンク事務局の業務の無理のない範囲で週単位でクラスターランダム化した。このとき、週・月の固定効果を取り除けるように、実験群が週・月でバランスするように割り当てた。割り当てのスケジュールは @tbl-assignment にまとめている。

## Data and Empirical Strategy

```{r}
#| label: read-experiment-data
#| include: false
#| vscode: {languageId: r}

rawdt <- read_csv(here(root, "shaped.csv"), locale = locale(encoding = "cp932"))

use <- rawdt %>%
  dplyr::filter(ongoing == 0) %>%
  mutate(
    treat = factor(treat, levels = LETTERS[1:4]),
    plan_two_methods = if_else(plan_method == "BM/PB", 1, 0)
  )
```

```{r}
#| label: balance-test-ongoing
#| eval: false
#| vscode: {languageId: r}

lm_robust(
  ongoing ~ treat,
  data = rawdt,
  cluster = RCTweek,
  se_type = "stata"
) %>%
{
  f <- summary(.)$fstatistic[1]
  numdf <- summary(.)$fstatistic[2]
  dendf <- summary(.)$fstatistic[3]
  p <- pf(f, numdf, dendf, lower.tail = FALSE)

  sprintf("F-value = %1.3f; p-value = %1.3f", f, p)
}
```

我々は2022年6月末に骨髄バンクが管理するコーディネーションデータの提供を受けた。観測単位はフィールド実験の対象であるドナー候補者である。個人属性として性別・年齢・過去のコーディネーション回数・居住地域（都道府県レベル）を記録している。コーディネーションの過程について、提供に至るまでの各工程（適合通知への返信・確認検査・第一候補者選定・最終同意・採取）に到達したかどうかを記録しており、これらをアウトカム変数として用いる。特に、適合通知の返信については、返信したかどうかに加えて、返信日数・提供意向についても記録している。コーディネーションが途中で中断した場合、その理由を三つのカテゴリー（患者理由・ドナーの健康以外の理由・ドナーの健康上の理由）で記録している。分析対象は国内在住でコーディネーションが完全に終了している11,049名とする[^exclude]。

[^exclude]: 海外に在住している人が1人いた。また、データ提供時点でコーディネーションが進行している人が104名いた。コーディネーションが進行している人の比率は実験群間でバランスしている（F-value, p-value = $0.956$）

追加的なデータとして、我々はJMDPがホームページ上で公開している施設リストを用いる。このデータは病院の住所に加えて、骨髄採取が可能かどうか、末梢血幹細胞採取が可能かどうかを含んでいる。我々はこのデータを都道府県レベルで集計して、10平方キロメートル当たりの病院の数を計算し、コーディネーションデータと都道府県をキーとして突合する。我々はこの変数をコーディネーションや提供のトラベリングコストとみなす。

```{r}
#| label: experiment-summary
#| include: false

summary_stat <- use %>%
  select(
    male,
    age,
    coordinate,
    hospital_per_area,
    PB_per_area,
    BM_per_area,
    treat
  ) %>%
  group_by(treat) %>%
  summarize_all(mean) %>%
  mutate_at(vars(-treat), list(~sprintf("%1.3f", .))) %>%
  pivot_longer(-treat, names_to = "vars", values_to = "mean") %>%
  pivot_wider(names_from = "treat", values_from = "mean")

balance_p <- use %>%
  select(
    male,
    age,
    coordinate,
    hospital_per_area,
    PB_per_area,
    BM_per_area,
    treat,
    RCTweek
  ) %>%
  pivot_longer(male:BM_per_area, values_to = "value", names_to = "vars") %>%
  group_by(vars) %>%
  do(est = lm_robust(
    value ~ treat,
    clusters = RCTweek,
    se_type = "stata",
    data = .
  )) %>%
  summarize(
    vars = vars,
    f = summary(est)$fstatistic[1],
    numdf = summary(est)$fstatistic[2],
    dendf = summary(est)$fstatistic[3],
    p = sprintf("%1.3f", pf(f, numdf, dendf, lower.tail = FALSE))
  ) %>%
  select(vars, p)

balance_test <- summary_stat %>%
  dplyr::left_join(balance_p, by = "vars") %>%
  mutate(type = "C. Balance Test") %>%
  mutate(vars = recode(
    vars,
    "male" = "Male (=1)",
    "age" = "Age",
    "coordinate" = "Number of past coordinations",
    "hospital_per_area" = "Number of listed hospitals",
    "PB_per_area" = "Number of hospitals listed with PBSC collection",
    "BM_per_area" = "Number of hospitals listed with BM collection"
  ))

size <- with(use, sprintf("%1d", table(treat))) %>%
  {
    tribble(
      ~vars, ~A, ~B, ~C, ~D, ~p, ~type,
      "Standard notification", "X", "X", "X", "X", "", "A. Interventions",
      "Probability message", "", "X", "", "X", "", "A. Interventions",
      "Patients message", "", "", "X", "X", "", "A. Interventions",
      "N", .[1], .[2], .[3], .[4], "", "B. Sample Size"
    )
  }

tbl_experiment_summary <- bind_rows(size, balance_test)
```

```{r}
#| label: tbl-experiment-summary
#| tbl-cap: Overview of Field Experiment
#| output: asis
#| vscode: {languageId: r}

tbl_experiment_summary %>%
  rename(`F-test, p-value` = p) %>%
  as_grouped_data("type") %>%
  as_flextable(hide_grouplabel = TRUE) %>%
  add_header_row(values = c("", "Experimental Arms", ""), colwidths = c(1, 4, 1)) %>%
  align(j = -1, align = "center", part = "all") %>%
  padding(j=1:6, padding.top=5, padding.bottom = 5, part = "all") %>%
  padding(2:4, padding.left = 10) %>%
  padding(6, padding.left = 10) %>%
  padding(8:13, padding.left = 10) %>%
  width(j = 1, 2) %>%
  fontsize(size = 9, part = "all")  %>%
  ft_theme()
```

@tbl-experiment-summary はフィールド実験の概要を示している。パネルAは各実験群の介入をまとめており、パネルBは各実験群のサンプルサイズを示している。パネルCは共変量のバランステストの結果を示しており、割り当てのランダム化が成功しているかどうかを検証している。ほとんどの共変量が群間でバランスしているので、実験群の割り当てはおおよそランダムである。ただし、実験群C・Dのドナー候補者は実験群A・Bのドナー候補者よりも若く、群間でアンバランスな可能性がある（F-test, p-value = $0.067$）。

ドナー候補者は実験群を選択できない、すなわち、実験群は外生的であるので、単純な二群比較は平均処置効果を識別できる。ただし、年齢および割り当ての週と月の数が実験群間で完全にバランスしていないので、単純な二群比較はバイアスを伴う可能性がある。そこで、二群比較に加えて、我々は$m$月の第$w$週に適合通知を受け取った個人$i$について以下の線形確率モデルを推定する、

\begin{equation}
  Y_{imw} =
  \beta_1 \cdot \text{B}_{mw} + \beta_2 \cdot \text{C}_{mw}
  + \beta_3 \cdot \text{D}_{mw}
  + X'_i \gamma + \lambda_m + \theta_w + u_{imw}
\end{equation}

ここで、$X_i$は個人属性ベクトル、$\lambda_m$と$\theta_w$はそれぞれ週・月のダミー変数である。我々はランダム化のユニットである実験週レベルでクラスタした標準誤差を使用する。

# Experimental Results

```{r}
#| label: balance-test-exogeneous-stop-reply
#| eval: false

lm_robust(
  exg_stop_reply ~ treat,
  data = use,
  cluster = RCTweek,
  se_type = "stata"
) %>%
{
  f <- summary(.)$fstatistic[1]
  numdf <- summary(.)$fstatistic[2]
  dendf <- summary(.)$fstatistic[3]
  p <- pf(f, numdf, dendf, lower.tail = FALSE)

  sprintf("F-value = %1.3f; p-value = %1.3f", f, p)
}
```

```{r}
#| label: create-stock-data
#| include: false
#| vscode: {languageId: r}

stock <- use %>%
  dplyr::filter(exg_stop_reply == 0) %>%
  rename(positive = intention) %>%
  mutate(
    negative = reply * (1 - positive),
    age_demean = age - mean(rawdt$age),
  ) %>%
  select(reply, positive, negative, everything()) %>%
  pivot_longer(reply:negative, names_to = "outcome") %>%
  mutate(outcome = factor(
    outcome,
    levels = unlist(names(outcome_label)[1:3]),
    labels = unlist(outcome_label[1:3])
  ))
```

はじめに、ドナー候補者の意向が最も現れる返信に対する効果を推定する。返信のアウトカム変数は提供意向に関わらず適合通知に返信したらならば1を取るダミー変数である。さらに、提供意向の変数を用いて、返信に対する効果を二つに分解する。第一に、正の意向を示して、適合通知に返信した効果である。アウトカム変数は適合通知に返信し、かつ提供の意向を示したならば1を取るダミー変数である。第二に、負の意向を示して、適合通知に返信した効果である。アウトカム変数は適合通知に返信し、かつ提供の意向を示さなければ1を取るダミー変数である。これらの効果を推定するとき、返信していない場合を0とコーディングして、非返信者もサンプルに含める。提供の意向に関する二つのアウトカム変数の和は必ず返信のアウトカム変数と一致するので、二つの意向に対する効果の和は必ず返信に対する効果となる。コントロール（実験群A）の返信率は$88.35$%である。正の意向を伴って返信した比率は$55.33$%である一方で、負の意向を伴って返信した比率は$33.03$%である。したがって、適合通知に返信したドナー候補者の$62.63$%が提供したいと考えている。

返信をする以前に患者側の都合でコーディネーションが中断してしまう可能性がある。このケースはドナー候補者の意向と無関係に生じるコーディネーションの中断なので、分析のサンプルから除外する。各実験群の$0.5$--$0.7$%をこのケースで除外しており、その比率は群間でバランスしている（F-test, p-value=$0.242$）。

## Main Results

```{r}
#| label: est-full-reply
#| include: false

mod <- list(
  unctrl = value ~ treat,
  ctrl = value ~ treat + age_demean + I(age_demean^2) + male + coordinate +
    hospital_per_area + PB_per_area + BM_per_area +
    factor(prefecture) + factor(month) + factor(week)
)

est_stock <- stock %>%
  group_by(outcome) %>%
  nest() %>%
  mutate(
    fit1 = map(
      data,
      ~ lm_robust(
        mod$unctrl,
        data = .,
        cluster = RCTweek,
        se_type = "stata"
      )
    ),
    fit2 = map(
      data,
      ~ lm_robust(
        mod$ctrl,
        data = .,
        cluster = RCTweek,
        se_type = "stata"
      )
    )
  ) %>%
  pivot_longer(
    fit1:fit2,
    names_prefix = "fit",
    names_to = "model",
    values_to = "fit"
  )

ctrl_avg <- stock %>%
  dplyr::filter(treat == "A") %>%
  group_by(outcome) %>%
  summarize(mean = sprintf("%1.4f", mean(value)))

add_table <- tibble::tribble(
  ~term, ~"(1)", ~"(2)", ~"(3)", ~"(4)", ~"(5)", ~"(6)",
  "Control average", ctrl_avg$mean[1], ctrl_avg$mean[1],
  ctrl_avg$mean[2], ctrl_avg$mean[2],
  ctrl_avg$mean[3], ctrl_avg$mean[3],
  "Covariates", "", "X", "", "X", "", "X"
)

attr(add_table, "position") <- 9:12

tbl_est_stock <- est_stock %>%
  pull(fit) %>%
  setNames(paste0("(", seq_len(length(.)), ")")) %>%
  modelsummary(
    coef_map = c(
      "(Intercept)" = "Constant",
      "treatB" = "Treatment B",
      "treatC" = "Treatment C",
      "treatD" = "Treatment D"
    ),
    stars = c("***" = .01, "**" = .05, "*" = .1),
    fmt = 4,
    gof_omit = "R2|AIC|BIC|Log|Std|FE|se_type",
    add_rows = add_table,
  )
```

```{r}
#| label: tbl-full-reply
#| tbl-cap: Linear Probability Model of Replay and Intention
#| vscode: {languageId: r}

tbl_est_stock %>%
  add_header_row(
    values = c("", "Reply", "Positive", "Negative"),
    colwidths = c(1, 2, 2, 2)
  ) %>%
  add_header_row(
    values = c("", "Intention"),
    colwidths = c(3, 4)
  ) %>%
  align(j = -1, align = "center", part = "all") %>%
  add_footer_lines(paste(
    "Notes: * p < 0.1, ** p < 0.05, *** p < 0.01.",
    "Standard errors clustered by experimental weeks",
    "are reported in parentheses.",
    "Covariates are gender, squared polynomial of (demeaned) age,",
    "number of past coordinations,",
    "number of hospitals per 10 square kilometers,",
    "number of hospitals with PBSC collection per 10 square kilometers,",
    "number of hospitals with BM collection per 10 square kilometers,",
    "prefecture dummies, month dummies, and week dummies."
  )) %>%
  width(j = 1, 1) %>%
  fontsize(size = 9, part = "all")  %>%
  ft_theme()
  # kableExtra::kable_styling() %>%
  # kableExtra::add_header_above(c(
  #   " " = 1, "Reply" = 2, "Positive" = 2, "Negative" = 2
  # )) %>%
  # kableExtra::add_header_above(c(
  #   " " = 3, "Intention" = 4
  # )) %>%
  # kableExtra::footnote(
  #   paste(
      # "* p < 0.1, ** p < 0.05, *** p < 0.01.",
      # "Standard errors clustered by experimental weeks",
      # "are reported in parentheses.",
      # "Covariates are gender, squared polynomial of (demeaned) age,",
      # "number of past coordinations,",
      # "number of hospitals per 10 square kilometers,",
      # "number of hospitals with PBSC collection per 10 square kilometers,",
      # "number of hospitals with BM collection per 10 square kilometers,",
      # "prefecture dummies, month dummies, and week dummies."
  #   ),
  #   threeparttable = TRUE
  # )
```

@tbl-full-reply は線形確率モデルの推定結果である。奇数列は実験群ダミーのみを説明変数として用いているのに対して、偶数列は個人属性や月・週の固定効果も制御している。列(1)は、確率メッセージを加えた適合通知を送付する実験群Bが返信率を1ポイントもしくは$1.2$%高めていることを示している。個人属性などをコントロールする（列(2)）と、効果のサイズは大きく変化しないが、統計的に5%水準で有意となる。この効果は正の意向を伴った返信の増加に由来している。列(3)と(5)では、実験群Bが正の意向を伴った返信率を2ポイントもしくは$3.94$%高めている一方で、負の意向を伴った返信率を1ポイントもしくは$3.42$%下げている。ただし、これらの統計的な有意性は弱い。また、実験群CとDは実験群Bよりも効果のサイズが小さく、統計的に非有意である。我々は頑健性の分析としてロジットモデルを推定した（@full-reply-logit）。その結果は効果の方向について上表と整合的であるが、統計的に非有意である。総合すると、我々の介入は全体的に返信に大きな影響を与えていない。

```{r}
#| label: est-subsample-reply
#| include: false

est_stock_sub <- stock %>%
  mutate(age_less30 = if_else(age < 30, 1, 0)) %>%
    group_by(outcome, male, age_less30) %>%
    nest() %>%
    mutate(est = map(data, ~ lm_robust(
      update(mod$ctrl, . ~ . - male - age_demean),
      cluster = RCTweek,
      se_type = "stata",
      data = .x
    )))

plotdt_stock_sub <- est_stock_sub %>%
  mutate(
    fit = map(est, tidy),
    fit = map(fit, ~ subset(.x, str_detect(term, "treat"))),
    fit = map(fit, ~ dplyr::select(.x, -outcome)),
    N = map_chr(est, ~ paste("N =", nobs(.x))),
    mean = map_dbl(data, ~ with(subset(., treat == "A"), mean(value))),
    mean = sprintf("Control avg = %1.3f", mean)
  ) %>%
  select(-data, -est) %>%
  unnest(cols = fit) %>%
  mutate(
    pos = paste0(male, age_less30),
    pos = factor(
      pos,
      levels = c("01", "00", "11", "10"),
      labels = c(
        "Female\u00d7\nAge<30",
        "Female\u00d7\n30\u2264Age",
        "Male\u00d7\nAge<30",
        "Male\u00d7\n30\u2264Age"
      )
    ),
    term = str_replace(term, "treat", ""),
    term = factor(term, LETTERS[2:4])
  )

text <- plotdt_stock_sub %>%
  select(male, age_less30, pos, N, mean) %>%
  distinct()
```

```{r}
#| label: fig-subsample-reply
#| fig-cap: 'Effect on Reply and Intentions by Gender and Age Group. Note: These plots show the average effect (and associated 95% confidential interval) on each outcome by gender and age group. We cluster standard errors by experimental weeks. We control number of past coordinations, number of hospitals per 10 square kilometers, number of hospitals with PBSC collection per 10 square kilometers, number of hospitals with BM collection per 10 square kilometers, prefecture dummies, month dummies, and week dummies.'
#| vscode: {languageId: r}

plot_list <- unique(plotdt_stock_sub$outcome) %>%
  purrr::map(function(x) {
    subset(plotdt_stock_sub, outcome == x) %>%
      ggplot(aes(x = pos, y = estimate)) +
      geom_hline(aes(yintercept = 0), linetype = 2) +
      geom_point(
        aes(color = term, shape = term),
        size = 3, position = position_dodge(0.5)
      ) +
      geom_errorbar(
        aes(ymin = conf.low, ymax = conf.high, color = term),
        position = position_dodge(0.5),
        width = 0
      ) +
      geom_text(
        aes(y = -0.125, label = N),
        data = subset(text, outcome == x),
        color = "black"
      ) +
      geom_text(
        aes(y = -0.15, label = mean),
        data = subset(text, outcome == x),
        color = "black"
      ) +
      scale_y_continuous(
        breaks = seq(-0.2, 0.2, by = 0.05), limits = c(-0.17, 0.17)
      ) +
      labs(
        title = paste("Outcome:", x),
        x = "Subset",
        y = "Estimated Effects (95%CI)",
        color = "Treatment", shape = "Treatment"
      ) +
      simplegg()
  })

wrap_plots(plot_list, ncol = 2) +
  plot_layout(guides = "collect") &
  theme(legend.position = "bottom")
```

次に、メッセージの効果の異質性を検証するために、我々は性別と年齢層（30歳未満かどうか）でサンプルを4分割して、各サブセットでメッセージの効果を推定している。 @fig-subsample-reply はその係数プロットである。その結果、確率メッセージを加えた実験群BとDは30歳未満の男性の返信率を6ポイントもしくは$8.06$%高めている（ベースラインの返信率は$74.4$%）。

確率メッセージだけを加えた実験群Bの効果は正の意向を伴う返信率の増加に起因している。このグループで、実験群Bは正の意向を伴う返信率を10ポイントもしくは$25.91$%高めている（ベースラインの比率は$38.6$%）が、負の意向を伴う返信率を3ポイントもしくは$8.38$%下げている（ベースラインの比率は$35.8$%）。これらは統計的に有意な効果である。一方で、確率メッセージと利他メッセージを加えた実験群Dは正の意向を伴う返信と負の意向を伴う返信を同程度増やしている。特に、実験群Dは負の意向を伴う返信率を3ポイントもしくは$8.38$%高めていて、これは統計的に有意である。

他の性年代のグループ（とくに、30歳以上の男女）では、介入メッセージが返信や意向に大きな影響を与えていない。ただし、30歳未満の女性で、実験群Dが正の意向を伴う返信率を$0.05$もしくは$9.69$%下げている。したがって、他のドナー候補者が少ないというメッセージは若年男性の提供意向を高め、適合通知への返信を促している。若年男性ドナーは移植成績が良いにも関わらず、提供意向が他の性年代よりも明らかに低いことを考慮すると、確率メッセージは移植コーディネーションの効率性を改善しているといえる。

## Robustness to Heterogenous Effect

メッセージ効果の異質性についていくつかの頑健性の分析を行う。はじめに、ワイルドクラスターブートストラップ法でp値を計算する。クラスターの数が少ないと、クラスター標準誤差は帰無仮説を過剰に棄却してしまう。それを修正するために、ワイルドクラスターブートストラップ法を用いる。@tbl-young-reply は30歳未満の女性（列(1)--(3)）と30歳未満の男性（列(4)--(6)）でサンプルを限定して推定している。その結果、ワイルドブートストラップ法でも確率メッセージが30歳未満男性の返信、特に正の意向を伴う返信を増やすという結果を得られる。ただし、それ以外の効果はワイルドブートストラップ法によって棄却できなくなる。

```{r}
#| label: est-int-rcf
#| include: false

covariate <- ~ 0 + male + age + coordinate + hospital_per_area +
  PB_per_area + BM_per_area

Y <- use$intention
X <- model.matrix(covariate, data = use)
W <- use$treat
G <- use$RCTweek

int_rcf <- multi_arm_causal_forest(X, Y, W)
int_tau <- predict(int_rcf, X)
```

```{r}
#| label: fig-int-rcf
#| fig-cap: Distribution of Individual Treatment Effects on Intention Estimated by Random Causal Forest.

predict_int_rcf <- data.frame(X) %>%
  cbind(int_tau$predictions) %>%
  rename(
    effect_B = `B - A.Y.1`,
    effect_C = `C - A.Y.1`,
    effect_D = `D - A.Y.1`
  ) %>%
  pivot_longer(
    effect_B:effect_D,
    names_to = c(".value", "treat"),
    names_sep = "_"
  ) %>%
  mutate(
    treat = factor(treat, labels = paste("Message", LETTERS[2:4])),
    age_less30 = if_else(age < 30, 1, 0),
    pos = paste0(male, age_less30),
    pos = factor(
      pos,
      levels = c("01", "00", "11", "10"),
      labels = c(
        "Female\u00d7\nAge<30",
        "Female\u00d7\n30\u2264Age",
        "Male\u00d7\nAge<30",
        "Male\u00d7\n30\u2264Age"
      )
    )
  )

predict_int_rcf %>%
  ggplot(aes(x = effect, y = after_stat(count) / sum(after_stat(count)))) +
  geom_histogram(
    aes(fill = effect > 0),
    breaks = seq(-.2, .2, by = .01),
    color = "black"
  ) +
  scale_fill_manual(values = c("white", "red")) +
  facet_grid(treat~pos) +
  labs(
    x = "Treatment effects",
    y = "Fraction"
  ) +
  simplegg() +
  theme(legend.position = "none")
```

```{r}
#| label: est-int-rcf-cate
#| include: false

subset_cond <- list(
  X[, "male"] == 1 & X[, "age"] < 30,
  X[, "male"] == 0 & X[, "age"] < 30,
  X[, "male"] == 1 & X[, "age"] >= 30,
  X[, "male"] == 0 & X[, "age"] >= 30
)

ate_int_rcf <- subset_cond %>%
  purrr::map(~ average_treatment_effect(int_rcf, subset = .)) %>%
  reduce(bind_rows) %>%
  mutate(
    z = abs(estimate / std.err),
    p = 2 * pnorm(z, lower.tail = FALSE),
    gender = rep(c("Males", "Females", "Males", "Females"), each = 3),
    age = rep(c("Young", "Elder"), each = 6)
  )

tbl_int_rcf <- ate_int_rcf %>%
  select(gender, age, contrast, estimate, std.err, p) %>%
  pivot_wider(names_from = gender, values_from = estimate:p) %>%
  select(age, contrast, ends_with("Females"), ends_with("Males")) %>%
  mutate(contrast = str_extract(contrast, "[B-D]"))
```

```{r}
#| label: tbl-int-rcf-cate
#| tbl-cap: Conditional Average Treatment Effect Estimated by RCF.

tbl_int_rcf %>%
  mutate(age = recode(
    age,
    "Young" = "Age: Less than 30",
    "Elder" = "Age: More than or equal to 30"
  )) %>%
  as_grouped_data("age") %>%
  as_flextable(hide_grouplabel = TRUE) %>%
  set_header_labels(
    contrast = "",
    estimate_Females = "Estimate",
    std.err_Females = "S.E.",
    p_Females = "P-value",
    estimate_Males = "Estimate",
    std.err_Males = "S.E.",
    p_Males = "P-value"
  ) %>%
  add_header_row(values = c("", "Females", "Males"), colwidths = c(1, 3, 3)) %>%
  align(j = -1, align = "center", part = "all") %>%
  colformat_double(j = -1, digits = 3) %>%
  padding(j=1:7, padding.top = 5, padding.bottom = 5, part = "all") %>%
  padding(2:4, padding.left = 10) %>%
  padding(6:8, padding.left = 10) %>%
  fontsize(size = 9, part = "all")  %>%
  ft_theme()
```

次に、random causal forestによって効果の異質性を検証する。この手法は与えられた共変量の組合せでサンプルを分割し、各サブサンプル内でトリートメント効果を推定する。これにより、研究者によって与えられた共変量で特徴づけられるサンプルの個別の介入効果を得られる。サンプルを分割する共変量の組合せは推定されるサブサンプルのトリートメント効果の平均二乗誤差を最小にするように決める。裏返すと、これは各サブサンプルのトリートメント効果の分散を最大にすることである。

@fig-int-rcf-cate は各実験群の正の意向を伴う返信に対する効果の分布である。特徴的な結果は30歳未満の男性の90%が実験群Bに対してポジティブな反応を示していることである。random causal forestは実験群Bの30歳未満の男性に対する平均効果が12.5ポイントであり、統計的に有意である（@tbl-int-rcf-cate）。これは@fig-subsample-reply で得られた推定値とほとんど一致する。

また、他の性年代グループに対して、介入群の効果は統計的に非有意である。これは介入群に対してポジティブな反応を示す人とネガティブな反応を示す人が同程度に存在しているからである。では、どのような特徴を持った人がポジティブな反応を示しやすいのだろうか。我々は各性年代グループの中で正の影響を受ける人とそうでない人の平均的な個人属性の差を検証した（@tbl-covariate-int-rcf）。30歳以上の男女のグループでは、高齢の人や過去のコーディネート経験が多い人がメッセージにポジティブな反応を示しやすい。また、30歳以上の女性のグループでは、病院の数が多い人がメッセージにポジティブな反応を示しやすい一方で、30歳以上の男性のグループでは、病院の数が少ない人がメッセージにポジティブな反応を示しやすい。30歳未満の女性のグループでは、若い人がメッセージにポジティブな反応を示しやすい。また、このグループでは、過去のコーディネート経験が多い人ほど介入群CとDにポジティブな反応を示しやすく、病院の数が多い人ほど介入群Dにポジティブな反応を示しやすい。

## Response Speed to Notification

```{r}
#| label: create-flow-data
#| include: false
#| vscode: {languageId: r}

flow <- stock %>%
  mutate(
    days_reply = if_else(is.na(days_reply), 10000, days_reply),
    days4 = if_else(days_reply <= 4, value, 0),
    days7 = if_else(days_reply <= 7, value, 0),
    days10 = if_else(days_reply <= 10, value, 0),
    days14 = if_else(days_reply <= 14, value, 0),
    days21 = if_else(days_reply <= 21, value, 0),
    days28 = if_else(days_reply <= 28, value, 0)
  ) %>%
  select(-value) %>%
  pivot_longer(days4:days28, names_to = "within", names_prefix = "days") %>%
  mutate(within = as.numeric(within))
```

我々のデータは返信日数を含んでいるので、効果の経時的な推移を検証する。そこで、$d$日以内に返信する確率$\text{Pr}(D_{imw} \le d)$を線形確率モデルで推定する。このとき、アウトカム変数は$d$日以内に返信したならば1を取るようなダミー変数である。$d$の値を十分に大きくすると、$\text{Pr}(D_{imw} \le d)$に対する効果は前小節で示した返信に対する効果と一致する。また、前小節と同様に、$\text{Pr}(D_{imw} \le d)$に対する効果を提供意向の観点から二つの効果に分解する。正の意向については、提供意向があり、かつ$d$日以内に返信したならば1を取るようなダミー変数である。負の意向については、提供意向がなく、かつ$d$日以内に返信したならば1を取るようなダミー変数である。

```{r}
#| label: est-subsample-speed
#| include: false
#| vscode: {languageId: r}

est_flow_sub <- flow %>%
  mutate(age_less30 = if_else(age < 30, 1, 0)) %>%
  dplyr::filter(age_less30 == 1) %>%
  group_by(outcome, within, male) %>%
  nest() %>%
  mutate(
    fit = map(data, ~ lm_robust(
      update(mod$ctrl, . ~ . - male - age_demean),
      cluster = RCTweek,
      se_type = "stata",
      data = .x
    )),
    avg = map_chr(data, ~ sprintf(
      "%1d\n(%1.3f)", within, with(subset(.x, treat == "A"), mean(value))
    ))
  ) %>%
  mutate(
    tidy = map(fit, tidy),
    tidy = map(tidy, ~ subset(.x, str_detect(term, "treat"))),
    tidy = map(tidy, ~ dplyr::select(.x, -outcome))
  ) %>%
  dplyr::select(-data, -fit) %>%
  unnest(cols = tidy) %>%
  mutate(
    term = str_replace(term, "treat", ""),
    term = factor(term, LETTERS[2:4])
  )

est_flow_sub
```

```{r}
#| label: fig-young-male-speed
#| fig-cap: 'Effect on Reply within Specific Days after Sending Notification among Males Less than 30. Notes: These plots show the average effect (and associated 95% confidential interval) on each outcome.'
#| vscode: {languageId: r}

plot_list_male <- unique(est_flow_sub$outcome) %>%
  purrr::map(function(x) {
    subset(est_flow_sub, male == 1 & outcome == x) %>%
      ggplot(aes(x = within, y = estimate, color = term, shape = term)) +
      geom_hline(aes(yintercept = 0), linetype = 2) +
      geom_point(size = 3, position = position_dodge(2)) +
      geom_errorbar(
        aes(ymin = conf.low, ymax = conf.high),
        position = position_dodge(2),
        width = 0
      ) +
      scale_x_continuous(
        breaks = subset(est_flow_sub, male == 1 & outcome == x)$within,
        labels = subset(est_flow_sub, male == 1 & outcome == x)$avg
      ) +
      scale_y_continuous(
        breaks = seq(-0.2, 0.2, by = 0.05), limits = c(-0.1, 0.2)
      ) +
      labs(
        title = paste("Outcome:", x),
        x = "Days after sending notification\n(Control average)",
        y = "Estimated Effects (95%CI)",
        color = "Treatment", shape = "Treatment"
      ) +
      simplegg()
  })

wrap_plots(plot_list_male, ncol = 2) +
  plot_layout(guides = "collect") &
  theme(legend.position = "bottom")
```


我々の介入メッセージの効果は異質的であるので、返信スピードに対する効果も異質性に注目する。@fig-young-male-speed は30歳未満の男性にサンプルを限定している。JMDPは適合通知に返信の目安として7日を明記している。このサブサンプルの統制群において、7日以内に返信した人の割合は21%である。また、返信日数が早ければ早いほど、適合通知に返信した人の中で提供したいと考える人が多く存在する。例えば、4日以内に返信した人の68%が提供したいと考えており、28日以内に返信した人の51%が提供したいと考えている。言い換えれば、返信が遅い人ほど、提供の意思を持っていない可能性がある。

この性年代グループでは、確率メッセージのみを加えた介入群Bが正の意向を伴う返信を増やしていることが明らかになった。この効果は主に返信に10日以上かかるドナー候補者の行動によって生じている。介入群Bは10日以内の返信や正の意向を伴う返信に対して統計的に有意な効果を持っていないが、14--28日以内の返信や正の意向を伴う返信に対して統計的に有意な効果を持っている。また、特筆すべき結果として、介入群Bは7--10日以内に負の意向を伴って返信する確率を下げている。

```{r}
#| label: fig-young-female-speed
#| fig-cap: 'Effect on Reply within Specific Days after Sending Notification among Females Less than 30. Notes: These plots show the average effect (and associated 95% confidential interval) on each outcome.'
#| vscode: {languageId: r}

plot_list_female <- unique(est_flow_sub$outcome) %>%
  purrr::map(function(x) {
    subset(est_flow_sub, male == 0 & outcome == x) %>%
      ggplot(aes(x = within, y = estimate, color = term, shape = term)) +
      geom_hline(aes(yintercept = 0), linetype = 2) +
      geom_point(size = 3, position = position_dodge(2)) +
      geom_errorbar(
        aes(ymin = conf.low, ymax = conf.high),
        position = position_dodge(2),
        width = 0
      ) +
      scale_x_continuous(
        breaks = subset(est_flow_sub, male == 0 & outcome == x)$within,
        labels = subset(est_flow_sub, male == 0 & outcome == x)$avg
      ) +
      scale_y_continuous(
        breaks = seq(-0.2, 0.2, by = 0.05), limits = c(-0.2, 0.2)
      ) +
      labs(
        title = paste("Outcome:", x),
        x = "Days after sending notification\n(Control average)",
        y = "Estimated Effects (95%CI)",
        color = "Treatment", shape = "Treatment"
      ) +
      simplegg()
  })

wrap_plots(plot_list_female, ncol = 2) +
  plot_layout(guides = "collect") &
  theme(legend.position = "bottom")
```

@fig-young-female-speed は30歳未満の女性にサンプルを限定している。その結果、

## Effects on Coordination Process

```{r}
#| label: create-coordination-data
#| include: false
#| vscode: {languageId: r}

exclude <- use %>%
  select(id, starts_with("exg_stop")) %>%
  pivot_longer(
    -id,
    names_to = "outcome", values_to = "exclude",
    names_prefix = "exg_stop_"
  )

coordination <- use %>%
  select(test, candidate, consent, donate, everything()) %>%
  pivot_longer(test:donate, names_to = "outcome") %>%
  dplyr::left_join(exclude, by = c("id", "outcome")) %>%
  mutate(
    age_demean = age - mean(rawdt$age),
    outcome = factor(
      outcome,
      levels = unlist(names(outcome_label)[4:7]),
      labels = unlist(outcome_label[4:7])
    )
  )
```

```{r}
#| label: est-full-coordination
#| include: false

est_coordination <- coordination %>%
  group_by(outcome) %>%
  nest() %>%
  mutate(
    fit1 = map(
      data,
      ~ lm_robust(
        mod$unctrl,
        data = subset(., exclude == 0),
        cluster = RCTweek,
        se_type = "stata"
      )
    ),
    fit2 = map(
      data,
      ~ lm_robust(
        mod$ctrl,
        data = subset(., exclude == 0),
        cluster = RCTweek,
        se_type = "stata"
      )
    ),
    avg = map_chr(
      data,
      ~ with(
        subset(., exclude == 0 & treat == "A"),
        sprintf("%.4f", mean(value))
      )
    )
  ) %>%
  pivot_longer(
    fit1:fit2,
    names_prefix = "fit",
    names_to = "model",
    values_to = "fit"
  ) %>%
  select(- data)

add_table <- c("Control average", est_coordination$avg) %>%
  rbind(c("Covariates", "", "X", "", "X", "", "X", "", "X")) %>%
  data.frame()

attr(add_table, "position") <- c(9, 10)

tbl_est_coordination <- est_coordination %>%
  pull(fit) %>%
  modelsummary(
    coef_map = c(
      "(Intercept)" = "Constant",
      "treatB" = "Treatment B",
      "treatC" = "Treatment C",
      "treatD" = "Treatment D"
    ),
    stars = c("***" = .01, "**" = .05, "*" = .1),
    fmt = 4,
    gof_omit = "R2|AIC|BIC|Log|Std|FE|se_type",
    add_rows = add_table
  )
```

```{r}
#| label: tbl-full-coordination
#| tbl-cap: Linear Probability Model of Coordination Process.
#| output: asis
#| vscode: {languageId: r}

tbl_est_coordination %>%
  add_header_row(
    values = c("", "CT", "Candidate", "Consent", "Donation"),
    colwidths = c(1, 2, 2, 2, 2)
  ) %>%
  align(j = -1, align = "center", part = "all") %>%
  add_footer_lines(paste(
    "Notes: * p < 0.1, ** p < 0.05, *** p < 0.01.",
    "Standard errors clustered by experimental weeks",
    "are reported in parentheses.",
    "Covariates are gender, squared polynomial of (demeaned) age,",
    "number of past coordinations,",
    "number of hospitals per 10 square kilometers,",
    "number of hospitals with PBSC collection per 10 square kilometers,",
    "number of hospitals with BM collection per 10 square kilometers,",
    "prefecture dummies, month dummies, and week dummies."
  )) %>%
  width(j = 1, 1) %>%
  fontsize(size = 9, part = "all") %>%
  ft_theme()
  # kableExtra::kable_styling() %>%
  # kableExtra::add_header_above(c(
  #   " " = 1, "CT" = 2, "Candidate" = 2, "Consent" = 2, "Donation" = 2
  # )) %>%
  # kableExtra::footnote(
  #   paste(
  #     "* p < 0.1, ** p < 0.05, *** p < 0.01.",
  #     "Standard errors clustered by experimental weeks",
  #     "are reported in parentheses.",
  #     "Covariates are gender, squared polynomial of (demeaned) age,",
  #     "number of past coordinations,",
  #     "number of hospitals per 10 square kilometers,",
  #     "number of hospitals with PBSC collection per 10 square kilometers,",
  #     "number of hospitals with BM collection per 10 square kilometers,",
  #     "prefecture dummies, month dummies, and week dummies."
  #   ),
  #   threeparttable = TRUE
  # )
```

```{r}
#| label: est-subsample-coordination
#| include: false
#| vscode: {languageId: r}

est_coordination_sub <- coordination %>%
  mutate(age_less30 = if_else(age < 30, 1, 0)) %>%
  group_by(outcome, male, age_less30) %>%
  nest() %>%
  mutate(est = map(data, ~ lm_robust(
    update(mod$ctrl, . ~ . - male - age_demean),
    cluster = RCTweek,
    se_type = "stata",
    data = subset(.x, exclude == 0)
  )))

pdt_coordination_sub <- est_coordination_sub %>%
  mutate(
    fit = map(est, tidy),
    fit = map(fit, ~ subset(.x, str_detect(term, "treat"))),
    fit = map(fit, ~ dplyr::select(.x, -outcome)),
    N = map_chr(est, ~ paste("N =", nobs(.x))),
    mean = map_dbl(data, ~ with(subset(., exclude == 0 & treat == "A"), mean(value))),
    mean = sprintf("Control avg = %1.3f", mean)
  ) %>%
  select(-data, -est) %>%
  unnest(cols = fit) %>%
  mutate(
    pos = paste0(male, age_less30),
    pos = factor(
      pos,
      levels = c("01", "00", "11", "10"),
      labels = c(
        "Female\u00d7\nAge<30",
        "Female\u00d7\n30\u2264Age",
        "Male\u00d7\nAge<30",
        "Male\u00d7\n30\u2264Age"
      )
    ),
    term = str_replace(term, "treat", ""),
    term = factor(term, LETTERS[2:4])
  )

text <- pdt_coordination_sub %>%
  ungroup() %>%
  select(male, age_less30, pos, N, mean, outcome) %>%
  distinct()
```

```{r}
#| label: fig-subsample-coordination
#| fig-cap: 'Effect on Coordination by Gender and Age Group. Note: These plots show the average effect (and associated 95% confidential interval) on each outcome by gender and age group. We cluster standard errors by experimental weeks. We control number of past coordinations, number of hospitals per 10 square kilometers, number of hospitals with PBSC collection per 10 square kilometers, number of hospitals with BM collection per 10 square kilometers, prefecture dummies, month dummies, and week dummies.'
#| vscode: {languageId: r}

plot_list <- unique(pdt_coordination_sub$outcome) %>%
  purrr::map(function(x) {
    subset(pdt_coordination_sub, outcome == x) %>%
      ggplot(aes(x = pos, y = estimate)) +
      geom_hline(aes(yintercept = 0), linetype = 2) +
      geom_point(
        aes(color = term, shape = term),
        size = 3, position = position_dodge(0.5)
      ) +
      geom_errorbar(
        aes(ymin = conf.low, ymax = conf.high, color = term),
        position = position_dodge(0.5),
        width = 0
      ) +
      geom_text(
        aes(y = -0.1, label = N),
        data = subset(text, outcome == x),
        color = "black"
      ) +
      geom_text(
        aes(y = -0.125, label = mean),
        data = subset(text, outcome == x),
        color = "black"
      ) +
      scale_y_continuous(
        breaks = seq(-0.2, 0.2, by = 0.05), limits = c(-0.15, 0.2)
      ) +
      labs(
        title = paste("Outcome:", x),
        x = "Subset",
        y = "Estimated Effects (95%CI)",
        color = "Treatment", shape = "Treatment"
      ) +
      simplegg()
  })

wrap_plots(plot_list, ncol = 2) +
  plot_layout(guides = "collect") &
  theme(legend.position = "bottom")
```

```{r}
#| label: est-donate-rcf
#| include: false
#| eval: false

donate <- subset(coordination, outcome == "Donation")
Y <- donate$value
X <- model.matrix(covariate, data = donate)
W <- donate$treat
G <- donate$RCTweek

donate_rcf <- multi_arm_causal_forest(X, Y, W)
donate_tau <- predict(donate_rcf, X)
```

```{r}
#| label: fig-donate-rcf
#| fig-cap: Distribution of Individual Treatment Effects on Donation Estimated by Random Causal Forest.
#| eval: false

predict_donate_rcf <- data.frame(X) %>%
  cbind(donate_tau$predictions) %>%
  rename(
    effect_B = `B - A.Y.1`,
    effect_C = `C - A.Y.1`,
    effect_D = `D - A.Y.1`
  ) %>%
  pivot_longer(
    effect_B:effect_D,
    names_to = c(".value", "treat"),
    names_sep = "_"
  ) %>%
  mutate(
    treat = factor(treat, labels = paste("Message", LETTERS[2:4])),
    age_less30 = if_else(age < 30, 1, 0),
    pos = paste0(male, age_less30),
    pos = factor(
      pos,
      levels = c("01", "00", "11", "10"),
      labels = c(
        "Female\u00d7\nAge<30",
        "Female\u00d7\n30\u2264Age",
        "Male\u00d7\nAge<30",
        "Male\u00d7\n30\u2264Age"
      )
    )
  )

predict_donate_rcf %>%
  ggplot(aes(x = effect, y = after_stat(count) / sum(after_stat(count)))) +
  geom_histogram(
    aes(fill = effect > 0),
    breaks = seq(-.2, .2, by = .01),
    color = "black"
  ) +
  scale_fill_manual(values = c("white", "red")) +
  facet_grid(treat~pos) +
  labs(
    x = "Treatment effects",
    y = "Fraction"
  ) +
  simplegg() +
  theme(legend.position = "none")
```

```{r}
#| label: est-donate-rcf-cate
#| include: false
#| eval: false

subset_cond <- list(
  X[, "male"] == 1 & X[, "age"] < 30,
  X[, "male"] == 0 & X[, "age"] < 30,
  X[, "male"] == 1 & X[, "age"] >= 30,
  X[, "male"] == 0 & X[, "age"] >= 30
)

ate_donate_rcf <- subset_cond %>%
  purrr::map(~ average_treatment_effect(donate_rcf, subset = .)) %>%
  reduce(bind_rows) %>%
  mutate(
    z = abs(estimate / std.err),
    p = 2 * pnorm(z, lower.tail = FALSE),
    gender = rep(c("Males", "Females", "Males", "Females"), each = 3),
    age = rep(c("Young", "Elder"), each = 6)
  )

tbl_donate_rcf <- ate_donate_rcf %>%
  select(gender, age, contrast, estimate, std.err, p) %>%
  pivot_wider(names_from = gender, values_from = estimate:p) %>%
  select(age, contrast, ends_with("Females"), ends_with("Males")) %>%
  mutate(contrast = str_extract(contrast, "[B-D]"))
```

```{r}
#| label: tbl-donate-rcf-cate
#| tbl-cap: Conditional Average Treatment Effect Estimated by RCF.
#| eval: false

tbl_donate_rcf %>%
  mutate(age = recode(
    age,
    "Young" = "Age: Less than 30",
    "Elder" = "Age: More than or equal to 30"
  )) %>%
  as_grouped_data("age") %>%
  as_flextable(hide_grouplabel = TRUE) %>%
  set_header_labels(
    contrast = "",
    estimate_Females = "Estimate",
    std.err_Females = "S.E.",
    p_Females = "P-value",
    estimate_Males = "Estimate",
    std.err_Males = "S.E.",
    p_Males = "P-value"
  ) %>%
  add_header_row(values = c("", "Females", "Males"), colwidths = c(1, 3, 3)) %>%
  align(j = -1, align = "center", part = "all") %>%
  colformat_double(j = -1, digits = 3) %>%
  padding(j=1:7, padding.top = 5, padding.bottom = 5, part = "all") %>%
  padding(2:4, padding.left = 10) %>%
  padding(6:8, padding.left = 10) %>%
  fontsize(size = 9, part = "all")  %>%
  ft_theme()
```

# Appendix {-}

```{r}
#| label: est-full-reply-logit
#| include: false

est_stock_logit <- stock %>%
  group_by(outcome) %>%
  nest() %>%
  mutate(
    fit1 = map(
      data,
      ~ glm(mod$unctrl, data = ., family = binomial())
    ),
    fit2 = map(
      data,
      ~ glm( mod$ctrl, data = ., family = binomial())
    )
  ) %>%
  pivot_longer(
    fit1:fit2,
    names_prefix = "fit",
    names_to = "model",
    values_to = "fit"
  )

add_tables <- tibble::tribble(
  ~term, ~"(1)", ~"(2)", ~"(3)", ~"(4)", ~"(5)", ~"(6)",
  "Covariates", "", "X", "", "X", "", "X"
)

attr(add_tables, "position") <- 7


tidy_custom.glm <- function(x, ...) {
  tbl <- tidy(x) %>%
    mutate(
      or = exp(estimate),
      lower.or = exp(estimate - 1.96 * std.error),
      upper.or = exp(estimate + 1.96 * std.error)
    )

  tbl
}

tbl_stock_logit <- est_stock_logit %>%
  pull(fit) %>%
  setNames(paste0("(", seq_len(length(.)), ")")) %>%
  modelsummary(
    estimate = "{or}",
    statistic = "[{lower.or}, {upper.or}]",
    coef_map = c(
      "treatB" = "Treatment B",
      "treatC" = "Treatment C",
      "treatD" = "Treatment D"
    ),
    add_rows = add_tables,
    gof_omit = "R2|AIC|BIC|RMSE|Std|FE|se_type",
    fmt = fmt_sprintf("%.3f")
  )
```

```{r}
#| label: tbl-full-reply-logit
#| tbl-cap: Logit Model of Reply and Intention

tbl_stock_logit %>%
  flextable::add_header_row(
    values = c("", "Reply", "Positive", "Negative"),
    colwidths = c(1, 2, 2, 2)
  ) %>%
  flextable::add_header_row(
    values = c("", "Intention"),
    colwidths = c(3, 4)
  ) %>%
  align(j = -1, align = "center", part = "all") %>%
  width(j = 1, 1) %>%
  fontsize(size = 9, part = "all") %>%
  ft_theme()
```

```{r}
#| label: est-full-coordination-logit
#| include: false

est_coordination_logit <- coordination %>%
  group_by(outcome) %>%
  nest() %>%
  mutate(
    fit1 = map(
      data,
      ~ glm(mod$unctrl, data = ., family = binomial())
    ),
    fit2 = map(
      data,
      ~ glm(mod$ctrl, data = ., family = binomial())
    )
  ) %>%
  pivot_longer(
    fit1:fit2,
    names_prefix = "fit",
    names_to = "model",
    values_to = "fit"
  )

add_tables <- tibble::tribble(
  ~term, ~mod1, ~mod2, ~mod3, ~mod4, ~mod5, ~mod6, ~mod7, ~mod8,
  "Covariates", "", "X", "", "X", "", "X", "", "X"
)

attr(add_tables, "position") <- 7

tbl_coordination_logit <- est_coordination_logit %>%
  pull(fit) %>%
  setNames(paste0("(", seq_len(length(.)), ")")) %>%
  modelsummary(
    estimate = "{or}",
    statistic = "[{lower.or}, {upper.or}]",
    coef_map = c(
      "treatB" = "Treatment B",
      "treatC" = "Treatment C",
      "treatD" = "Treatment D"
    ),
    add_rows = add_tables,
    gof_omit = "R2|AIC|BIC|RMSE|Std|FE|se_type",
    fmt = fmt_sprintf("%.3f")
  )
```

```{r}
#| label: tbl-full-coordination-logit
#| tbl-cap: Logit Model of Coordination

tbl_coordination_logit %>%
  flextable::add_header_row(
    values = c("", "CT", "Candidate", "Consent", "Donation"),
    colwidths = c(1, 2, 2, 2, 2)
  ) %>%
  align(j = -1, align = "center", part = "all") %>%
  width(j = 1, 1) %>%
  fontsize(size = 9, part = "all") %>%
  ft_theme()
```

<!-- Wild clustered bootstrap -->

```{r}
#| label: est-wildbs-young-reply
#| include: false

ate_bs <- stock %>%
  dplyr::filter(age < 30) %>%
  group_by(outcome, male) %>%
  nest() %>%
  mutate(
    treatB = map_dbl(data, ~ wildBS(
      update(mod$ctrl, . ~ . - male - age_demean),
      data = .x,
      cluster = RCTweek,
      H0 = "treatB = 0",
      B = 1000
    )),
    treatD = map_dbl(data, ~ wildBS(
      update(mod$ctrl, . ~ . - male - age_demean),
      data = .x,
      cluster = RCTweek,
      H0 = "treatD = 0",
      B = 1000
    ))
  )

tbl_stock_sub <- est_stock_sub %>%
  dplyr::filter(age_less30 == 1) %>%
  pull(est) %>%
  modelsummary(
    coef_map = c(
      "(Intercept)" = "Constant",
      "treatB" = "Treatment B",
      "treatC" = "Treatment C",
      "treatD" = "Treatment D"
    ),
    stars = c("***" = .01, "**" = .05, "*" = .1),
    fmt = 4,
    gof_omit = "R2|AIC|BIC|Log|Std|FE|se_type",
    add_rows = data.frame(rbind(
      c("Covariates", rep("X", 6)),
      c("B = 0", sprintf("%1.3f", ate_bs$treatB)),
      c("D = 0", sprintf("%1.3f", ate_bs$treatD))
    ))
  )
```

```{r}
#| label: tbl-wildbs-young-reply
#| tbl-cap: Linear Probability Model of Reply and Intentions among Young Males and Females

tbl_stock_sub %>%
  align(j = -1, align = "center", part = "all") %>%
  add_header_row(
    values = c("", "Reply", "Positive", "Negative", "Reply", "Positive", "Negative")
  ) %>%
  add_header_row(
    values = c("", "Young females", "Young males"),
    colwidths = c(1, 3, 3)
  ) %>%
  width(j=1, 1) %>%
  fontsize(size = 9, part = "all")  %>%
  ft_theme()
```

```{r}
#| label: est-wildbs-young-male-coordinate
#| include: false

ate_bs_coordination <- coordination %>%
  dplyr::filter(age < 30 & male == 1) %>%
  group_by(outcome) %>%
  nest() %>%
  mutate(
    treatB = map_dbl(data, ~ wildBS(
      update(mod$ctrl, . ~ . - male - age_demean),
      data = .x,
      cluster = RCTweek,
      H0 = "treatB = 0",
      B = 1000
    ))
  )

tbl_coordination_sub <- est_coordination_sub %>%
  dplyr::filter(age_less30 == 1 & male == 1) %>%
  pull(est) %>%
  modelsummary(
    coef_map = c(
      "(Intercept)" = "Constant",
      "treatB" = "Treatment B",
      "treatC" = "Treatment C",
      "treatD" = "Treatment D"
    ),
    stars = c("***" = .01, "**" = .05, "*" = .1),
    fmt = 4,
    gof_omit = "R2|AIC|BIC|Log|Std|FE|se_type",
    add_rows = data.frame(rbind(
      c("Covariates", rep("X", 4)),
      c("B = 0", sprintf("%1.3f", ate_bs_coordination$treatB))
    ))
  )
```

```{r}
#| label: tbl-wildbs-young-male-coordinate
#| tbl-cap: Linear Probability Model of Coordination among Young Males

tbl_coordination_sub %>%
  align(j = -1, align = "center", part = "all") %>%
  add_header_row(
    values = c("", "CT", "Candidate", "Consent", "Donation")
  ) %>%
  fontsize(size = 9, part = "all")  %>%
  width(j=1, 1) %>%
  ft_theme()
```

<!-- RCF -->

```{r}
#| label: est-t-test-covariate-int-rcf
#| include: false

cov_int_rcf <- predict_int_rcf %>%
  mutate(positive = if_else(effect > 0, 1, 0)) %>%
  select(age:BM_per_area, positive, pos, treat) %>%
  pivot_longer(age:BM_per_area, values_to = "value", names_to = "covariate") %>%
  group_by(pos, covariate, treat) %>%
  nest() %>%
  mutate(
    fit = map(data, ~ t.test(value ~ positive, data = .)),
    mean0 = map_dbl(fit, ~ .$estimate[1]),
    mean1 = map_dbl(fit, ~ .$estimate[2]),
    p = map_dbl(fit, ~ .$p.value)
  ) %>%
  select(-data, -fit) %>%
  pivot_wider(names_from = "treat", values_from = mean0:p) %>%
  select(pos, covariate, ends_with("B"), ends_with("C"), ends_with("D")) %>%
  arrange(pos)
```

```{r}
#| label: tbl-t-test-covariate-int-rcf
#| tbl-cap: Balance Test of Covariates Grouped By Predicted Treatment Effect

cov_int_rcf %>%
  as_grouped_data("pos") %>%
  as_flextable(hide_grouplabel = TRUE) %>%
  set_header_labels(
    covariate = "",
    "mean0_Message B" = "Negative",
    "mean1_Message B" = "Positive",
    "p_Message B" = "P-value",
    "mean0_Message C" = "Negative",
    "mean1_Message C" = "Positive",
    "p_Message C" = "P-value",
    "mean0_Message D" = "Negative",
    "mean1_Message D" = "Positive",
    "p_Message D" = "P-value"
  ) %>%
  add_header_row(
    values = c("", "Message B", "Message C", "Message D"),
    colwidths = c(1, 3, 3, 3)
  ) %>%
  align(j = -1, align = "center", part = "all") %>%
  colformat_double(j = -1, digits = 2) %>%
  padding(j=1:10, padding.top = 5, padding.bottom = 5, part="all") %>%
  padding(2:6, j = 1, padding.left = 10) %>%
  padding(8:12, j = 1, padding.left = 10) %>%
  padding(14:18, j = 1, padding.left = 10) %>%
  padding(20:24, j = 1, padding.left = 10) %>%
  width(j = -1, 0.7) %>%
  width(j = 1, 1.27) %>%
  fontsize(size = 9, part = "all")  %>%
  ft_theme()
```

```{r}
#| label: est-t-test-covariate-donate-rcf
#| include: false
#| eval: false

cov_donate_rcf <- predict_donate_rcf %>%
  mutate(positive = if_else(effect > 0, 1, 0)) %>%
  select(age:BM_per_area, positive, pos, treat) %>%
  pivot_longer(age:BM_per_area, values_to = "value", names_to = "covariate") %>%
  group_by(pos, covariate, treat) %>%
  nest() %>%
  mutate(
    fit = map(data, ~ t.test(value ~ positive, data = .)),
    mean0 = map_dbl(fit, ~ .$estimate[1]),
    mean1 = map_dbl(fit, ~ .$estimate[2]),
    p = map_dbl(fit, ~ .$p.value)
  ) %>%
  select(-data, -fit) %>%
  pivot_wider(names_from = "treat", values_from = mean0:p) %>%
  select(pos, covariate, ends_with("B"), ends_with("C"), ends_with("D")) %>%
  arrange(pos)
```

```{r}
#| label: tbl-t-test-covariate-donate-rcf
#| tbl-cap: Balance Test of Covariates Grouped By Predicted Treatment Effect (Donation)
#| eval: false

cov_donate_rcf %>%
  as_grouped_data("pos") %>%
  as_flextable(hide_grouplabel = TRUE) %>%
  set_header_labels(
    covariate = "",
    "mean0_Message B" = "Negative",
    "mean1_Message B" = "Positive",
    "p_Message B" = "P-value",
    "mean0_Message C" = "Negative",
    "mean1_Message C" = "Positive",
    "p_Message C" = "P-value",
    "mean0_Message D" = "Negative",
    "mean1_Message D" = "Positive",
    "p_Message D" = "P-value"
  ) %>%
  add_header_row(
    values = c("", "Message B", "Message C", "Message D"),
    colwidths = c(1, 3, 3, 3)
  ) %>%
  align(j = -1, align = "center", part = "all") %>%
  colformat_double(j = -1, digits = 2) %>%
  padding(j=1:10, padding.top = 5, padding.bottom = 5, part="all") %>%
  padding(2:6, j = 1, padding.left = 10) %>%
  padding(8:12, j = 1, padding.left = 10) %>%
  padding(14:18, j = 1, padding.left = 10) %>%
  padding(20:24, j = 1, padding.left = 10) %>%
  width(j = -1, 0.7) %>%
  width(j = 1, 1.27) %>%
  fontsize(size = 9, part = "all")  %>%
  ft_theme()
```