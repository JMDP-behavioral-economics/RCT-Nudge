---
title: |
  Only You:
  A Field Experiment of Text Message to Prevent Free-riding in Japan Marrow Donor Program
author:
  - name: Hiroki Kato
    affiliations:
      - 'Graduate School of Economics, Osaka University, Japan'
  - name: Fumio Ohtake
    affiliations:
      - 'Graduate School of Economics, Osaka University, Japan'
      - 'Center for Infectious Disease Education and Research (CiDER), Osaka University, Japan'
  - name: Saiko Kurosawa
    affiliations:
      - 'Department of Oncology, Ina Central Hospital, Japan'
  - name: Kazuhiro Yoshiuchi
    affiliations:
      - 'Graduate School of Medicine, Tokyo University, Japan'
  - name: Takahiro Fukuda
    affiliations:
      - 'Department of Hematopoietic Stem Cell Transplantation, National Cancer Center Hospital, Japan'
date: last-modified
date-format: '[Last Updated on] MMMM D, YYYY'
pdf-engine: lualatex
bibliography: biblio.bib
format:
  pdf:
    documentclass: bxjsarticle
    classoption:
      - pandoc
      - ja=standard
      - jafont=haranoaji
    papersize: a4
    fontsize: 11pt
    include-in-header:
      text: |
        \usepackage{authblk}
        \usepackage{siunitx}
        \usepackage{threeparttable, threeparttablex, multirow}
        \newcolumntype{d}{S[input-symbols = ()]}
        \usepackage{lscape}
    geometry:
      - top=30mm
      - left=30mm
      - right=30mm
      - bottom=30mm
    toc: false
    number-sections: true
    fig-format: pdf
    fig-pos: t
    template-partials:
      - tex/title.tex
  html:
    number-sections: true
    code-fold: true
    title-block-banner: true
  docx:
    number-sections: true
    toc: false
    fig-width: 15
    fig-height: 10
execute:
  echo: false
  warning: false
  error: false
  cache: false
  enabled: true
---

# Introduction {#sec-intro}

同種造血幹細胞移植は白血病などの血液病に対する最も再発率の低い治療法の一つである。この治療法では、(1)抗がん剤や放射線によって異常な細胞と健康な造血幹細胞を同時に殺し、(2)他者から提供された健康な造血幹細胞を移植する。骨髄移植（造血幹細胞移植）における要件は、ドナーのHLAと呼ばれる白血球の型が患者のHLAと一致していることである[^hapro]。ランダムに選ばれた二人のマッチング確率は1%未満である一方で、兄弟姉妹間で一致する可能性が最も高く、その確率は30%程度である。また、親子間のマッチング確率はかなり低い。親族の中に適合するドナーがいなければ、患者は近親者以外からドナーを探さなければならない。日本において、患者は一般的に日本骨髄バンク（JMDP）を介して非近親者のドナーを探すことになる。しかしながら、JMDPによるコーディネーションは移植に至るまで長時間を要し、登録患者の60%のみが移植を受けられない [@Hirakawa2018]。

[^hapro]: 近年、ハプロ移植と呼ばれる、半合致したHLAを持つ近親者間での移植が広がりつつある。加えて、母子をつなぐさい帯や胎盤に含まれる血液細胞の移植（さい帯血移植）も同様に人気になっている。骨髄移植と異なり、HLAが完全に合致していなくても、さい帯血移植は実施できる。

患者の生存確率を高めるためのドナープールに対する介入は二種類ある。第一に、潜在的なドナーの人数を増やして、マッチング確率を高めるような政策である。4人未満のドナーと合致する患者と比較して、200人以上のドナーと合致する患者の移植率は45%から74%に上昇する [@Hirakawa2018]。しかしながら、2000年から2015年にかけて潜在的なドナーの数は約二倍に増えたにもかかわらず、初回マッチング確率は5%程度しか増えていない [@Takanashi2016][^reason]。したがって、潜在的なドナーを増やすことの限界便益は小さいので、プールの規模を拡大することは非効率的であるだろう。

[^reason]: これは珍しいHLAの型を持つ新しいドナーの確率が低いからである。

第二の政策はドナープールに提供を断らない潜在的なドナーの比率を高めることである。この種の政策はドナープールの質に貢献するものである。@Hirakawa2018 は多くの移植コーディネーションはドナー側の都合により、コーディネーションの第一過程である確認検査の前に中断していることを示している（コーディネーションの過程は @sec-background を参照）。したがって、提供の意思の強い多くの潜在ドナーでできたプールを作ることは移植率を高めるだろう。また、ドナープールの質を改善する政策の限界便益はドナープールの規模を拡大する政策のそれよりも高いだろう。

そこで、本研究はドナープールの質を改善する政策の一つとして情報提供の効果を検証する。JMDPに登録した人がある患者の潜在的なドナーとなると、潜在ドナーはJMDPから適合通知を受け取る。そして、提供意思を示して適合通知に返信する潜在ドナーは移植のためのコーディネーションを受ける。我々はJMDPによって公開されている情報に基づいて適合通知に新規のメッセージを加えて、追加メッセージの効果を検証するフィールド実験を2021年9月から2022年2月にかけて実施した。介入メッセージは二つある。第一に、患者一人あたりの潜在的なドナーの数が少ないという情報（確率情報）である。患者一人につき複数の潜在的なドナーが同時にコーディネーションを受けるので、JMDPを通じた幹細胞移植は公共財の性質を持つ。したがって、同時にコーディネーションを受けている潜在的なドナーが多ければ多いほど、フリーライドするインセンティブが強くなる。第一のメッセージはコーディネーション進行中のドナーの数に関する過剰な期待によって生じるただ乗り行動を妨げることを目的としている。もう一つのメッセージはJMDPに登録した患者の半分しか移植を受けられないというもの（利他情報）である。この情報は幹細胞提供という利他行動の価値を高めることを目的としている。また、このメッセージは候補となるドナーが早く見つけられるほど、移植率を高められることも明記して、適合通知に早く返信してもらうことを目的としている。

我々はJMDPに実験機関に適合通知を受け取った人に関するコーディネーション過程のデータの提供を依頼し、情報を提供することの効果を分析した。我々のフィールド実験は情報提供の効果は異質的であることを示している。確率情報は移植成績がよいにもかかわらず適合通知への返信率が低い若年層の男性に効果的であるが、利他情報は若年男性に効果的でなかった。さらに、二つの情報を同時に提供する介入も、利他情報に強く影響を受けてしまうために、効果的でなかった。

<!-- Allogenic stem cell transplantation is one of the treatments with the lowest recurrence rate for blood diseases such as leukemia. In this treatment method, (1) diseased cells and healthy hematopoietic stem cells are simultaneously killed by anticancer drugs and radiation, and (2) healthy hematopoietic stem cells donated by another person are transplanted. One requirement for bone marrow transplantation (hematopoietic stem cell transplantation) is that the donor's white blood cell type, called HLA, matches the patient's HLA.[^hapro] While the matching probability between two random people is less than 1%, the most likely HLA match is between siblings, with a probability of approximately 30%. The matching probability between parents and children is very low. If there is no matched donor among blood relatives, the patient must seek a donor from an unrelated person. In Japan, the patient generally seeks unrelated donors through the Japan Marrow Donor Program (JMDP). However, coordination by the JMDP results in a long transplant process, and only 60% of registered patients receive a transplant [@Hirakawa2018].

[^hapro]: Recently, transplants between blood relatives with semi-matched HLA, called haploidentical transplants, have become widespread. In addition, the transplantation of blood cells contained in the umbilical cord and placenta connecting mother and child (cord blood transplant) has also become popular. Unlike bone marrow transplants, cord blood transplants can be performed even without the requirement of a perfect HLA match.

There are two types of policies for the donor pool to increase patient survival. The first type is to increase the number of potential donors, which increases the matching probability. Compared to when the patient matches fewer than four donors, when the patient matches more than 200 donors, the patient's transplant rate increases from 45% to 74% [@Hirakawa2018]. However, while the number of potential donors for JMDP has roughly doubled between 2000 and 2015, the probability of first-time matching has only increased by about 5% [@Takanashi2016].[^reason] In other words, increasing the pool size would be ineffective because the marginal benefit of increasing the number of potential donors is small.

[^reason]: This is because the probability of a new member with a rare HLA type is low.

The second type is to increase the proportion of people in the donor pool who are less likely to refuse to donate. This type of measure contributes to the quality of the donor pool. @Hirakawa2018 shows that many coordinations are interrupted before their first step, the confirmatory typing, due to the donor side reasons (see the @sec-background section for the coordination flow). Therefore, creating a pool with many potential donors who are willing to donate would increase the transplant rate. The marginal benefit of measures that improve the quality of the donor pool should be higher than that of measures that increase the size of the donor pool.

Then, this study examines the effectiveness of information provision as one policy improving the quality of the donor pool. When a person registered with the JMDP becomes a potential donor for a patient, the potential donor receives a compatibility notice from the JMDP. The potential donors who respond to the notification by indicating a willingness to donate then take coordination for transplantation. We added a message to the compatibility notice based on information published by the JMDP and conducted a field experiment from September 2021 to February 2022 to test the effect of the added message. We asked the JMDP to provide data on the coordination process (including whether or not they responded to the notification and their willingness to donate) for those who received the compatibility notice during the experimental period and analyze the effect of providing information.

There are two intervention messages. One is information that there are few potential donors per patient registered in the JMDP. Stem cell donation through JMDP is a public good since multiple potential donors per patient take coordination simultaneously. Thus, potential donors have the incentive to free-ride. The first message prevents potential donors from free-riding behavior caused by the over-estimated expectation about the number of other ongoing potential donors. Another message is that only about half of the patients registered with the JMDP receive transplants. This information aims to increase the value of the altruistic behavior of stem cell donation. Our field experiment shows that information about the small number of potential donors per patient encourages young males to reply to the compatibility notice and indicate their willingness to donate. -->

<!-- この研究は日本に限らず他国の類似する骨髄バンクにおける施策へ貢献するものである。JMDPでは、若年男性の移植成績が良いにも関わらず、ドナー都合によるコーディネーションの中断率が高い[@Hirakawa2018]。同様の問題はXXXXでも生じている。我々のフィールド実験はこの問題を解決するための一つの施策を提示できる。

また、この研究は経済学における一連の公共財研究にも貢献している。標準的な経済学は、公共財は自身の努力とは無関係に便益を受けられるという性質を持つので、自身がコストをかけて努力するインセンティブがなく、ただ乗り行動が生じることを指摘している。 -->


```{r}
#| label: library
#| include: false
#| vscode: {languageId: r}

library(here)
library(tidyverse)
library(lubridate)
library(estimatr)
library(fixest)
library(grf)
library(modelsummary)
library(kableExtra)
library(flextable)
library(officer)
library(RCTtoolbox)
library(patchwork)
lapply(list.files(here("R/func"), "r", full.names = TRUE), source)

options(
  knitr.table.format = "markdown",
  kableExtra.auto_format = FALSE,
  modelsummary_stars_note = FALSE,
  modelsummary_factory_default = "flextable",
  modelsummary_factory_html = "kableExtra",
  modelsummary_factory_latex = "kableExtra",
  modelsummary_factory_word = "flextable"
)

tidy_custom.lm_robust <- function(x, ...) broom::tidy(x)
```


```{r}
#| label: outcome-label
#| include: false
#| vscode: {languageId: r}

root <- "D:/JMDPフィールド実験"

outcome_label <- list(
  reply = "Reply",
  positive = "Positive intention",
  negative = "Negative intention",
  test = "CT",
  candidate = "Candidate",
  consent = "Consent",
  donate = "Donation"
)
```

# Field Experiment {#sec-experiment}
## Background: Coordination Process of JMDP {#sec-background}


To promote an understanding of the timing of interventions in our field experiment, we provide an overview of the coordination process leading up to the donation of stem cells by a potential donor registered with the JMDP. First, when a potential donor matches a patient registered with the JMDP, the JMDP office sends the potential donor the compatibility notice requesting stem cell donation.[^SNS] The potential donor responds to the notification by filling out a medical questionnaire and indicating the willingness to donate.

[^SNS]: JMDP also sends the potential donor an SMS message informing that the JMDP sends the compatibility notice.

After that, the coordination for the transplant starts. The potential donor undergoes the confirmatory typing within approximately one month. In this step, the coordinator explains in detail the donation procedure (bone marrow collection and peripheral blood stem cell collection) and investigates the intentions of the potential donor and family. At this time, the potential donor can choose the collection method. In addition, the coordinating physician conducts an interview, medical examination, and general blood tests to determine the presence of infection and blood type. These tests examine whether the potential donor meets the criteria set by the JMDP.

Patients can proceed with coordination with up to 10 potential donors at the same time. The patient's physician selects the most suitable candidate from potential donors who take the confirmatory typing. Importantly, the potential donor does not know how many other donors the matched patient coordinates with. Nor can a potential donor obtain this information from the coordinator or coordinating physician.

The candidate needs to make a final consent after receiving explanations from the coordinator and coordinating physician. At this time, a representative of the donor's family must also consent to the collection. In addition, the candidate cannot change his/her intention after that. After giving final consent, the first candidate is hospitalized for approximately one week to take preoperative testing and prepare for collection. After this, the donor undergoes a procedure to collect the stem cells. The time between the confirmation test and collection is approximately 3-4 months.

## Experimental Design

![Intervention Messages](image/intervention.png){#fig-intervention}

Our intervention is the content of the compatibility notice in which the JMDP requests stem cell donations from potential donors. The @fig-intervention shows our intervention. Before the intervention, the compatibility notice states that the potential donor should return within seven days indicating to donate and completing a medical questionnaire. One of the materials enclosed along with the notification is a handbook that describes the coordination process, which we overview in the previous subsection.

We added two messages to the compatibility notice to facilitate coordination (@fig-intervention).[^pressure] The probability message highlights the small number of potential donors per patient registered with the JMDP. This message prevents overestimation of beliefs about the number of other ongoing potential donors and may discourage free-riding behavior in stem cell donation.

[^pressure]: When having made intervention messages, we have taken appropriate care not to put undue pressure on potential donors. First, we avoid messages that sound like a plea. Second, we use only publicly available information from the JMDP. Third, we explain the risks of transplantation as usual.

The patient message emphasizes that only half of the patients can receive a transplant through the JMDP. This message aims to correct the perception that patients are saved without the cooperation and to stimulate altruism in potential donors. Furthermore, emphasizing the importance of shortening the coordination time encourages early replies to the compatibility notice.

We made four experimental arms to estimate the effects of the two intervention messages. Experimental arm A sends the standard compatibility notice without intervention messages (control group). Experimental arms B and C receive the probability message and the patient message, respectively. In addition, to test the negative effect of cognitive load due to information overload, we also made an experimental arm D adding two intervention messages to one compatibility notice.

```{r}
#| label: read-schedule-data
#| include: false
#| vscode: {languageId: r}

schedule <- read_csv(here(root, "RCT-schedule.csv")) %>%
  mutate(
    my = paste0(month, "/", year - 2000),
    my = factor(
      my,
      levels = c("9/21", "10/21", "11/21", "12/21", "1/22", "2/22"),
      labels = c("Sep 21", "Oct 21", "Nov 21", "Dec 21", "Jan 22", "Feb 22")
    ),
    week = factor(week, levels = 1:4, labels = paste("Week", 1:4))
  ) %>%
  dplyr::select(week, my, treat) %>%
  pivot_wider(values_from = treat, names_from = my)
```

```{r}
#| label: tbl-assignment
#| tbl-cap: Assignment Schedule
#| vscode: {languageId: r}

flextable(schedule) %>%
  align(j = -1, align = "center", part = "all") %>%
  padding(j=1:7, padding.top = 5, padding.bottom = 5, part="all") %>%
  fontsize(size = 9, part = "all")  %>%
  ft_theme()
```

Our experimental subjects are 11,154 potential donors to whom the JMDP sent the compatibility notice between September 2021 and February 2022. The assignment of experimental groups is cluster-randomized based on a week because we preserve as much randomness as feasible by the JMDP office. We assigned four experimental groups to balance on week and month to remove week/month fixed effects. We summarize the assignment schedule in @tbl-assignment.

## Data and Empirical Strategy

```{r}
#| label: read-experiment-data
#| include: false
#| vscode: {languageId: r}

rawdt <- read_csv(here(root, "shaped.csv"), locale = locale(encoding = "cp932"))

use <- rawdt %>%
  dplyr::filter(ongoing == 0) %>%
  mutate(
    treat = factor(treat, levels = LETTERS[1:4]),
    plan_two_methods = if_else(plan_method == "BM/PB", 1, 0)
  )
```

```{r}
#| label: balance-test-ongoing
#| eval: false
#| vscode: {languageId: r}

lm_robust(
  ongoing ~ treat,
  data = rawdt,
  cluster = RCTweek,
  se_type = "CR2"
) %>%
{
  f <- summary(.)$fstatistic[1]
  numdf <- summary(.)$fstatistic[2]
  dendf <- summary(.)$fstatistic[3]
  p <- pf(f, numdf, dendf, lower.tail = FALSE)

  sprintf("F-value = %1.3f; p-value = %1.3f", f, p)
}
```

We received the coordination data maintained by the JMDP at the end of June 2022. The observation unit is the experimental subject. As individual attributes, the data record gender, age, number of past coordination, and region of residence (at the prefectural level). For the coordination process, the data records whether or not to reach each step (reply to the compatibility notice, the confirmatory typing, the candidate selection, the final consent, and the collection). We use these variables as outcome variables. In particular, for replies to the compatibility notice, the data additionally record the number of days of reply and the intention to donate. If the coordination was interrupted, the data record the reason for the interruption in three categories (patient reasons, reasons other than donor's health, and donor's health reasons). In analysis, we use 11,049 individuals who reside in Japan and whose coordination has been completed.[^exclude]

[^exclude]: one person resided abroad. There were also 104 persons for whom coordination was in progress when we received the data. The proportion of people with ongoing coordination is well balanced across experimental arms (F-value, p-value = $0.964$).

As additional data, we use the list of hospitals published by the JMDP on its website. In addition to hospital addresses, this data includes whether bone marrow (BM) collection and peripheral blood stem cell (PBSC) collection are available. We aggregate this data at the prefectural level, calculate the number of hospitals per 10 square kilometers, and merge it and the coordination data using the prefecture as a merge key. We consider this variable as the traveling cost of coordination and donation.

```{r}
#| label: experiment-summary
#| include: false

summary_stat <- use %>%
  select(
    male,
    age,
    coordinate,
    hospital_per_area,
    PB_per_area,
    BM_per_area,
    treat
  ) %>%
  group_by(treat) %>%
  summarize_all(mean) %>%
  mutate_at(vars(-treat), list(~sprintf("%1.3f", .))) %>%
  pivot_longer(-treat, names_to = "vars", values_to = "mean") %>%
  pivot_wider(names_from = "treat", values_from = "mean")

balance_p <- use %>%
  select(
    male,
    age,
    coordinate,
    hospital_per_area,
    PB_per_area,
    BM_per_area,
    treat,
    RCTweek
  ) %>%
  pivot_longer(male:BM_per_area, values_to = "value", names_to = "vars") %>%
  group_by(vars) %>%
  do(est = lm_robust(
    value ~ treat,
    clusters = RCTweek,
    se_type = "CR2",
    data = .
  )) %>%
  summarize(
    vars = vars,
    f = summary(est)$fstatistic[1],
    numdf = summary(est)$fstatistic[2],
    dendf = summary(est)$fstatistic[3],
    p = sprintf("%1.3f", pf(f, numdf, dendf, lower.tail = FALSE))
  ) %>%
  select(vars, p)

balance_test <- summary_stat %>%
  dplyr::left_join(balance_p, by = "vars") %>%
  mutate(type = "C. Balance Test") %>%
  mutate(vars = recode(
    vars,
    "male" = "Male (=1)",
    "age" = "Age",
    "coordinate" = "Number of past coordinations",
    "hospital_per_area" = "Number of listed hospitals",
    "PB_per_area" = "Number of hospitals listed with PBSC collection",
    "BM_per_area" = "Number of hospitals listed with BM collection"
  ))

size <- with(use, sprintf("%1d", table(treat))) %>%
  {
    tribble(
      ~vars, ~A, ~B, ~C, ~D, ~p, ~type,
      "Standard notification", "X", "X", "X", "X", "", "A. Interventions",
      "Probability message", "", "X", "", "X", "", "A. Interventions",
      "Patients message", "", "", "X", "X", "", "A. Interventions",
      "N", .[1], .[2], .[3], .[4], "", "B. Sample Size"
    )
  }

tbl_experiment_summary <- bind_rows(size, balance_test)
```

```{r}
#| label: tbl-experiment-summary
#| tbl-cap: Overview of Field Experiment
#| output: asis
#| vscode: {languageId: r}

tbl_experiment_summary %>%
  as_grouped_data("type") %>%
  as_flextable(hide_grouplabel = TRUE) %>%
  set_header_labels(vars = "", p = "F-test, p-value") %>%
  add_header_row(values = c("", "Experimental Arms", ""), colwidths = c(1, 4, 1)) %>%
  add_footer_lines(paste(
    "Notes: Balance test regresses a covariate on treatment dummies",
    "and test a null hypothesis that all coefficients are zero.",
    "We use the clustered standard error with the CR2 adjustment for inference",
    "(cluster unit is an experimental week)."
  )) %>%
  align(j = -1, align = "center", part = "all") %>%
  padding(j=1:6, padding.top=5, padding.bottom = 5, part = "all") %>%
  padding(2:4, padding.left = 10) %>%
  padding(6, padding.left = 10) %>%
  padding(8:13, padding.left = 10) %>%
  width(j = 1, 2) %>%
  fontsize(size = 9, part = "all")  %>%
  ft_theme()
```

@tbl-experiment-summary summarizes the field experiments. Panel A shows the interventions for each experimental group, and Panel B shows the sample size for each experimental group. Panel C shows the balance test, which examines whether the randomization is successful. Since most covariates are well-balanced across groups, the clustered assignment is approximately random. However, potential donors in experimental groups C and D may be younger than those in experimental groups A and B (F-test, p-value = $0.096$).

Our target parameter is the overall population average treatment effect, which can be identified by the difference in means due to exogenous treatment assignment. In addition to the difference in means, we estimate a linear probability model to remove month/week fixed effects and to increase the precision of inference by adding covariates. Our estimation model for individual $i$ who received the compatibility notice in a week $w$ of month $m$ is as follows:

$$
  Y_{imw} =
  \beta_1 \cdot \text{B}_{mw} + \beta_2 \cdot \text{C}_{mw}
  + \beta_3 \cdot \text{D}_{mw}
  + X'_i \gamma + \lambda_m + \theta_w + u_{imw},
$$

where $X_i$ is the individual attribute vector and $\lambda_m$ and $\theta_w$ are the week and month dummy variables, respectively. We use standard errors clustered at the experimental week level, a unit of randomization.

For inference, we use standard errors clustered by experimental week, which is the unit of randomization. If the distribution of the treatment variable is skewed (the skewness of the binary variable indicating experimental arm B is approximately 1), the standard clustered standard errors will be small, which leads to an excessively low coverage probability of the confidence interval. Therefore, following the recommendation of @Imbens2016, we adjust and report standard errors and degrees of freedom by CR2.[^true-bias]

[^true-bias]: If the proportion of clusters sampled from the population is large and the variance of the within-cluster average treatment effect is large, the true cluster standard errors can be extremely conservative [@Abadie2023]. The CR2 adjustment can remove bias in the estimation of cluster standard errors but cannot correct for bias in the true cluster standard errors. Therefore, it should be interpreted with caution.

# Experimental Results {#sec-result}

```{r}
#| label: balance-test-exogeneous-stop-reply
#| eval: false

lm_robust(
  exg_stop_reply ~ treat,
  data = use,
  cluster = RCTweek,
  se_type = "CR2"
) %>%
{
  f <- summary(.)$fstatistic[1]
  numdf <- summary(.)$fstatistic[2]
  dendf <- summary(.)$fstatistic[3]
  p <- pf(f, numdf, dendf, lower.tail = FALSE)

  sprintf("F-value = %1.3f; p-value = %1.3f", f, p)
}
```

```{r}
#| label: create-stock-data
#| include: false
#| vscode: {languageId: r}

stock <- use %>%
  dplyr::filter(exg_stop_reply == 0) %>%
  rename(positive = intention) %>%
  mutate(
    negative = reply * (1 - positive),
    age_demean = age - mean(rawdt$age),
  ) %>%
  select(reply, positive, negative, everything()) %>%
  pivot_longer(reply:negative, names_to = "outcome") %>%
  mutate(outcome = factor(
    outcome,
    levels = unlist(names(outcome_label)[1:3]),
    labels = unlist(outcome_label[1:3])
  ))
```

## Effects on Reply and Intention {#sec-reply}

To begin, we estimate the effect of our interventions on reply, which is the most likely to reflect the potential donor's intention. The outcome variable for replying is a dummy variable that takes one if the potential donor replies to the compatibility notice regardless of donor intention. The response rate is $88.35$% in the control arm (experimental arm A).

We decompose the message effect on response to the notification into two parts. The first is the effect on replying with a positive intention. For estimation, the outcome variable is a dummy variable that takes one if the potential donor replied to the notice and indicated the willingness to donate. The second is the effect on replying with a negative intention. The outcome variable is a dummy variable that takes one if the potential donor replied to the notice and did not indicate the willingness to donate. When estimating these effects, we include non-responders in the sample, coding their outcomes as 0. Since the sum of the two outcome variables for the intention to donate is always equal to the dummy variable for the reply, the sum of the effects on the positive and negative intentions is always the effect on replying. The proportion of replying with positive intention is $55.33$%, while the proportion of replying with negative intention is $33.03$% in the control arm. Thus, $62.63$% of potential donors who replied to the compatibility notice were willing to donate.

The coordination may be interrupted by the patient before potential donors reply. Since this case occurs independently of the potential donor's intention, we exclude it from the sample in our analysis. We exclude $0.5$--$0.7$% of each experimental group, and the proportions are well balanced across groups (F-test, p-value=$0.301$).

```{r}
#| label: est-full-reply
#| include: false

mod <- list(
  unctrl = value ~ treat,
  ctrl = value ~ treat + age_demean + I(age_demean^2) + male + coordinate +
    hospital_per_area + PB_per_area + BM_per_area + factor(month) + factor(week)
)

est_stock <- stock %>%
  group_by(outcome) %>%
  nest() %>%
  mutate(
    fit1 = map(
      data,
      ~ lm_robust(
        mod$unctrl,
        data = .,
        cluster = RCTweek,
        se_type = "CR2"
      )
    ),
    fit2 = map(
      data,
      ~ lm_robust(
        mod$ctrl,
        data = .,
        cluster = RCTweek,
        se_type = "CR2"
      )
    )
  ) %>%
  pivot_longer(
    fit1:fit2,
    names_prefix = "fit",
    names_to = "model",
    values_to = "fit"
  )

ctrl_avg <- stock %>%
  dplyr::filter(treat == "A") %>%
  group_by(outcome) %>%
  summarize(mean = sprintf("%1.4f", mean(value)))

add_table <- tibble::tribble(
  ~term, ~"(1)", ~"(2)", ~"(3)", ~"(4)", ~"(5)", ~"(6)",
  "Control average", ctrl_avg$mean[1], ctrl_avg$mean[1],
  ctrl_avg$mean[2], ctrl_avg$mean[2],
  ctrl_avg$mean[3], ctrl_avg$mean[3],
  "Covariates", "", "X", "", "X", "", "X"
)

attr(add_table, "position") <- 7:8

tbl_est_stock <- est_stock %>%
  pull(fit) %>%
  setNames(paste0("(", seq_len(length(.)), ")")) %>%
  modelsummary(
    coef_map = c(
      "treatB" = "Treatment B",
      "treatC" = "Treatment C",
      "treatD" = "Treatment D"
    ),
    stars = c("***" = .01, "**" = .05, "*" = .1),
    fmt = 4,
    gof_omit = "R2|AIC|BIC|Log|Std|FE|se_type",
    add_rows = add_table,
  )
```

```{r}
#| label: tbl-full-reply
#| tbl-cap: Linear Probability Model of Replay and Intention
#| vscode: {languageId: r}

tbl_est_stock %>%
  add_header_row(
    values = c("", "Reply", "Positive", "Negative"),
    colwidths = c(1, 2, 2, 2)
  ) %>%
  add_header_row(
    values = c("", "Intention"),
    colwidths = c(3, 4)
  ) %>%
  align(j = -1, align = "center", part = "all") %>%
  add_footer_lines(paste(
    "Notes: * p < 0.1, ** p < 0.05, *** p < 0.01.",
    "The clustered standard errors with the CR2 adjustment",
    "are reported in parenetheses (cluster unit is an experimental week).",
    "Covariates are gender, squared polynomial of (demeaned) age,",
    "number of past coordinations,",
    "number of hospitals per 10 square kilometers,",
    "number of hospitals with PBSC collection per 10 square kilometers,",
    "number of hospitals with BM collection per 10 square kilometers,",
    "month dummies, and week dummies."
  )) %>%
  width(j = 1, 1) %>%
  fontsize(size = 9, part = "all")  %>%
  ft_theme()
  # kableExtra::kable_styling() %>%
  # kableExtra::add_header_above(c(
  #   " " = 1, "Reply" = 2, "Positive" = 2, "Negative" = 2
  # )) %>%
  # kableExtra::add_header_above(c(
  #   " " = 3, "Intention" = 4
  # )) %>%
  # kableExtra::footnote(
  #   paste(
      # "* p < 0.1, ** p < 0.05, *** p < 0.01.",
      # "Standard errors clustered by experimental weeks",
      # "are reported in parentheses.",
      # "Covariates are gender, squared polynomial of (demeaned) age,",
      # "number of past coordinations,",
      # "number of hospitals per 10 square kilometers,",
      # "number of hospitals with PBSC collection per 10 square kilometers,",
      # "number of hospitals with BM collection per 10 square kilometers,",
      # "month dummies, and week dummies."
  #   ),
  #   threeparttable = TRUE
  # )
```

@tbl-full-reply is the estimation results of the linear probability model. Odd columns use only the experimental arm dummies as an explanatory variable, whereas even columns additionally control for individual attributes and month and week fixed effects. The results show that all experimental arms, with or without covariates or month/week fixed effects, have no statistically significant effects on overall replies or replies with positive or negative intentions. We estimated a logit model as robustness ( @full-reply-logit ) and obtained the same results (95 percent confidential interval of odds ratio includes 1).

```{r}
#| label: est-subsample-reply
#| include: false

est_stock_sub <- stock %>%
  mutate(age_less30 = if_else(age < 30, 1, 0)) %>%
    group_by(outcome, male, age_less30) %>%
    nest() %>%
    mutate(est = map(data, ~ lm_robust(
      update(mod$ctrl, . ~ . - male - age_demean),
      cluster = RCTweek,
      se_type = "CR2",
      data = .x
    )))

plotdt_stock_sub <- est_stock_sub %>%
  mutate(
    fit = map(est, tidy),
    fit = map(fit, ~ subset(.x, str_detect(term, "treat"))),
    fit = map(fit, ~ dplyr::select(.x, -outcome)),
    N = map_chr(est, ~ paste("N =", nobs(.x))),
    mean = map_dbl(data, ~ with(subset(., treat == "A"), mean(value))),
    mean = sprintf("Control avg = %1.3f", mean)
  ) %>%
  select(-data, -est) %>%
  unnest(cols = fit) %>%
  mutate(
    pos = paste0(male, age_less30),
    pos = factor(
      pos,
      levels = c("01", "00", "11", "10"),
      labels = c(
        "Female\u00d7\nAge<30",
        "Female\u00d7\n30\u2264Age",
        "Male\u00d7\nAge<30",
        "Male\u00d7\n30\u2264Age"
      )
    ),
    term = str_replace(term, "treat", ""),
    term = factor(term, LETTERS[2:4])
  )

text <- plotdt_stock_sub %>%
  select(male, age_less30, pos, N, mean) %>%
  distinct()
```

```{r}
#| label: fig-subsample-reply
#| fig-cap: 'Effect on Reply and Intentions by Gender and Age Group. Note: These plots show the average effect (and associated 95% confidential interval) on each outcome by gender and age group. We use clustered standard errors with the CR2 adjustment (cluster unit is experimental week). We control number of past coordinations, number of hospitals per 10 square kilometers, number of hospitals with PBSC collection per 10 square kilometers, number of hospitals with BM collection per 10 square kilometers, month dummies, and week dummies.'
#| vscode: {languageId: r}

plot_list <- unique(plotdt_stock_sub$outcome) %>%
  purrr::map(function(x) {
    subset(plotdt_stock_sub, outcome == x) %>%
      ggplot(aes(x = pos, y = estimate)) +
      geom_hline(aes(yintercept = 0), linetype = 2) +
      geom_point(
        aes(color = term, shape = term),
        size = 3, position = position_dodge(0.5)
      ) +
      geom_errorbar(
        aes(ymin = conf.low, ymax = conf.high, color = term),
        position = position_dodge(0.5),
        width = 0
      ) +
      geom_text(
        aes(y = -0.15, label = N),
        data = subset(text, outcome == x),
        color = "black"
      ) +
      geom_text(
        aes(y = -0.175, label = mean),
        data = subset(text, outcome == x),
        color = "black"
      ) +
      scale_y_continuous(
        breaks = seq(-0.2, 0.2, by = 0.05), limits = c(-0.2, 0.2)
      ) +
      labs(
        title = paste("Outcome:", x),
        x = "Subset",
        y = "Estimated Effects (95%CI)",
        color = "Treatment", shape = "Treatment"
      ) +
      simplegg()
  })

wrap_plots(plot_list, ncol = 2) +
  plot_layout(guides = "collect") &
  theme(legend.position = "bottom")
```

Next, to test the heterogeneity of message effects, we divide the sample into four subsets by gender and age group (less than 30 or not) and estimate the message effects in each sub-group. @fig-subsample-reply is the coefficient plot. As a result, experimental arm B, which added only the probability message, statistically significantly increases the reply rates with the intention to donate by about 10 percentage points or $25.91$% (the control average is $38.6$%) for young men. Since experimental arm B reduces the rate of replies without donating intentions, the effect of this group on the overall reply rate is 6 percentage points (statistically significant at 10% level), which is smaller than its effect on replies with donating intentions.[^wild-bs] Given that young male donors have lower donation intentions than the other gender-age group despite their better transplant outcomes, the probability message improves the efficiency of transplant coordination. Note that, among the other gender and age groups, our intervention has no significant effect on replies or intentions.

[^wild-bs]: Instead of cluster standard errors with the CR2 adjustment, we compute p-values by the wild cluster bootstrap method [@Cameron2008] and find similar results. See @tbl-wildbs-youngmen-reply.

## Random Causal Forest {#sec-rcf}

```{r}
#| label: rcf-int
#| include: false

covariate <- ~ 0 + male + age + coordinate +
  hospital_per_area + PB_per_area + BM_per_area

Y <- use$intention
X <- model.matrix(covariate, data = use)
W <- use$treat
G <- use$RCTweek

subset_cond <- list(
  X[, "male"] == 0 & X[, "age"] < 30,
  X[, "male"] == 0 & X[, "age"] >= 30,
  X[, "male"] == 1 & X[, "age"] < 30,
  X[, "male"] == 1 & X[, "age"] >= 30
)


int_rcf <- multi_arm_causal_forest(X, Y, W)
int_tau <- predict(int_rcf, X)
```

To dig deeper into the heterogeneity of intervention effects, we use a fully nonparametric method to test for heterogeneous effects called random causal forest (RCF) [@Davis2017; @Athey2019]. This method divides the sample by combinations of covariates and estimates treatment effects within each subsample. A set of subsamples is determined to maximize the variance of the treatment effect [@Athey2016]. This method produces predicted treatment effects, which is a function of the covariates.[^tech-detail]

[^tech-detail]: See @Wager2018 and @Athey2019a for technical and implementation details.

```{r}
#| label: fig-rcf-int-boxplot
#| fig-cap: 'Boxplot of Predicted Treatment Effects by Gender and Age. Notes: Blue fitted line represents GAM smoothing. Covariates are gender, age, number of past coordinations, number of hospitals per 10 square kilometers, number of hospitals with PBSC collection per 10 square kilometers and number of hospitals with BM collection per 10 square kilometers.'

predict_int_rcf <- data.frame(X) %>%
  cbind(int_tau$predictions) %>%
  rename(
    effect_B = `B - A.Y.1`,
    effect_C = `C - A.Y.1`,
    effect_D = `D - A.Y.1`
  ) %>%
  pivot_longer(
    effect_B:effect_D,
    names_to = c(".value", "treat"),
    names_sep = "_"
  ) %>%
  mutate(
    male = factor(male, labels = c("Females", "Males")),
    treat = factor(treat, labels = paste("Message", LETTERS[2:4]))
  )

predict_int_rcf %>%
  ggplot(aes(x = age, y = effect)) +
  geom_hline(aes(yintercept = 0), linetype = 2) +
  geom_boxplot(aes(group = age)) +
  stat_smooth(se = FALSE, color = "blue") +
  facet_grid(treat ~ male) +
  labs(x = "Age", y = "Predicted treatment effect") +
  simplegg()
```

```{r}
#| include: false

predict_int_rcf %>%
  dplyr::filter(male == "Males") %>%
  dplyr::filter(30 < age & age <= 40) %>%
  dplyr::filter(treat == "Message B") %>%
  mutate(high = if_else(effect >= 0.1, 1, 0)) %>%
  group_by(high) %>%
  summarize_at(vars(coordinate:BM_per_area), list(~ mean(.)))

predict_int_rcf %>%
  dplyr::filter(45 < age) %>%
  dplyr::filter(treat == "Message C") %>%
  mutate(positive = if_else(effect >= 0, 1, 0)) %>%
  group_by(positive) %>%
  summarize_at(vars(coordinate:BM_per_area), list(~mean(.)))
```

@fig-rcf-int-boxplot plots the predicted treatment effect on replies with positive intention for each experimental group against age. Notably, for all men under age 25, the effect for experimental group B is positive. As a result, the RCF shows the average treatment effect of 12.1 percentage points for experimental group B among men under age 30, which is similar to the results of the subsample analysis of the linear regression analysis presented in @fig-subsample-reply (see @tbl-rcf-int-cate). For a small fraction of men aged 30~40, the effect of experimental group B is more than 10 percentage points. We find that such men live in places with relatively more hospitals and have a lower traveling cost of coordination and donation.

The effects of experimental group C, with only altruistic messages added, are largely heterogeneous. For women in their early 30s, most treatment effects are negative. For men and women in their late 40s and older, the median value of treatment effect is positive but widely distributed. Surprisingly, we find that, for men and women in this age group, those for whom experimental group C has a positive effect live in areas with relatively few hospitals (high traveling costs).

```{r}
#| label: rcf-int-cate-corr
#| include: false

int_tau_pred <- data.frame(int_tau$predictions[, , 1])
colnames(int_tau_pred) <- c("B", "C", "D")

est_tau_corr1 <- subset_cond %>%
  purrr::map(~ lm_robust(
    D ~ I(B + C),
    data = subset(int_tau_pred, .),
    se_type = "HC0"
  ))

est_tau_corr2 <- subset_cond %>%
  purrr::map(~ lm_robust(
    D ~ B + C,
    data = subset(int_tau_pred, .),
    se_type = "HC0"
  ))


tbl_tau_corr <- list(est_tau_corr1, est_tau_corr2) %>%
  purrr::flatten() %>%
  setNames(paste0("(", seq_len(length(.)), ")")) %>%
  modelsummary(
    coef_map = c(
      "(Intercept)" = "Constant",
      "I(B + C)" = "B + C",
      "B" = "B",
      "C" = "C"
    ),
    statistic = c("({std.error})", "conf.int"),
    stars = c("***" = .01, "**" = .05, "*" = .1),
    fmt = 4,
    gof_omit = "R2|AIC|BIC|Log|Std|FE|se_type|RMSE"
  )
```

```{r}
#| label: tbl-rcf-int-cate-corr
#| tbl-cap: Correlation of Predicted Tratment Effects

tbl_tau_corr %>%
  add_header_row(
    values = c("", rep(c("Age<30", "30\u2264Age", "Age<30", "30\u2264Age"), 2))
  ) %>%
  add_header_row(
    values = c("", rep(c("Females", "Males"), 2)),
    colwidths = c(1, 2, 2, 2, 2)
  ) %>%
  align(j = -1, align = "center", part = "all") %>%
  add_footer_lines(paste(
    "Notes: * p < 0.1, ** p < 0.05, *** p < 0.01.",
    "Robust standard errors are reported in parentheses.",
    "Square brackets show 95 percent confidential intervals."
  )) %>%
  width(j = 1, 1) %>%
  fontsize(size = 9, part = "all") %>%
  ft_theme()
```

Experimental groups B and D contain probability messages. However, for young men, despite the positive effect of experimental group B on replies with intentions, experimental group D has no effect. To test this point, we analyze the correlation of treatment effects for each experimental group as predicted by the RCF.

If the participants fully understood the information in the message D, then the effect of experimental arm D should be the sum of the effects of experimental arms B and C. Columns (1)--(4) of @tbl-rcf-int-cate-corr regress the predicted treatment effect of D on the sum of the predicted treatment effects of B and C. If we cannot reject that the coefficient on this explanatory variable is 1, the potential donor would have perfectly received the information from the message in experimental arm D. However, for all gender and age groups, the coefficient is around $0.3$--$0.4$, allowing us to reject the null hypothesis that the coefficient is 1. In other words, potential donors do not receive exactly the information from experimental group D.

Donors who do not receive accurate information may focus on either the probability or the altruistic message, or they may discount the information in two messages to the same degree. To test this point, columns (4)--(8) of @tbl-rcf-int-cate-corr regress the predicted treatment effect in D on the predicted treatment effect in B and C. The results show that for young men and women, the correlation between the treatment effects of B and D is statistically non-significant, while the positive correlation between the predicted treatment effects of C and D is statistically significant. In other words, young men and women value the altruistic message rather than the probability message when the compatibility notice presents both two messages simultaneously. This is the reason why experimental arm D, which includes probability messages, has no effect among young men.

Interestingly, when we add the two messages simultaneously to the compatibility notice, men and women over 30 years of age give more weight to the probability message than to the altruistic message. For men and women in their late 40s and older, the altruistic message (experimental arm C) is, on average, more effective than the probability message (experimental arm B). However, because they place more importance on the probability message in treatment D, the treatment effect for this arm is close to zero on average.

## Response Speed to Notification {#sec-reply-speed}

```{r}
#| label: create-flow-data
#| include: false
#| vscode: {languageId: r}

flow <- stock %>%
  mutate(
    days_reply = if_else(is.na(days_reply), 10000, days_reply),
    days4 = if_else(days_reply <= 4, value, 0),
    days7 = if_else(days_reply <= 7, value, 0),
    days10 = if_else(days_reply <= 10, value, 0),
    days14 = if_else(days_reply <= 14, value, 0),
    days21 = if_else(days_reply <= 21, value, 0),
    days28 = if_else(days_reply <= 28, value, 0)
  ) %>%
  select(-value) %>%
  pivot_longer(days4:days28, names_to = "within", names_prefix = "days") %>%
  mutate(within = as.numeric(within))
```

```{r}
#| include: false

with(subset(use, treat == "A" & reply == 1), summary(days_reply))
with(subset(use, treat == "A" & reply == 1 & intention == 1), summary(days_reply))
with(subset(use, treat == "A" & reply == 1 & intention == 0), summary(days_reply))
with(subset(flow, treat == "A" & outcome == "Reply" & within == 7), summary(value))
with(subset(flow, treat == "A" & outcome == "Positive intention" & within == 7), summary(value))
```

Since our data include the number of reply days, we examine the effect over time and estimate the effect on the probability $\text{Pr}(D_{imw} \le d)$, which is a probability of replying within $d$ days, in a linear probability model. In this model, the outcome variable is a dummy taking one if the potential donor replied to the compatibility notice within $d$ days. If the value of $d$ is sufficiently large, the effect on $\text{Pr}(D_{imw} \le d)$ is consistent with the effect on replies shown in @sec-reply. Also, we decompose the effect on $\text{Pr}(D_{imw} \le d)$ into two effects in terms of the donor's intention. For positive intention, the outcome is a dummy variable taking one if the potential donor replied within $d$ days and indicated the intention to donate. For negative intention, the outcome variable is a dummy variable that takes one if the potential donor replied within $d$ days and did not indicate the intention to donate. We focus on $d = \{4, 7, 10, 14, 21, 28\}$.

In the control arm, the average response speed among repliers was 10 days. The average response speed of replies with positive or negative intentions was 9 and 12 days, respectively. The longest response time was 46 days. In addition, 33 percent of the control group responded within seven  days, which is stated as a guideline in the compatibility notice, and 23 percent of the control group responded with positive intentions (including those who did not respond).

```{r}
#| label: est-subsample-speed
#| include: false
#| vscode: {languageId: r}

est_flow_sub <- flow %>%
  mutate(age_less30 = if_else(age < 30, 1, 0)) %>%
  dplyr::filter(age_less30 == 1) %>%
  group_by(outcome, within, male) %>%
  nest() %>%
  mutate(
    fit = map(data, ~ lm_robust(
      update(mod$ctrl, . ~ . - male - age_demean),
      cluster = RCTweek,
      se_type = "CR2",
      data = .x
    )),
    avg = map_chr(data, ~ sprintf(
      "%1d\n(%1.3f)", within, with(subset(.x, treat == "A"), mean(value))
    ))
  ) %>%
  mutate(
    tidy = map(fit, tidy),
    tidy = map(tidy, ~ subset(.x, str_detect(term, "treat"))),
    tidy = map(tidy, ~ dplyr::select(.x, -outcome))
  ) %>%
  dplyr::select(-data, -fit) %>%
  unnest(cols = tidy) %>%
  mutate(
    term = str_replace(term, "treat", ""),
    term = factor(term, LETTERS[2:4])
  )

est_flow_sub
```

```{r}
#| label: fig-young-male-speed
#| fig-cap: 'Effect on Reply within Specific Days after Sending Notification among Males Less than 30. Notes: These plots show the average effect (and associated 95% confidential interval) on each outcome. We use clustered standard errors with the CR2 adjustment (cluster unit is experimental week). We control number of past coordinations, number of hospitals per 10 square kilometers, number of hospitals with PBSC collection per 10 square kilometers, number of hospitals with BM collection per 10 square kilometers, month dummies, and week dummies.'
#| vscode: {languageId: r}

plot_list_male <- unique(est_flow_sub$outcome) %>%
  purrr::map(function(x) {
    subset(est_flow_sub, male == 1 & outcome == x) %>%
      ggplot(aes(x = within, y = estimate, color = term, shape = term)) +
      geom_hline(aes(yintercept = 0), linetype = 2) +
      geom_point(size = 3, position = position_dodge(2)) +
      geom_errorbar(
        aes(ymin = conf.low, ymax = conf.high),
        position = position_dodge(2),
        width = 0
      ) +
      scale_x_continuous(
        breaks = subset(est_flow_sub, male == 1 & outcome == x)$within,
        labels = subset(est_flow_sub, male == 1 & outcome == x)$avg
      ) +
      scale_y_continuous(
        breaks = seq(-0.2, 0.2, by = 0.05), limits = c(-0.2, 0.2)
      ) +
      labs(
        title = paste("Outcome:", x),
        x = "Days after sending notification\n(Control average)",
        y = "Estimated Effects (95%CI)",
        color = "Treatment", shape = "Treatment"
      ) +
      simplegg()
  })

wrap_plots(plot_list_male, ncol = 2) +
  plot_layout(guides = "collect") &
  theme(legend.position = "bottom")
```


Since the effects on the stock variables seen in the previous subsections are heterogeneous, this subsection focuses on the heterogeneity of the effects on the flow variables. @fig-young-male-speed restricts the sample to men under 30. In the control group of this subsample, 21% of potential donors replied within seven days (JMDP recommendation of response speed). In this subset, we have already found that experimental arm B, which added only the probability message, increases the reply rate with positive intention. This positive effect is observed after 14 days. Experimental arm B does not have statistically significant effects on the reply within 14 days and the reply with positive intentions within 10 days. Experimental arm B has statistically significant effects on the reply within 21 and 28 days and the reply with positive intentions within 14, 21, and 28 days. In addition, a notable result is that experimental arm B reduces the probability of replying with negative intentions within 10 days.

```{r}
#| label: fig-young-female-speed
#| fig-cap: 'Effect on Reply within Specific Days after Sending Notification among Females Less than 30. Notes: These plots show the average effect (and associated 95% confidential interval) on each outcome. We use clustered standard errors with the CR2 adjustment (cluster unit is experimental week). We control number of past coordinations, number of hospitals per 10 square kilometers, number of hospitals with PBSC collection per 10 square kilometers, number of hospitals with BM collection per 10 square kilometers, month dummies, and week dummies.'
#| vscode: {languageId: r}

plot_list_female <- unique(est_flow_sub$outcome) %>%
  purrr::map(function(x) {
    subset(est_flow_sub, male == 0 & outcome == x) %>%
      ggplot(aes(x = within, y = estimate, color = term, shape = term)) +
      geom_hline(aes(yintercept = 0), linetype = 2) +
      geom_point(size = 3, position = position_dodge(2)) +
      geom_errorbar(
        aes(ymin = conf.low, ymax = conf.high),
        position = position_dodge(2),
        width = 0
      ) +
      scale_x_continuous(
        breaks = subset(est_flow_sub, male == 0 & outcome == x)$within,
        labels = subset(est_flow_sub, male == 0 & outcome == x)$avg
      ) +
      scale_y_continuous(
        breaks = seq(-0.3, 0.3, by = 0.05),
        labels = sprintf("%1.2f", seq(-0.3, 0.3, by = 0.05)),
        limits = c(-0.25, 0.2)
      ) +
      labs(
        title = paste("Outcome:", x),
        x = "Days after sending notification\n(Control average)",
        y = "Estimated Effects (95%CI)",
        color = "Treatment", shape = "Treatment"
      ) +
      simplegg()
  })

wrap_plots(plot_list_female, ncol = 2) +
  plot_layout(guides = "collect") &
  theme(legend.position = "bottom")
```

@fig-young-female-speed restricts the sample to women under 30. We already found that experimental arm C, adding only the patient information, has no statistically significant effect on the overall reply rate and intention. However, when focusing on short-term behavior, experimental arm C statistically significantly increases the reply within four days and the reply within 10--28 days by more than 5 percentage points. In particular, experimental arm C has a statistically significant increase in the probability of replying with positive intentions within four days. Surprisingly, experimental group B, which is effective for young men, reduced the reply within 7--14 days and the reply with positive intention within seven days.

## Effects on the Coordination Process {#sec-process}

```{r}
#| label: create-coordination-data
#| include: false
#| vscode: {languageId: r}

exclude <- use %>%
  select(id, starts_with("exg_stop")) %>%
  pivot_longer(
    -id,
    names_to = "outcome", values_to = "exclude",
    names_prefix = "exg_stop_"
  )

coordination <- use %>%
  select(test, candidate, consent, donate, everything()) %>%
  pivot_longer(test:donate, names_to = "outcome") %>%
  dplyr::left_join(exclude, by = c("id", "outcome")) %>%
  mutate(
    age_demean = age - mean(rawdt$age),
    outcome = factor(
      outcome,
      levels = unlist(names(outcome_label)[4:7]),
      labels = unlist(outcome_label[4:7])
    )
  )
```

Finally, we examine the impact on each step in the coordination process after replying to the compatibility notice. As explained in @sec-background, the coordination process has four stages: confirmatory typing (CT), candidate selection, final consent, and donation. We use as an outcome variable a dummy variable taking one if a potential donor has reached each step. Also, as in the analysis in @sec-reply, we exclude samples that are likely to have been terminated independently of the potential donor's intentions. When estimating the effect on CT, we exclude cases of interruptions due to the patient. Since the patient's physician can select the healthiest potential donor as a candidate at the candidate selection stage, when estimating the effect on the process after candidate selection, we exclude cases of interruptions due to the donor's health reasons or patient. However, we must be careful in interpreting the effect on the process after candidate selection, since sample exclusion may not completely remove the physician's decision. In the control group, 23% of potential donors took CT, 8% of potential donors became candidates, and 6% of potential donors ultimately donated.

```{r}
#| label: est-full-coordination
#| include: false

est_coordination <- coordination %>%
  group_by(outcome) %>%
  nest() %>%
  mutate(
    fit1 = map(
      data,
      ~ lm_robust(
        mod$unctrl,
        data = subset(., exclude == 0),
        cluster = RCTweek,
        se_type = "CR2"
      )
    ),
    fit2 = map(
      data,
      ~ lm_robust(
        mod$ctrl,
        data = subset(., exclude == 0),
        cluster = RCTweek,
        se_type = "CR2"
      )
    ),
    avg = map_chr(
      data,
      ~ with(
        subset(., exclude == 0 & treat == "A"),
        sprintf("%.4f", mean(value))
      )
    )
  ) %>%
  pivot_longer(
    fit1:fit2,
    names_prefix = "fit",
    names_to = "model",
    values_to = "fit"
  ) %>%
  select(- data)

add_table <- c("Control average", est_coordination$avg) %>%
  rbind(c("Covariates", "", "X", "", "X", "", "X", "", "X")) %>%
  data.frame()

attr(add_table, "position") <- c(9, 10)

tbl_est_coordination <- est_coordination %>%
  pull(fit) %>%
  modelsummary(
    coef_map = c(
      "(Intercept)" = "Constant",
      "treatB" = "Treatment B",
      "treatC" = "Treatment C",
      "treatD" = "Treatment D"
    ),
    stars = c("***" = .01, "**" = .05, "*" = .1),
    fmt = 4,
    gof_omit = "R2|AIC|BIC|Log|Std|FE|se_type",
    add_rows = add_table
  )
```

```{r}
#| label: tbl-full-coordination
#| tbl-cap: Linear Probability Model of Coordination Process.
#| output: asis
#| vscode: {languageId: r}

tbl_est_coordination %>%
  add_header_row(
    values = c("", "CT", "Candidate", "Consent", "Donation"),
    colwidths = c(1, 2, 2, 2, 2)
  ) %>%
  align(j = -1, align = "center", part = "all") %>%
  add_footer_lines(paste(
    "Notes: * p < 0.1, ** p < 0.05, *** p < 0.01.",
    "The clustered standard errors with the CR2 adjustment",
    "are reported in parenetheses (cluster unit is experimental weeks).",
    "Covariates are gender, squared polynomial of (demeaned) age,",
    "number of past coordinations,",
    "number of hospitals per 10 square kilometers,",
    "number of hospitals with PBSC collection per 10 square kilometers,",
    "number of hospitals with BM collection per 10 square kilometers,",
    "month dummies, and week dummies."
  )) %>%
  width(j = 1, 1) %>%
  fontsize(size = 9, part = "all") %>%
  ft_theme()
  # kableExtra::kable_styling() %>%
  # kableExtra::add_header_above(c(
  #   " " = 1, "CT" = 2, "Candidate" = 2, "Consent" = 2, "Donation" = 2
  # )) %>%
  # kableExtra::footnote(
  #   paste(
  #     "* p < 0.1, ** p < 0.05, *** p < 0.01.",
  #     "Standard errors clustered by experimental weeks",
  #     "are reported in parentheses.",
  #     "Covariates are gender, squared polynomial of (demeaned) age,",
  #     "number of past coordinations,",
  #     "number of hospitals per 10 square kilometers,",
  #     "number of hospitals with PBSC collection per 10 square kilometers,",
  #     "number of hospitals with BM collection per 10 square kilometers,",
  #     "month dummies, and week dummies."
  #   ),
  #   threeparttable = TRUE
  # )
```

@tbl-tbl-full-coordination is the estimated result of the linear probability model. The results show that experimental arm B, adding only the probability message, increases the probability of reaching the CT by 3 percentage points or 13%, which is statistically significant. Controlling for covariates, experimental arm D, adding both the probability message and the patient message, also increases the probability of taking the CT by 3 percentage points or 13%, which is statistically significant. The results so far are also obtained by estimating with a logit model (@tbl-full-coordination-logit).

```{r}
#| label: est-subsample-coordination
#| include: false
#| vscode: {languageId: r}

est_coordination_sub <- coordination %>%
  mutate(age_less30 = if_else(age < 30, 1, 0)) %>%
  group_by(outcome, male, age_less30) %>%
  nest() %>%
  mutate(est = map(data, ~ lm_robust(
    update(mod$ctrl, . ~ . - male - age_demean),
    cluster = RCTweek,
    se_type = "CR2",
    data = subset(.x, exclude == 0)
  )))

pdt_coordination_sub <- est_coordination_sub %>%
  mutate(
    fit = map(est, tidy),
    fit = map(fit, ~ subset(.x, str_detect(term, "treat"))),
    fit = map(fit, ~ dplyr::select(.x, -outcome)),
    N = map_chr(est, ~ paste("N =", nobs(.x))),
    mean = map_dbl(data, ~ with(subset(., exclude == 0 & treat == "A"), mean(value))),
    mean = sprintf("Control avg = %1.3f", mean)
  ) %>%
  select(-data, -est) %>%
  unnest(cols = fit) %>%
  mutate(
    pos = paste0(male, age_less30),
    pos = factor(
      pos,
      levels = c("01", "00", "11", "10"),
      labels = c(
        "Female\u00d7\nAge<30",
        "Female\u00d7\n30\u2264Age",
        "Male\u00d7\nAge<30",
        "Male\u00d7\n30\u2264Age"
      )
    ),
    term = str_replace(term, "treat", ""),
    term = factor(term, LETTERS[2:4])
  )

text <- pdt_coordination_sub %>%
  ungroup() %>%
  select(male, age_less30, pos, N, mean, outcome) %>%
  distinct()
```

```{r}
#| label: fig-subsample-coordination
#| fig-cap: 'Effect on Coordination by Gender and Age Group. Note: These plots show the average effect (and associated 95% confidential interval) on each outcome by gender and age group. We use clustered standard errors with the CR2 adjustment (cluster unit is experimental week). We control number of past coordinations, number of hospitals per 10 square kilometers, number of hospitals with PBSC collection per 10 square kilometers, number of hospitals with BM collection per 10 square kilometers, month dummies, and week dummies.'
#| vscode: {languageId: r}

plot_list <- unique(pdt_coordination_sub$outcome) %>%
  purrr::map(function(x) {
    subset(pdt_coordination_sub, outcome == x) %>%
      ggplot(aes(x = pos, y = estimate)) +
      geom_hline(aes(yintercept = 0), linetype = 2) +
      geom_point(
        aes(color = term, shape = term),
        size = 3, position = position_dodge(0.5)
      ) +
      geom_errorbar(
        aes(ymin = conf.low, ymax = conf.high, color = term),
        position = position_dodge(0.5),
        width = 0
      ) +
      geom_text(
        aes(y = -0.1, label = N),
        data = subset(text, outcome == x),
        color = "black"
      ) +
      geom_text(
        aes(y = -0.125, label = mean),
        data = subset(text, outcome == x),
        color = "black"
      ) +
      scale_y_continuous(
        breaks = seq(-0.2, 0.2, by = 0.05), limits = c(-0.15, 0.2)
      ) +
      labs(
        title = paste("Outcome:", x),
        x = "Subset",
        y = "Estimated Effects (95%CI)",
        color = "Treatment", shape = "Treatment"
      ) +
      simplegg()
  })

wrap_plots(plot_list, ncol = 2) +
  plot_layout(guides = "collect") &
  theme(legend.position = "bottom")
```

@fig-subsample-coordination is a coefficient plot of the subsample analysis divided by gender and age. The results show that experimental arm B may increase the probability of taking the CT for males under age 30, which is statistically significant at 10 percent level (@tbl-wildbs-young-male-coordinate). Experimental arm B also statistically significantly increases the probability of CT for men over 30 years old.

# Discussion {#sec-discussion}

我々のフィールド実験は確率メッセージ（実験群B）が若年男性の提供意思を高めており、確認検査までの到達率も高めていることを明らかにした。ただし、利他メッセージを同時に提示する（実験群D）と、若年男性は利他メッセージの情報を重視するので、確率メッセージはコーディネーションの進行に貢献しなくなる。また、早い時期の返信行動に焦点を当てると、利他メッセージは若年女性の提供意思を高めて、返信を促していることを明らかにした。

なぜ確率メッセージと利他メッセージで効果が異なるのだろうか？確率メッセージと利他メッセージは文言は異なるものの共通して提供価値を高めるような情報を加えている。さらに、利他メッセージは「潜在ドナーが早く見つかるほど、患者の生存確率を高める」という情報を通して、提供価値が経時的に減衰していくも強調しており、確率メッセージはこの点を主張していない。我々はこの違いに焦点を当てて、一つの仮説を立てた。すなわち、情報提供後も提供価値を低く期待している人は利他メッセージによって提供をあきらめてしまうというものである。

この点をフォーマルに示すために、我々は返信に関する意思決定モデルを構築した。ドナー候補者は0期から$T$期の間にいつ返信をするのかを決める。ある$t$期の効用は$U(t) = b\delta_b^t - c\delta_c^t$とし、ここで$b$と$c$はそれぞれ提供の（主観的な期待）価値とコストである。また、$\delta_b$と$\delta_c$は主観的な時間割引因子であり、提供価値と提供コストで異なることを許容する。また、すべての期で$U(t)$が負となるとき、ドナー候補者は適合通知に返信しない[^negative]。詳細な導出とシミュレーションの結果を補論に示す。

[^negative]: 単純化のために、この意思決定モデルは返信する人が必ず提供意向を持っていることを暗に仮定している。

```{r}
#| label: fig-theory-simulation
#| fig-cap: "Simulation of Optimal Response Speed. Note: We assume $c = 10$, $\\delta_c = 0.6$, and $T = 10$."

optT <- function(b, db, dc = 0.6, c = 10, T = 10) {
  if (db <= dc) {
    if (b < c) return(NA) else return(0)
  } else {
    if (b < (dc / db)^T) return(NA)
    tstar <- (log(c/b) + log(log(dc)/log(db))) / log(db/dc)
    if (tstar <= 0) return(0)
    if (tstar >= T) return(T)
    return(tstar)
  }
}

sim_data <- expand.grid(
  b = seq(0.0001, 20, length.out = 100),
  db = seq(0.0001, 0.9999, length.out = 100)
)

optim_data <- sim_data %>%
  rowwise() %>%
  mutate(optimum = optT(b, db)) %>%
  ungroup()

optim_data %>%
  ggplot(aes(x = db, y = b, fill = optimum))+
    geom_raster() +
    scale_fill_gradient(high = "#132B43", low = "#d2e9fa", na.value = NA) +
    labs(
      x = expression(paste("Time disount factor with donation value", "(", delta[b], ")")),
      y = expression(paste("Donation value", "(", b, ")")),
      fill = "Optimal response speed"
    ) +
    simplegg() +
    theme(panel.grid.major.y = element_blank())
```

理論モデルの解析的および数値的結果は以下のようにまとめられる。第一に、提供価値の上昇は返信行動と返信時期に正の影響を与える。第二に、提供価値が十分に高い（$b > c$）人について、提供価値の時間割引因子の減少は返信時期にのみ正の影響を与える。第三に、提供価値が十分に低い（$c < b$）人について、提供価値の時間割引因子の減少は返信時期を遅らせ、返信しなくなる可能性も高くなる。

我々の介入は情報提供を通じて提供価値（$b$）と提供価値の時間割引因子（$\delta_b$）を変える。確率メッセージは$b$を高める。したがって、確率メッセージは若年男性の提供意思に正の効果を与えている。他の性・年代において確率メッセージが有効でなかった理由は、もともと提供価値を高く期待していたか、もしくは幹細胞提供の公共財の性質を考慮せずに意思決定しているかのどちらかであると考えられる。

他方で、利他メッセージは$b$を高め、$\delta_b$を低めている。提供価値を低く見積もっている人が一定数いるならば、利他メッセージは返信行動と返信時期に対して正の効果と負の効果の両方を持つ。したがって、若年男性がもともと提供価値を低く見積もっており、利他メッセージが十分に提供価値を高められなければ、利他メッセージは若年男性に対して有効でないと考えられる。また、このメッセージは若年女性の早い返信を促している。これは女性の大多数が提供価値を十分に高く見積もっていることで説明できる。このとき、利他メッセージは返信時期にのみ正の影響を与えている。

# Conclusion {#sec-conclusion}

本研究は患者の生存確率を高める日本骨髄バンクのドナープールの質の改善の施策の一つとして、潜在ドナーとなったことを知らせる適合通知上での情報提供を効果検証を行った。その結果、幹細胞提供の公共財の性質を利用したただ乗りを防ぐ確率メッセージは若年男性の提供意思を高めることを明らかにした。また、提供価値の増加に加えて提供価値の経時的な減衰を強調した利他メッセージは若年女性の正の意向を伴う早い返信を促していることを明らかにした。確率メッセージと利他メッセージの有効性の違いは男女の提供価値の差で説明できる可能性を理論的に示した。若年男性は提供価値をもともと低く見積もっていたので、利他メッセージは若年男性の返信を阻害する効果も含んでいた可能性がある。逆に、若年女性は提供価値をもともと高く見積もっていたので、利他メッセージは返信時期のみを促進する効果を持っていた可能性がある。また、二つのメッセージを同時に提供すると、若年層は利他メッセージを重視して意思決定している可能性がある。



# Appendix {-}

```{r}
#| label: est-full-reply-logit
#| include: false

est_stock_logit <- stock %>%
  group_by(outcome) %>%
  nest() %>%
  mutate(
    fit1 = map(
      data,
      ~ glm(mod$unctrl, data = ., family = binomial())
    ),
    fit2 = map(
      data,
      ~ glm( mod$ctrl, data = ., family = binomial())
    )
  ) %>%
  pivot_longer(
    fit1:fit2,
    names_prefix = "fit",
    names_to = "model",
    values_to = "fit"
  )

add_tables <- tibble::tribble(
  ~term, ~"(1)", ~"(2)", ~"(3)", ~"(4)", ~"(5)", ~"(6)",
  "Covariates", "", "X", "", "X", "", "X"
)

attr(add_tables, "position") <- 7


tidy_custom.glm <- function(x, ...) {
  tbl <- tidy(x) %>%
    mutate(
      or = exp(estimate),
      lower.or = exp(estimate - 1.96 * std.error),
      upper.or = exp(estimate + 1.96 * std.error)
    )

  tbl
}

tbl_stock_logit <- est_stock_logit %>%
  pull(fit) %>%
  setNames(paste0("(", seq_len(length(.)), ")")) %>%
  modelsummary(
    estimate = "{or}",
    statistic = "[{lower.or}, {upper.or}]",
    coef_map = c(
      "treatB" = "Treatment B",
      "treatC" = "Treatment C",
      "treatD" = "Treatment D"
    ),
    add_rows = add_tables,
    gof_omit = "R2|AIC|BIC|RMSE|Std|FE|se_type",
    fmt = fmt_sprintf("%.3f")
  )
```

```{r}
#| label: tbl-full-reply-logit
#| tbl-cap: Logit Model of Reply and Intention

tbl_stock_logit %>%
  flextable::add_header_row(
    values = c("", "Reply", "Positive", "Negative"),
    colwidths = c(1, 2, 2, 2)
  ) %>%
  flextable::add_header_row(
    values = c("", "Intention"),
    colwidths = c(3, 4)
  ) %>%
  add_footer_lines(paste(
    "Notes: We show odds ratios and associated 95 percent confidential intervals.",
    "Covariates are gender, squared polynomial of (demeaned) age,",
    "number of past coordinations,",
    "number of hospitals per 10 square kilometers,",
    "number of hospitals with PBSC collection per 10 square kilometers,",
    "number of hospitals with BM collection per 10 square kilometers,",
    "month dummies, and week dummies."
  )) %>%
  align(j = -1, align = "center", part = "all") %>%
  width(j = 1, 1) %>%
  fontsize(size = 9, part = "all") %>%
  ft_theme()
```

```{r}
#| label: est-full-coordination-logit
#| include: false

est_coordination_logit <- coordination %>%
  group_by(outcome) %>%
  nest() %>%
  mutate(
    fit1 = map(
      data,
      ~ glm(mod$unctrl, data = subset(., exclude == 0), family = binomial())
    ),
    fit2 = map(
      data,
      ~ glm(mod$ctrl, data = subset(., exclude == 0), family = binomial())
    )
  ) %>%
  pivot_longer(
    fit1:fit2,
    names_prefix = "fit",
    names_to = "model",
    values_to = "fit"
  )

add_tables <- tibble::tribble(
  ~term, ~mod1, ~mod2, ~mod3, ~mod4, ~mod5, ~mod6, ~mod7, ~mod8,
  "Covariates", "", "X", "", "X", "", "X", "", "X"
)

attr(add_tables, "position") <- 7

tbl_coordination_logit <- est_coordination_logit %>%
  pull(fit) %>%
  setNames(paste0("(", seq_len(length(.)), ")")) %>%
  modelsummary(
    estimate = "{or}",
    statistic = "[{lower.or}, {upper.or}]",
    coef_map = c(
      "treatB" = "Treatment B",
      "treatC" = "Treatment C",
      "treatD" = "Treatment D"
    ),
    add_rows = add_tables,
    gof_omit = "R2|AIC|BIC|RMSE|Std|FE|se_type",
    fmt = fmt_sprintf("%.3f")
  )
```

```{r}
#| label: tbl-full-coordination-logit
#| tbl-cap: Logit Model of Coordination

tbl_coordination_logit %>%
  flextable::add_header_row(
    values = c("", "CT", "Candidate", "Consent", "Donation"),
    colwidths = c(1, 2, 2, 2, 2)
  ) %>%
  align(j = -1, align = "center", part = "all") %>%
  width(j = 1, 1) %>%
  add_footer_lines(paste(
    "Notes: We show odds ratios and associated 95 percent confidential intervals.",
    "Covariates are gender, squared polynomial of (demeaned) age,",
    "number of past coordinations,",
    "number of hospitals per 10 square kilometers,",
    "number of hospitals with PBSC collection per 10 square kilometers,",
    "number of hospitals with BM collection per 10 square kilometers,",
    "month dummies, and week dummies."
  )) %>%
  fontsize(size = 9, part = "all") %>%
  ft_theme()
```

<!-- //NOTE: Wild clustered bootstrap -->

```{r}
#| label: est-wildbs-youngmen-reply
#| include: false

est_stock_youngmen <- stock %>%
  dplyr::filter(male == 1 & age < 30) %>%
  group_by(outcome) %>%
  nest() %>%
  mutate(
    fit1 = map(
      data,
      ~ lm_robust(
        mod$unctrl,
        data = .,
        cluster = RCTweek,
        se_type = "CR2"
      )
    ),
    fit2 = map(
      data,
      ~ lm_robust(
        update(mod$ctrl, . ~ . - male - age_demean),
        data = .,
        cluster = RCTweek,
        se_type = "CR2"
      )
    )
  ) %>%
  pivot_longer(
    fit1:fit2,
    names_prefix = "fit",
    names_to = "model",
    values_to = "fit"
  )

ate_bs <- stock %>%
  dplyr::filter(male == 1 & age < 30) %>%
  group_by(outcome) %>%
  nest() %>%
  mutate(
    treatB_1 = map_dbl(data, ~ wildBS(
      mod$unctrl,
      data = .x,
      cluster = RCTweek,
      H0 = "treatB = 0",
      B = 1000
    )),
    treatD_1 = map_dbl(data, ~ wildBS(
      mod$unctrl,
      data = .x,
      cluster = RCTweek,
      H0 = "treatD = 0",
      B = 1000
    )),
    treatB_2 = map_dbl(data, ~ wildBS(
      update(mod$ctrl, . ~ . - male - age_demean),
      data = .x,
      cluster = RCTweek,
      H0 = "treatB = 0",
      B = 1000
    )),
    treatD_2 = map_dbl(data, ~ wildBS(
      update(mod$ctrl, . ~ . - male - age_demean),
      data = .x,
      cluster = RCTweek,
      H0 = "treatD = 0",
      B = 1000
    ))
  ) %>%
  pivot_longer(
    treatB_1:treatD_2,
    names_pattern = "(.*)_(.*)",
    names_to = c(".value", "model")
  )

ctrl_avg <- stock %>%
  dplyr::filter(male == 1 & age < 30) %>%
  group_by(outcome) %>%
  summarize(mean = mean(value))

add_tabs <- data.frame(rbind(
  c("Control average", sprintf("%1.4f", rep(ctrl_avg$mean, each = 2))),
  c("Covariates", rep(c("", "X"), length.out = 6)),
  c("Bootstrap p-value", rep("", 6)),
  c("B = 0", sprintf("%1.4f", ate_bs$treatB)),
  c("D = 0", sprintf("%1.4f", ate_bs$treatD))
))

attr(add_tabs, "position") <- 7:11

tbl_stock_sub <- est_stock_youngmen %>%
  pull(fit) %>%
  modelsummary(
    coef_map = c(
      "treatB" = "Treatment B",
      "treatC" = "Treatment C",
      "treatD" = "Treatment D"
    ),
    stars = c("***" = .01, "**" = .05, "*" = .1),
    fmt = 4,
    gof_omit = "R2|AIC|BIC|Log|Std|FE|se_type",
    add_rows = add_tabs
  )
```

```{r}
#| label: tbl-wildbs-youngmen-reply
#| tbl-cap: Linear Probability Model of Reply and Intentions for Males Less Then 30 Years

tbl_stock_sub %>%
  align(j = -1, align = "center", part = "all") %>%
  add_header_row(
    values = c("", "Reply", "Positive", "Negative"),
    colwidths = c(1, 2, 2, 2)
  ) %>%
  add_header_row(
    values = c("", "Intention"),
    colwidths = c(3, 4)
  ) %>%
  add_footer_lines(paste(
    "Notes: * p < 0.1, ** p < 0.05, *** p < 0.01.",
    "The clustered standard errors with the CR2 adjustment",
    "are reported in parenetheses (cluster unit is experimental weeks).",
    "Covariates are number of past coordinations,",
    "number of hospitals per 10 square kilometers,",
    "number of hospitals with PBSC collection per 10 square kilometers,",
    "number of hospitals with BM collection per 10 square kilometers,",
    "month dummies, and week dummies.",
    "Bootstrap p-value is based on the wild cluster bootstrap-t with a null hypothesis imposed,",
    "which is proposed by Cameron et al. (2008)."
  )) %>%
  width(j=1, 1) %>%
  padding(10:11, padding.left = 10) %>%
  fontsize(size = 9, part = "all") %>%
  ft_theme()
```

```{r}
#| label: est-wildbs-young-male-coordinate
#| include: false

ate_bs_coordination <- coordination %>%
  dplyr::filter(male == 1) %>%
  dplyr::filter(exclude == 0) %>%
  mutate(age_less30 = if_else(age < 30, 1, 0)) %>%
  group_by(outcome, age_less30) %>%
  nest() %>%
  mutate(
    treatB = map_dbl(data, ~ wildBS(
      update(mod$ctrl, . ~ . - male - age_demean),
      data = .x,
      cluster = RCTweek,
      H0 = "treatB = 0",
      B = 1000
    ))
  )

ctrl_avg <- coordination %>%
  dplyr::filter(male == 1) %>%
  dplyr::filter(exclude == 0) %>%
  mutate(age_less30 = if_else(age < 30, 1, 0)) %>%
  group_by(age_less30, outcome) %>%
  summarize(mean = mean(value))

add_tabs <- data.frame(rbind(
  c("Control average", sprintf("%1.4f", ctrl_avg$mean)),
  c("Covariates", rep("X", 8)),
  c("Bootstrap p-value", rep("", 8)),
  c("B = 0", sprintf("%1.4f", ate_bs_coordination$treatB))
))

attr(add_tabs, "position") <- 7:10

tbl_coordination_sub <- est_coordination_sub %>%
  dplyr::filter(male == 1) %>%
  pull(est) %>%
  modelsummary(
    coef_map = c(
      "treatB" = "Treatment B",
      "treatC" = "Treatment C",
      "treatD" = "Treatment D"
    ),
    stars = c("***" = .01, "**" = .05, "*" = .1),
    fmt = 4,
    gof_omit = "R2|AIC|BIC|Log|Std|FE|se_type",
    add_rows = add_tabs
  )
```

```{r}
#| label: tbl-wildbs-young-male-coordinate
#| tbl-cap: Linear Probability Model of Coordination among Males

tbl_coordination_sub %>%
  align(j = -1, align = "center", part = "all") %>%
  add_header_row(
    values = c("", rep(c("CT", "Candidate", "Consent", "Donation"), 2))
  ) %>%
  add_header_row(
    values = c("", "30\u2264Age", "Age<30"),
    colwidths = c(1, 4, 4)
  ) %>%
  width(j=1, 1) %>%
  add_footer_lines(paste(
    "Notes: * p < 0.1, ** p < 0.05, *** p < 0.01.",
    "The clustered standard errors with the CR2 adjustment",
    "are reported in parenetheses (cluster unit is experimental weeks).",
    "Covariates are number of past coordinations,",
    "number of hospitals per 10 square kilometers,",
    "number of hospitals with PBSC collection per 10 square kilometers,",
    "number of hospitals with BM collection per 10 square kilometers,",
    "month dummies, and week dummies.",
    "Bootstrap p-value is based on the wild cluster bootstrap-t with a null hypothesis imposed,",
    "which is proposed by Cameron et al. (2008)."
  )) %>%
  padding(10, padding.left = 10) %>%
  fontsize(size = 9, part = "all")  %>%
  ft_theme()
```

<!-- //NOTE: RCF -->

```{r}
#| label: rcf-int-cate
#| include: false

ate_int_rcf <- subset_cond %>%
  purrr::map(~ average_treatment_effect(int_rcf, subset = .)) %>%
  reduce(bind_rows) %>%
  mutate(
    z = abs(estimate / std.err),
    p = 2 * pnorm(z, lower.tail = FALSE),
    gender = rep(c("Females", "Males"), each = 6),
    age = rep(c("Young", "Elder", "Young", "Elder"), each = 3)
  )

tbl_int_rcf <- ate_int_rcf %>%
  select(gender, age, contrast, estimate, std.err, p) %>%
  pivot_wider(names_from = gender, values_from = estimate:p) %>%
  select(age, contrast, ends_with("Females"), ends_with("Males")) %>%
  mutate(contrast = str_extract(contrast, "[B-D]"))
```

```{r}
#| label: tbl-rcf-int-cate
#| tbl-cap: Conditional Average Treatment Effect Estimated by RCF.

tbl_int_rcf %>%
  mutate(age = recode(
    age,
    "Young" = "Age: Less than 30",
    "Elder" = "Age: More than or equal to 30"
  )) %>%
  as_grouped_data("age") %>%
  as_flextable(hide_grouplabel = TRUE) %>%
  set_header_labels(
    contrast = "",
    estimate_Females = "Estimate",
    std.err_Females = "S.E.",
    p_Females = "P-value",
    estimate_Males = "Estimate",
    std.err_Males = "S.E.",
    p_Males = "P-value"
  ) %>%
  add_header_row(values = c("", "Females", "Males"), colwidths = c(1, 3, 3)) %>%
  align(j = -1, align = "center", part = "all") %>%
  colformat_double(j = -1, digits = 3) %>%
  padding(j=1:7, padding.top = 5, padding.bottom = 5, part = "all") %>%
  padding(2:4, padding.left = 10) %>%
  padding(6:8, padding.left = 10) %>%
  add_footer_lines(paste(
    "Notes: See Athey and Wager (2019) for",
    "estimation method of conditional average treatment effect (CATE).",
    "Since these estimates are asymptotically normal,",
    "we calculate z-score under the null hypothesis that CATE is zero,",
    "and obtain p-value."
  )) %>%
  fontsize(size = 9, part = "all")  %>%
  ft_theme()
```

```{r}
#| label: fig-rcf-int-dist
#| fig-cap: Distribution of Individual Treatment Effects on Intention Estimated by Random Causal Forest. Covariates are gender, age, number of past coordinations, number of hospitals per 10 square kilometers, number of hospitals with PBSC collection per 10 square kilometers and number of hospitals with BM collection per 10 square kilometers.
#| eval: false

predict_int_rcf <- data.frame(X) %>%
  cbind(int_tau$predictions) %>%
  rename(
    effect_B = `B - A.Y.1`,
    effect_C = `C - A.Y.1`,
    effect_D = `D - A.Y.1`
  ) %>%
  pivot_longer(
    effect_B:effect_D,
    names_to = c(".value", "treat"),
    names_sep = "_"
  ) %>%
  mutate(
    treat = factor(treat, labels = paste("Message", LETTERS[2:4])),
    age_less30 = if_else(age < 30, 1, 0),
    pos = paste0(male, age_less30),
    pos = factor(
      pos,
      levels = c("01", "00", "11", "10"),
      labels = c(
        "Female\u00d7\nAge<30",
        "Female\u00d7\n30\u2264Age",
        "Male\u00d7\nAge<30",
        "Male\u00d7\n30\u2264Age"
      )
    )
  )

predict_int_rcf %>%
  ggplot(aes(x = effect, y = after_stat(count) / sum(after_stat(count)))) +
  geom_histogram(
    aes(fill = effect > 0),
    breaks = seq(-.2, .2, by = .01),
    color = "black"
  ) +
  scale_fill_manual(values = c("white", "red")) +
  facet_grid(treat~pos) +
  labs(
    x = "Treatment effects",
    y = "Fraction"
  ) +
  simplegg() +
  theme(legend.position = "none")
```

```{r}
#| label: est-t-test-covariate-int-rcf
#| eval: false

cov_int_rcf <- predict_int_rcf %>%
  mutate(positive = if_else(effect > 0, 1, 0)) %>%
  select(age:BM_per_area, positive, pos, treat) %>%
  pivot_longer(age:BM_per_area, values_to = "value", names_to = "covariate") %>%
  group_by(pos, covariate, treat) %>%
  nest() %>%
  mutate(
    fit = map(data, ~ t.test(value ~ positive, data = .)),
    mean0 = map_dbl(fit, ~ .$estimate[1]),
    mean1 = map_dbl(fit, ~ .$estimate[2]),
    p = map_dbl(fit, ~ .$p.value)
  ) %>%
  select(-data, -fit) %>%
  pivot_wider(names_from = "treat", values_from = mean0:p) %>%
  select(pos, covariate, ends_with("B"), ends_with("C"), ends_with("D")) %>%
  arrange(pos)
```

```{r}
#| label: tbl-t-test-covariate-int-rcf
#| tbl-cap: Balance Test of Covariates Grouped By Predicted Treatment Effect
#| eval: false

cov_int_rcf %>%
  as_grouped_data("pos") %>%
  as_flextable(hide_grouplabel = TRUE) %>%
  set_header_labels(
    covariate = "",
    "mean0_Message B" = "Negative",
    "mean1_Message B" = "Positive",
    "p_Message B" = "P-value",
    "mean0_Message C" = "Negative",
    "mean1_Message C" = "Positive",
    "p_Message C" = "P-value",
    "mean0_Message D" = "Negative",
    "mean1_Message D" = "Positive",
    "p_Message D" = "P-value"
  ) %>%
  add_header_row(
    values = c("", "Message B", "Message C", "Message D"),
    colwidths = c(1, 3, 3, 3)
  ) %>%
  align(j = -1, align = "center", part = "all") %>%
  colformat_double(j = -1, digits = 2) %>%
  padding(j=1:10, padding.top = 5, padding.bottom = 5, part="all") %>%
  padding(2:6, j = 1, padding.left = 10) %>%
  padding(8:12, j = 1, padding.left = 10) %>%
  padding(14:18, j = 1, padding.left = 10) %>%
  padding(20:24, j = 1, padding.left = 10) %>%
  width(j = -1, 0.7) %>%
  width(j = 1, 1.27) %>%
  fontsize(size = 9, part = "all")  %>%
  ft_theme()
```

```{r}
#| label: est-t-test-covariate-donate-rcf
#| include: false
#| eval: false

cov_donate_rcf <- predict_donate_rcf %>%
  mutate(positive = if_else(effect > 0, 1, 0)) %>%
  select(age:BM_per_area, positive, pos, treat) %>%
  pivot_longer(age:BM_per_area, values_to = "value", names_to = "covariate") %>%
  group_by(pos, covariate, treat) %>%
  nest() %>%
  mutate(
    fit = map(data, ~ t.test(value ~ positive, data = .)),
    mean0 = map_dbl(fit, ~ .$estimate[1]),
    mean1 = map_dbl(fit, ~ .$estimate[2]),
    p = map_dbl(fit, ~ .$p.value)
  ) %>%
  select(-data, -fit) %>%
  pivot_wider(names_from = "treat", values_from = mean0:p) %>%
  select(pos, covariate, ends_with("B"), ends_with("C"), ends_with("D")) %>%
  arrange(pos)
```

```{r}
#| label: tbl-t-test-covariate-donate-rcf
#| tbl-cap: Balance Test of Covariates Grouped By Predicted Treatment Effect (Donation)
#| eval: false

cov_donate_rcf %>%
  as_grouped_data("pos") %>%
  as_flextable(hide_grouplabel = TRUE) %>%
  set_header_labels(
    covariate = "",
    "mean0_Message B" = "Negative",
    "mean1_Message B" = "Positive",
    "p_Message B" = "P-value",
    "mean0_Message C" = "Negative",
    "mean1_Message C" = "Positive",
    "p_Message C" = "P-value",
    "mean0_Message D" = "Negative",
    "mean1_Message D" = "Positive",
    "p_Message D" = "P-value"
  ) %>%
  add_header_row(
    values = c("", "Message B", "Message C", "Message D"),
    colwidths = c(1, 3, 3, 3)
  ) %>%
  align(j = -1, align = "center", part = "all") %>%
  colformat_double(j = -1, digits = 2) %>%
  padding(j=1:10, padding.top = 5, padding.bottom = 5, part="all") %>%
  padding(2:6, j = 1, padding.left = 10) %>%
  padding(8:12, j = 1, padding.left = 10) %>%
  padding(14:18, j = 1, padding.left = 10) %>%
  padding(20:24, j = 1, padding.left = 10) %>%
  width(j = -1, 0.7) %>%
  width(j = 1, 1.27) %>%
  fontsize(size = 9, part = "all")  %>%
  ft_theme()
```


```{r}
#| label: est-donate-rcf
#| include: false
#| eval: false

donate <- subset(coordination, outcome == "Donation")
Y <- donate$value
X <- model.matrix(covariate, data = donate)
W <- donate$treat
G <- donate$RCTweek

donate_rcf <- multi_arm_causal_forest(X, Y, W)
donate_tau <- predict(donate_rcf, X)
```

```{r}
#| label: fig-donate-rcf
#| fig-cap: Distribution of Individual Treatment Effects on Donation Estimated by Random Causal Forest.
#| eval: false

predict_donate_rcf <- data.frame(X) %>%
  cbind(donate_tau$predictions) %>%
  rename(
    effect_B = `B - A.Y.1`,
    effect_C = `C - A.Y.1`,
    effect_D = `D - A.Y.1`
  ) %>%
  pivot_longer(
    effect_B:effect_D,
    names_to = c(".value", "treat"),
    names_sep = "_"
  ) %>%
  mutate(
    treat = factor(treat, labels = paste("Message", LETTERS[2:4])),
    age_less30 = if_else(age < 30, 1, 0),
    pos = paste0(male, age_less30),
    pos = factor(
      pos,
      levels = c("01", "00", "11", "10"),
      labels = c(
        "Female\u00d7\nAge<30",
        "Female\u00d7\n30\u2264Age",
        "Male\u00d7\nAge<30",
        "Male\u00d7\n30\u2264Age"
      )
    )
  )

predict_donate_rcf %>%
  ggplot(aes(x = effect, y = after_stat(count) / sum(after_stat(count)))) +
  geom_histogram(
    aes(fill = effect > 0),
    breaks = seq(-.2, .2, by = .01),
    color = "black"
  ) +
  scale_fill_manual(values = c("white", "red")) +
  facet_grid(treat~pos) +
  labs(
    x = "Treatment effects",
    y = "Fraction"
  ) +
  simplegg() +
  theme(legend.position = "none")
```

```{r}
#| label: est-donate-rcf-cate
#| include: false
#| eval: false

subset_cond <- list(
  X[, "male"] == 1 & X[, "age"] < 30,
  X[, "male"] == 0 & X[, "age"] < 30,
  X[, "male"] == 1 & X[, "age"] >= 30,
  X[, "male"] == 0 & X[, "age"] >= 30
)

ate_donate_rcf <- subset_cond %>%
  purrr::map(~ average_treatment_effect(donate_rcf, subset = .)) %>%
  reduce(bind_rows) %>%
  mutate(
    z = abs(estimate / std.err),
    p = 2 * pnorm(z, lower.tail = FALSE),
    gender = rep(c("Males", "Females", "Males", "Females"), each = 3),
    age = rep(c("Young", "Elder"), each = 6)
  )

tbl_donate_rcf <- ate_donate_rcf %>%
  select(gender, age, contrast, estimate, std.err, p) %>%
  pivot_wider(names_from = gender, values_from = estimate:p) %>%
  select(age, contrast, ends_with("Females"), ends_with("Males")) %>%
  mutate(contrast = str_extract(contrast, "[B-D]"))
```

```{r}
#| label: tbl-donate-rcf-cate
#| tbl-cap: Conditional Average Treatment Effect Estimated by RCF.
#| eval: false

tbl_donate_rcf %>%
  mutate(age = recode(
    age,
    "Young" = "Age: Less than 30",
    "Elder" = "Age: More than or equal to 30"
  )) %>%
  as_grouped_data("age") %>%
  as_flextable(hide_grouplabel = TRUE) %>%
  set_header_labels(
    contrast = "",
    estimate_Females = "Estimate",
    std.err_Females = "S.E.",
    p_Females = "P-value",
    estimate_Males = "Estimate",
    std.err_Males = "S.E.",
    p_Males = "P-value"
  ) %>%
  add_header_row(values = c("", "Females", "Males"), colwidths = c(1, 3, 3)) %>%
  align(j = -1, align = "center", part = "all") %>%
  colformat_double(j = -1, digits = 3) %>%
  padding(j=1:7, padding.top = 5, padding.bottom = 5, part = "all") %>%
  padding(2:4, padding.left = 10) %>%
  padding(6:8, padding.left = 10) %>%
  fontsize(size = 9, part = "all")  %>%
  ft_theme()
```

# References {-}