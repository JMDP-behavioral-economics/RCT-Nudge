---
title: |
  Only You:
  A Field Experiment of Text Message to Prevent Free-riding in Japan Marrow Donor Program
author:
  - name: Hiroki Kato
    affiliations:
      - 'Graduate School of Economics, Osaka University, Japan'
  - name: Fumio Ohtake
    affiliations:
      - 'Graduate School of Economics, Osaka University, Japan'
      - 'Center for Infectious Disease Education and Research (CiDER), Osaka University, Japan'
  - name: Saiko Kurosawa
    affiliations:
      - 'Department of Oncology, Ina Central Hospital, Japan'
  - name: Kazuhiro Yoshiuchi
    affiliations:
      - 'Graduate School of Medicine, Tokyo University, Japan'
  - name: Takahiro Fukuda
    affiliations:
      - 'Department of Hematopoietic Stem Cell Transplantation, National Cancer Center Hospital, Japan'
date: last-modified
date-format: '[Last Updated on] MMMM D, YYYY'
pdf-engine: lualatex
bibliography: biblio.bib
format:
  pdf:
    documentclass: bxjsarticle
    classoption:
      - pandoc
      - ja=standard
      - jafont=haranoaji
    papersize: a4
    fontsize: 11pt
    include-in-header:
      text: |
        \usepackage{authblk}
        \usepackage{siunitx}
        \usepackage{threeparttable, threeparttablex, multirow}
        \newcolumntype{d}{S[input-symbols = ()]}
        \usepackage{lscape}
    geometry:
      - top=30mm
      - left=30mm
      - right=30mm
      - bottom=30mm
    toc: false
    number-sections: true
    fig-format: pdf
    fig-pos: t
    template-partials:
      - tex/title.tex
  html:
    number-sections: true
    code-fold: true
    title-block-banner: true
  docx:
    number-sections: true
    toc: false
    fig-width: 15
    fig-height: 10
execute:
  echo: false
  warning: false
  error: false
  cache: false
  enabled: true
---

# Introduction {#sec-intro}

Allogenic stem cell transplantation is one of the treatments with the lowest recurrence rate for blood diseases such as leukemia. In this treatment method, (1) diseased cells and healthy hematopoietic stem cells are simultaneously killed by anticancer drugs and radiation, and (2) healthy hematopoietic stem cells donated by another person are transplanted. One requirement for bone marrow transplantation (hematopoietic stem cell transplantation) is that the donor's white blood cell type, called HLA, matches the patient's HLA.[^hapro] While the matching probability between two random people is less than 1%, the most likely HLA match is between siblings, with a probability of approximately 30%. The matching probability between parents and children is very low. If there is no matched donor among blood relatives, the patient must seek a donor from an unrelated person. In Japan, the patient generally seeks unrelated donors through the Japan Marrow Donor Program (JMDP). However, coordination by the JMDP results in a long transplant process, and only 60% of registered patients receive a transplant [@Hirakawa2018].

[^hapro]: Recently, transplants between blood relatives with semi-matched HLA, called haploidentical transplants, have become widespread. In addition, the transplantation of blood cells contained in the umbilical cord and placenta connecting mother and child (cord blood transplant) has also become popular. Unlike bone marrow transplants, cord blood transplants can be performed even without the requirement of a perfect HLA match.

There are two types of policies for the donor pool to increase patient survival. The first type is to increase the number of potential donors, which increases the matching probability. Compared to when the patient matches fewer than four donors, when the patient matches more than 200 donors, the patient's transplant rate increases from 45% to 74% [@Hirakawa2018]. However, while the number of potential donors for JMDP has roughly doubled between 2000 and 2015, the probability of first-time matching has only increased by about 5% [@Takanashi2016].[^reason] In other words, increasing the pool size would be ineffective because the marginal benefit of increasing the number of potential donors is small.

[^reason]: This is because the probability of a new member with a rare HLA type is low.

The second type is to increase the proportion of people in the donor pool who are less likely to refuse to donate. This type of measure contributes to the quality of the donor pool. @Hirakawa2018 shows that many coordinations are interrupted before their first step, the confirmatory typing, due to the donor side reasons (see the @sec-background section for the coordination flow). Therefore, creating a pool with many potential donors who are willing to donate would increase the transplant rate. The marginal benefit of measures that improve the quality of the donor pool should be higher than that of measures that increase the size of the donor pool.

Then, this study examines the effectiveness of information provision as one policy improving the quality of the donor pool. When a person registered with the JMDP becomes a potential donor for a patient, the potential donor receives a compatibility notice from the JMDP. The potential donors who respond to the notification by indicating a willingness to donate then take coordination for transplantation. We added a message to the compatibility notice based on information published by the JMDP and conducted a field experiment from September 2021 to February 2022 to test the effect of the added message. We asked the JMDP to provide data on the coordination process (including whether or not they responded to the notification and their willingness to donate) for those who received the compatibility notice during the experimental period and analyze the effect of providing information.

There are two intervention messages. One is information that there are few potential donors per patient registered in the JMDP. Stem cell donation through JMDP is a public good since multiple potential donors per patient take coordination simultaneously. Thus, potential donors have the incentive to free-ride. The first message prevents potential donors from free-riding behavior caused by the over-estimated expectation about the number of other ongoing potential donors. Another message is that only about half of the patients registered with the JMDP receive transplants. This information aims to increase the value of the altruistic behavior of stem cell donation. Our field experiment shows that information about the small number of potential donors per patient encourages young males to reply to the compatibility notice and indicate their willingness to donate.

<!-- この研究は日本に限らず他国の類似する骨髄バンクにおける施策へ貢献するものである。JMDPでは、若年男性の移植成績が良いにも関わらず、ドナー都合によるコーディネーションの中断率が高い[@Hirakawa2018]。同様の問題はXXXXでも生じている。我々のフィールド実験はこの問題を解決するための一つの施策を提示できる。

また、この研究は経済学における一連の公共財研究にも貢献している。標準的な経済学は、公共財は自身の努力とは無関係に便益を受けられるという性質を持つので、自身がコストをかけて努力するインセンティブがなく、ただ乗り行動が生じることを指摘している。 -->


```{r}
#| label: library
#| include: false
#| vscode: {languageId: r}

library(here)
library(tidyverse)
library(lubridate)
library(estimatr)
library(fixest)
library(grf)
library(modelsummary)
library(kableExtra)
library(flextable)
library(officer)
library(RCTtoolbox)
library(patchwork)
lapply(list.files(here("R/func"), "r", full.names = TRUE), source)

options(
  knitr.table.format = "markdown",
  kableExtra.auto_format = FALSE,
  modelsummary_stars_note = FALSE,
  modelsummary_factory_default = "flextable",
  modelsummary_factory_html = "kableExtra",
  modelsummary_factory_latex = "kableExtra",
  modelsummary_factory_word = "flextable"
)
```


```{r}
#| label: outcome-label
#| include: false
#| vscode: {languageId: r}

root <- "E:/JMDPフィールド実験"

outcome_label <- list(
  reply = "Reply",
  positive = "Positive intention",
  negative = "Negative intention",
  test = "CT",
  candidate = "Candidate",
  consent = "Consent",
  donate = "Donation"
)
```

# Field Experiment {#sec-experiment}
## Background: Coordination Process of JMDP {#sec-background}


To promote an understanding of the timing of interventions in our field experiment, we provide an overview of the coordination process leading up to the donation of stem cells by a potential donor registered with the JMDP. First, when a potential donor matches a patient registered with the JMDP, the JMDP office sends the potential donor the compatibility notice requesting stem cell donation.[^SNS] The potential donor responds to the notification by filling out a medical questionnaire and indicating the willingness to donate.

[^SNS]: JMDP also sends the potential donor an SMS message informing that the JMDP sends the compatibility notice.

After that, the coordination for the transplant starts. The potential donor undergoes the confirmatory typing within approximately one month. In this step, the coordinator explains in detail the donation procedure (bone marrow collection and peripheral blood stem cell collection) and investigates the intentions of the potential donor and family. At this time, the potential donor can choose the collection method. In addition, the coordinating physician conducts an interview, medical examination, and general blood tests to determine the presence of infection and blood type. These tests examine whether the potential donor meets the criteria set by the JMDP.

Patients can proceed with coordination with up to 10 potential donors at the same time. The patient's physician selects the most suitable candidate from potential donors who take the confirmatory typing. Importantly, the potential donor does not know how many other donors the matched patient coordinates with. Nor can a potential donor obtain this information from the coordinator or coordinating physician.

The candidate needs to make a final consent after receiving explanations from the coordinator and coordinating physician. At this time, a representative of the donor's family must also consent to the collection. In addition, the candidate cannot change his/her intention after that. After giving final consent, the first candidate is hospitalized for approximately one week to take preoperative testing and prepare for collection. After this, the donor undergoes a procedure to collect the stem cells. The time between the confirmation test and collection is approximately 3-4 months.

## Experimental Design

![Intervention Messages](image/intervention.png){#fig-intervention}

Our intervention is the content of the compatibility notice in which the JMDP requests stem cell donations from potential donors. The @fig-intervention shows our intervention. Before the intervention, the compatibility notice states that the potential donor should return within seven days indicating to donate and completing a medical questionnaire. One of the materials enclosed along with the notification is a handbook that describes the coordination process, which we overview in the previous subsection.

We added two messages to the compatibility notice to facilitate coordination (@fig-intervention).[^pressure] The probability message highlights the small number of potential donors per patient registered with the JMDP. This message prevents overestimation of beliefs about the number of other ongoing potential donors and may discourage free-riding behavior in stem cell donation.

[^pressure]: When having made intervention messages, we have taken appropriate care not to put undue pressure on potential donors. First, we avoid messages that sound like a plea. Second, we use only publicly available information from the JMDP. Third, we explain the risks of transplantation as usual.

The patient message emphasizes that only half of the patients can receive a transplant through the JMDP. This message aims to correct the perception that patients are saved without the cooperation and to stimulate altruism in potential donors. Furthermore, emphasizing the importance of shortening the coordination time encourages early replies to the compatibility notice.

We made four experimental arms to estimate the effects of the two intervention messages. Experimental arm A sends the standard compatibility notice without intervention messages (control group). Experimental arms B and C receive the probability message and the patient message, respectively. In addition, to test the negative effect of cognitive load due to information overload, we also made an experimental arm D adding two intervention messages to one compatibility notice.

```{r}
#| label: read-schedule-data
#| include: false
#| vscode: {languageId: r}

schedule <- read_csv(here(root, "RCT-schedule.csv")) %>%
  mutate(
    my = paste0(month, "/", year - 2000),
    my = factor(
      my,
      levels = c("9/21", "10/21", "11/21", "12/21", "1/22", "2/22"),
      labels = c("Sep 21", "Oct 21", "Nov 21", "Dec 21", "Jan 22", "Feb 22")
    ),
    week = factor(week, levels = 1:4, labels = paste("Week", 1:4))
  ) %>%
  dplyr::select(week, my, treat) %>%
  pivot_wider(values_from = treat, names_from = my)
```

```{r}
#| label: tbl-assignment
#| tbl-cap: Assignment Schedule
#| vscode: {languageId: r}

flextable(schedule) %>%
  align(j = -1, align = "center", part = "all") %>%
  padding(j=1:7, padding.top = 5, padding.bottom = 5, part="all") %>%
  fontsize(size = 9, part = "all")  %>%
  ft_theme()
```

Our experimental subjects are 11,154 potential donors to whom the JMDP sent the compatibility notice between September 2021 and February 2022. The assignment of experimental groups is cluster-randomized based on a week because we preserve as much randomness as feasible by the JMDP office. We assigned four experimental groups to balance on week and month to remove week/month fixed effects. We summarize the assignment schedule in @tbl-assignment.

## Data and Empirical Strategy

```{r}
#| label: read-experiment-data
#| include: false
#| vscode: {languageId: r}

rawdt <- read_csv(here(root, "shaped.csv"), locale = locale(encoding = "cp932"))

use <- rawdt %>%
  dplyr::filter(ongoing == 0) %>%
  mutate(
    treat = factor(treat, levels = LETTERS[1:4]),
    plan_two_methods = if_else(plan_method == "BM/PB", 1, 0)
  )
```

```{r}
#| label: balance-test-ongoing
#| eval: false
#| vscode: {languageId: r}

lm_robust(
  ongoing ~ treat,
  data = rawdt,
  cluster = RCTweek,
  se_type = "stata"
) %>%
{
  f <- summary(.)$fstatistic[1]
  numdf <- summary(.)$fstatistic[2]
  dendf <- summary(.)$fstatistic[3]
  p <- pf(f, numdf, dendf, lower.tail = FALSE)

  sprintf("F-value = %1.3f; p-value = %1.3f", f, p)
}
```

We received the coordination data maintained by the JMDP at the end of June 2022. The observation unit is the experimental subject. As individual attributes, the data record gender, age, number of past coordination, and region of residence (at the prefectural level). For the coordination process, the data records whether or not to reach each step (reply to the compatibility notice, the confirmatory typing, the candidate selection, the final consent, and the collection). We use these variables as outcome variables. In particular, for replies to the compatibility notice, the data additionally record the number of days of reply and the intention to donate. If the coordination was interrupted, the data record the reason for the interruption in three categories (patient reasons, reasons other than donor's health, and donor's health reasons). In analysis, we use 11,049 individuals who reside in Japan and whose coordination has been completed [^exclude].

[^exclude]: one person resided abroad. There were also 104 persons for whom coordination was in progress when we received the data. The proportion of people with ongoing coordination is well balanced across experimental arms (F-value, p-value = $0.956$).

As additional data, we use the list of hospitals published by the JMDP on its website. In addition to hospital addresses, this data includes whether bone marrow (BM) collection and peripheral blood stem cell (PBSC) collection are available. We aggregate this data at the prefectural level, calculate the number of hospitals per 10 square kilometers, and merge it and the coordination data using the prefecture as a merge key. We consider this variable as the traveling cost of coordination and donation.

```{r}
#| label: experiment-summary
#| include: false

summary_stat <- use %>%
  select(
    male,
    age,
    coordinate,
    hospital_per_area,
    PB_per_area,
    BM_per_area,
    treat
  ) %>%
  group_by(treat) %>%
  summarize_all(mean) %>%
  mutate_at(vars(-treat), list(~sprintf("%1.3f", .))) %>%
  pivot_longer(-treat, names_to = "vars", values_to = "mean") %>%
  pivot_wider(names_from = "treat", values_from = "mean")

balance_p <- use %>%
  select(
    male,
    age,
    coordinate,
    hospital_per_area,
    PB_per_area,
    BM_per_area,
    treat,
    RCTweek
  ) %>%
  pivot_longer(male:BM_per_area, values_to = "value", names_to = "vars") %>%
  group_by(vars) %>%
  do(est = lm_robust(
    value ~ treat,
    clusters = RCTweek,
    se_type = "stata",
    data = .
  )) %>%
  summarize(
    vars = vars,
    f = summary(est)$fstatistic[1],
    numdf = summary(est)$fstatistic[2],
    dendf = summary(est)$fstatistic[3],
    p = sprintf("%1.3f", pf(f, numdf, dendf, lower.tail = FALSE))
  ) %>%
  select(vars, p)

balance_test <- summary_stat %>%
  dplyr::left_join(balance_p, by = "vars") %>%
  mutate(type = "C. Balance Test") %>%
  mutate(vars = recode(
    vars,
    "male" = "Male (=1)",
    "age" = "Age",
    "coordinate" = "Number of past coordinations",
    "hospital_per_area" = "Number of listed hospitals",
    "PB_per_area" = "Number of hospitals listed with PBSC collection",
    "BM_per_area" = "Number of hospitals listed with BM collection"
  ))

size <- with(use, sprintf("%1d", table(treat))) %>%
  {
    tribble(
      ~vars, ~A, ~B, ~C, ~D, ~p, ~type,
      "Standard notification", "X", "X", "X", "X", "", "A. Interventions",
      "Probability message", "", "X", "", "X", "", "A. Interventions",
      "Patients message", "", "", "X", "X", "", "A. Interventions",
      "N", .[1], .[2], .[3], .[4], "", "B. Sample Size"
    )
  }

tbl_experiment_summary <- bind_rows(size, balance_test)
```

```{r}
#| label: tbl-experiment-summary
#| tbl-cap: Overview of Field Experiment
#| output: asis
#| vscode: {languageId: r}

tbl_experiment_summary %>%
  rename(`F-test, p-value` = p) %>%
  as_grouped_data("type") %>%
  as_flextable(hide_grouplabel = TRUE) %>%
  add_header_row(values = c("", "Experimental Arms", ""), colwidths = c(1, 4, 1)) %>%
  align(j = -1, align = "center", part = "all") %>%
  padding(j=1:6, padding.top=5, padding.bottom = 5, part = "all") %>%
  padding(2:4, padding.left = 10) %>%
  padding(6, padding.left = 10) %>%
  padding(8:13, padding.left = 10) %>%
  width(j = 1, 2) %>%
  fontsize(size = 9, part = "all")  %>%
  ft_theme()
```

@tbl-experiment-summary summarizes the field experiments. Panel A shows the interventions for each experimental group, and Panel B shows the sample size for each experimental group. Panel C shows the balance test, which examines whether the randomization is successful. Since most covariates are well-balanced across groups, the clustered assignment is approximately random. However, potential donors in experimental groups C and D may be younger than those in experimental groups A and B (F-test, p-value = $0.067$).

Since potential donors cannot choose the experimental group, i.e., the experimental group is exogenous, a simple difference in means can identify the average treatment effect. However, this leads to bias because age and the number of weeks and months of the assignment are not perfectly balanced across experimental groups. Therefore, in addition to the difference-in-mean test, we estimate the following linear probability model for individual $i$ who received the compatibility notice in a week $w$ of month $m$.

$$
  Y_{imw} =
  \beta_1 \cdot \text{B}_{mw} + \beta_2 \cdot \text{C}_{mw}
  + \beta_3 \cdot \text{D}_{mw}
  + X'_i \gamma + \lambda_m + \theta_w + u_{imw},
$$

where $X_i$ is the individual attribute vector and $\lambda_m$ and $\theta_w$ are the week and month dummy variables, respectively. We use standard errors clustered at the experimental week level, a unit of randomization.

# Experimental Results {#sec-result}

```{r}
#| label: balance-test-exogeneous-stop-reply
#| eval: false

lm_robust(
  exg_stop_reply ~ treat,
  data = use,
  cluster = RCTweek,
  se_type = "stata"
) %>%
{
  f <- summary(.)$fstatistic[1]
  numdf <- summary(.)$fstatistic[2]
  dendf <- summary(.)$fstatistic[3]
  p <- pf(f, numdf, dendf, lower.tail = FALSE)

  sprintf("F-value = %1.3f; p-value = %1.3f", f, p)
}
```

```{r}
#| label: create-stock-data
#| include: false
#| vscode: {languageId: r}

stock <- use %>%
  dplyr::filter(exg_stop_reply == 0) %>%
  rename(positive = intention) %>%
  mutate(
    negative = reply * (1 - positive),
    age_demean = age - mean(rawdt$age),
  ) %>%
  select(reply, positive, negative, everything()) %>%
  pivot_longer(reply:negative, names_to = "outcome") %>%
  mutate(outcome = factor(
    outcome,
    levels = unlist(names(outcome_label)[1:3]),
    labels = unlist(outcome_label[1:3])
  ))
```

## Effects on Reply and Intention {#sec-reply}

To begin, we estimate the effect of our interventions on reply, which is the most likely manifestation of the potential donor's intention. The outcome variable for replying is a dummy variable that takes one if the potential donor replies to the compatibility notice regardless of donor intention. We decompose the message effect on response to the notification into two parts. The first is the effect on replying with a positive intention. For estimation, the outcome variable is a dummy variable that takes one if the potential donor replied to the notice and indicated the willingness to donate. The second is the effect on replying with a negative intention. The outcome variable is a dummy variable that takes one if the potential donor replied to the notice and did not indicate the willingness to donate. When estimating these effects, we include non-responders in the sample, coding their outcomes as 0. Since the sum of the two outcome variables for the intention to donate is always equal to the dummy variable for the reply, the sum of the effects on the positive and negative intentions is always the effect on replying. The response rate is $88.35$% in the control arm. The proportion of replying with positive intention is $55.33$%, while the proportion of replying with negative intention is $33.03$% in the control arm. Thus, $62.63$% of potential donors who replied to the compatibility notice were willing to donate.

The coordination may be interrupted by the patient before potential donors reply. Since this case occurs independently of the potential donor's intention, we exclude it from the sample in our analysis. We exclude $0.5$--$0.7$% of each experimental group, and the proportions are well balanced across groups (F-test, p-value=$0.242$).

```{r}
#| label: est-full-reply
#| include: false

mod <- list(
  unctrl = value ~ treat,
  ctrl = value ~ treat + age_demean + I(age_demean^2) + male + coordinate +
    hospital_per_area + PB_per_area + BM_per_area +
    factor(prefecture) + factor(month) + factor(week)
)

est_stock <- stock %>%
  group_by(outcome) %>%
  nest() %>%
  mutate(
    fit1 = map(
      data,
      ~ lm_robust(
        mod$unctrl,
        data = .,
        cluster = RCTweek,
        se_type = "stata"
      )
    ),
    fit2 = map(
      data,
      ~ lm_robust(
        mod$ctrl,
        data = .,
        cluster = RCTweek,
        se_type = "stata"
      )
    )
  ) %>%
  pivot_longer(
    fit1:fit2,
    names_prefix = "fit",
    names_to = "model",
    values_to = "fit"
  )

ctrl_avg <- stock %>%
  dplyr::filter(treat == "A") %>%
  group_by(outcome) %>%
  summarize(mean = sprintf("%1.4f", mean(value)))

add_table <- tibble::tribble(
  ~term, ~"(1)", ~"(2)", ~"(3)", ~"(4)", ~"(5)", ~"(6)",
  "Control average", ctrl_avg$mean[1], ctrl_avg$mean[1],
  ctrl_avg$mean[2], ctrl_avg$mean[2],
  ctrl_avg$mean[3], ctrl_avg$mean[3],
  "Covariates", "", "X", "", "X", "", "X"
)

attr(add_table, "position") <- 9:12

tbl_est_stock <- est_stock %>%
  pull(fit) %>%
  setNames(paste0("(", seq_len(length(.)), ")")) %>%
  modelsummary(
    coef_map = c(
      "(Intercept)" = "Constant",
      "treatB" = "Treatment B",
      "treatC" = "Treatment C",
      "treatD" = "Treatment D"
    ),
    stars = c("***" = .01, "**" = .05, "*" = .1),
    fmt = 4,
    gof_omit = "R2|AIC|BIC|Log|Std|FE|se_type",
    add_rows = add_table,
  )
```

```{r}
#| label: tbl-full-reply
#| tbl-cap: Linear Probability Model of Replay and Intention
#| vscode: {languageId: r}

tbl_est_stock %>%
  add_header_row(
    values = c("", "Reply", "Positive", "Negative"),
    colwidths = c(1, 2, 2, 2)
  ) %>%
  add_header_row(
    values = c("", "Intention"),
    colwidths = c(3, 4)
  ) %>%
  align(j = -1, align = "center", part = "all") %>%
  add_footer_lines(paste(
    "Notes: * p < 0.1, ** p < 0.05, *** p < 0.01.",
    "Standard errors clustered by experimental weeks",
    "are reported in parentheses.",
    "Covariates are gender, squared polynomial of (demeaned) age,",
    "number of past coordinations,",
    "number of hospitals per 10 square kilometers,",
    "number of hospitals with PBSC collection per 10 square kilometers,",
    "number of hospitals with BM collection per 10 square kilometers,",
    "prefecture dummies, month dummies, and week dummies."
  )) %>%
  width(j = 1, 1) %>%
  fontsize(size = 9, part = "all")  %>%
  ft_theme()
  # kableExtra::kable_styling() %>%
  # kableExtra::add_header_above(c(
  #   " " = 1, "Reply" = 2, "Positive" = 2, "Negative" = 2
  # )) %>%
  # kableExtra::add_header_above(c(
  #   " " = 3, "Intention" = 4
  # )) %>%
  # kableExtra::footnote(
  #   paste(
      # "* p < 0.1, ** p < 0.05, *** p < 0.01.",
      # "Standard errors clustered by experimental weeks",
      # "are reported in parentheses.",
      # "Covariates are gender, squared polynomial of (demeaned) age,",
      # "number of past coordinations,",
      # "number of hospitals per 10 square kilometers,",
      # "number of hospitals with PBSC collection per 10 square kilometers,",
      # "number of hospitals with BM collection per 10 square kilometers,",
      # "prefecture dummies, month dummies, and week dummies."
  #   ),
  #   threeparttable = TRUE
  # )
```

@tbl-full-reply は線形確率モデルの推定結果である。奇数列は実験群ダミーのみを説明変数として用いているのに対して、偶数列は個人属性や月・週の固定効果も制御している。列(1)は、確率メッセージを加えた適合通知を送付する実験群Bが返信率を1ポイントもしくは$1.2$%高めていることを示している。個人属性などをコントロールする（列(2)）と、効果のサイズは大きく変化しないが、統計的に5%水準で有意となる。この効果は正の意向を伴った返信の増加に由来している。列(3)と(5)では、実験群Bが正の意向を伴った返信率を2ポイントもしくは$3.94$%高めている一方で、負の意向を伴った返信率を1ポイントもしくは$3.42$%下げている。ただし、これらの統計的な有意性は弱い。また、実験群CとDは実験群Bよりも効果のサイズが小さく、統計的に非有意である。我々は頑健性の分析としてロジットモデルを推定した（@full-reply-logit）。その結果は効果の方向について上表と整合的であるが、統計的に非有意である。総合すると、我々の介入は全体的に返信に大きな影響を与えていない。

```{r}
#| label: est-subsample-reply
#| include: false

est_stock_sub <- stock %>%
  mutate(age_less30 = if_else(age < 30, 1, 0)) %>%
    group_by(outcome, male, age_less30) %>%
    nest() %>%
    mutate(est = map(data, ~ lm_robust(
      update(mod$ctrl, . ~ . - male - age_demean),
      cluster = RCTweek,
      se_type = "stata",
      data = .x
    )))

plotdt_stock_sub <- est_stock_sub %>%
  mutate(
    fit = map(est, tidy),
    fit = map(fit, ~ subset(.x, str_detect(term, "treat"))),
    fit = map(fit, ~ dplyr::select(.x, -outcome)),
    N = map_chr(est, ~ paste("N =", nobs(.x))),
    mean = map_dbl(data, ~ with(subset(., treat == "A"), mean(value))),
    mean = sprintf("Control avg = %1.3f", mean)
  ) %>%
  select(-data, -est) %>%
  unnest(cols = fit) %>%
  mutate(
    pos = paste0(male, age_less30),
    pos = factor(
      pos,
      levels = c("01", "00", "11", "10"),
      labels = c(
        "Female\u00d7\nAge<30",
        "Female\u00d7\n30\u2264Age",
        "Male\u00d7\nAge<30",
        "Male\u00d7\n30\u2264Age"
      )
    ),
    term = str_replace(term, "treat", ""),
    term = factor(term, LETTERS[2:4])
  )

text <- plotdt_stock_sub %>%
  select(male, age_less30, pos, N, mean) %>%
  distinct()
```

```{r}
#| label: fig-subsample-reply
#| fig-cap: 'Effect on Reply and Intentions by Gender and Age Group. Note: These plots show the average effect (and associated 95% confidential interval) on each outcome by gender and age group. We cluster standard errors by experimental weeks. We control number of past coordinations, number of hospitals per 10 square kilometers, number of hospitals with PBSC collection per 10 square kilometers, number of hospitals with BM collection per 10 square kilometers, prefecture dummies, month dummies, and week dummies.'
#| vscode: {languageId: r}

plot_list <- unique(plotdt_stock_sub$outcome) %>%
  purrr::map(function(x) {
    subset(plotdt_stock_sub, outcome == x) %>%
      ggplot(aes(x = pos, y = estimate)) +
      geom_hline(aes(yintercept = 0), linetype = 2) +
      geom_point(
        aes(color = term, shape = term),
        size = 3, position = position_dodge(0.5)
      ) +
      geom_errorbar(
        aes(ymin = conf.low, ymax = conf.high, color = term),
        position = position_dodge(0.5),
        width = 0
      ) +
      geom_text(
        aes(y = -0.125, label = N),
        data = subset(text, outcome == x),
        color = "black"
      ) +
      geom_text(
        aes(y = -0.15, label = mean),
        data = subset(text, outcome == x),
        color = "black"
      ) +
      scale_y_continuous(
        breaks = seq(-0.2, 0.2, by = 0.05), limits = c(-0.17, 0.17)
      ) +
      labs(
        title = paste("Outcome:", x),
        x = "Subset",
        y = "Estimated Effects (95%CI)",
        color = "Treatment", shape = "Treatment"
      ) +
      simplegg()
  })

wrap_plots(plot_list, ncol = 2) +
  plot_layout(guides = "collect") &
  theme(legend.position = "bottom")
```

次に、メッセージの効果の異質性を検証するために、我々は性別と年齢層（30歳未満かどうか）でサンプルを4分割して、各サブセットでメッセージの効果を推定している。 @fig-subsample-reply はその係数プロットである。その結果、確率メッセージを加えた実験群BとDは30歳未満の男性の返信率を6ポイントもしくは$8.06$%高めている（ベースラインの返信率は$74.4$%）。

確率メッセージだけを加えた実験群Bの効果は正の意向を伴う返信率の増加に起因している。このグループで、実験群Bは正の意向を伴う返信率を10ポイントもしくは$25.91$%高めている（ベースラインの比率は$38.6$%）が、負の意向を伴う返信率を3ポイントもしくは$8.38$%下げている（ベースラインの比率は$35.8$%）。これらは統計的に有意な効果である。一方で、確率メッセージと利他メッセージを加えた実験群Dは正の意向を伴う返信と負の意向を伴う返信を同程度増やしている。特に、実験群Dは負の意向を伴う返信率を3ポイントもしくは$8.38$%高めていて、これは統計的に有意である。

他の性年代のグループ（とくに、30歳以上の男女）では、介入メッセージが返信や意向に大きな影響を与えていない。ただし、30歳未満の女性で、実験群Dが正の意向を伴う返信率を$0.05$もしくは$9.69$%下げている。したがって、他のドナー候補者が少ないというメッセージは若年男性の提供意向を高め、適合通知への返信を促している。若年男性ドナーは移植成績が良いにも関わらず、提供意向が他の性年代よりも明らかに低いことを考慮すると、確率メッセージは移植コーディネーションの効率性を改善しているといえる。

## Robustness to Heterogenous Effect {#sec-robustness}

メッセージ効果の異質性についていくつかの頑健性の分析を行う。はじめに、ワイルドクラスターブートストラップ法でp値を計算する。クラスターの数が少ないと、クラスター標準誤差は帰無仮説を過剰に棄却してしまう。それを修正するために、ワイルドクラスターブートストラップ法を用いる。@tbl-young-reply は30歳未満の女性（列(1)--(3)）と30歳未満の男性（列(4)--(6)）でサンプルを限定して推定している。その結果、ワイルドブートストラップ法でも確率メッセージが30歳未満男性の返信、特に正の意向を伴う返信を増やすという結果を得られる。ただし、それ以外の効果はワイルドブートストラップ法によって棄却できなくなる。

```{r}
#| label: est-int-rcf
#| include: false

covariate <- ~ 0 + male + age + coordinate + hospital_per_area +
  PB_per_area + BM_per_area

Y <- use$intention
X <- model.matrix(covariate, data = use)
W <- use$treat
G <- use$RCTweek

int_rcf <- multi_arm_causal_forest(X, Y, W)
int_tau <- predict(int_rcf, X)
```

```{r}
#| label: fig-int-rcf
#| fig-cap: Distribution of Individual Treatment Effects on Intention Estimated by Random Causal Forest.

predict_int_rcf <- data.frame(X) %>%
  cbind(int_tau$predictions) %>%
  rename(
    effect_B = `B - A.Y.1`,
    effect_C = `C - A.Y.1`,
    effect_D = `D - A.Y.1`
  ) %>%
  pivot_longer(
    effect_B:effect_D,
    names_to = c(".value", "treat"),
    names_sep = "_"
  ) %>%
  mutate(
    treat = factor(treat, labels = paste("Message", LETTERS[2:4])),
    age_less30 = if_else(age < 30, 1, 0),
    pos = paste0(male, age_less30),
    pos = factor(
      pos,
      levels = c("01", "00", "11", "10"),
      labels = c(
        "Female\u00d7\nAge<30",
        "Female\u00d7\n30\u2264Age",
        "Male\u00d7\nAge<30",
        "Male\u00d7\n30\u2264Age"
      )
    )
  )

predict_int_rcf %>%
  ggplot(aes(x = effect, y = after_stat(count) / sum(after_stat(count)))) +
  geom_histogram(
    aes(fill = effect > 0),
    breaks = seq(-.2, .2, by = .01),
    color = "black"
  ) +
  scale_fill_manual(values = c("white", "red")) +
  facet_grid(treat~pos) +
  labs(
    x = "Treatment effects",
    y = "Fraction"
  ) +
  simplegg() +
  theme(legend.position = "none")
```

```{r}
#| label: est-int-rcf-cate
#| include: false

subset_cond <- list(
  X[, "male"] == 0 & X[, "age"] < 30,
  X[, "male"] == 0 & X[, "age"] >= 30,
  X[, "male"] == 1 & X[, "age"] < 30,
  X[, "male"] == 1 & X[, "age"] >= 30
)

ate_int_rcf <- subset_cond %>%
  purrr::map(~ average_treatment_effect(int_rcf, subset = .)) %>%
  reduce(bind_rows) %>%
  mutate(
    z = abs(estimate / std.err),
    p = 2 * pnorm(z, lower.tail = FALSE),
    gender = rep(c("Females", "Males"), each = 6),
    age = rep(c("Young", "Elder", "Young", "Elder"), each = 3)
  )

tbl_int_rcf <- ate_int_rcf %>%
  select(gender, age, contrast, estimate, std.err, p) %>%
  pivot_wider(names_from = gender, values_from = estimate:p) %>%
  select(age, contrast, ends_with("Females"), ends_with("Males")) %>%
  mutate(contrast = str_extract(contrast, "[B-D]"))
```

```{r}
#| label: tbl-int-rcf-cate
#| tbl-cap: Conditional Average Treatment Effect Estimated by RCF.

tbl_int_rcf %>%
  mutate(age = recode(
    age,
    "Young" = "Age: Less than 30",
    "Elder" = "Age: More than or equal to 30"
  )) %>%
  as_grouped_data("age") %>%
  as_flextable(hide_grouplabel = TRUE) %>%
  set_header_labels(
    contrast = "",
    estimate_Females = "Estimate",
    std.err_Females = "S.E.",
    p_Females = "P-value",
    estimate_Males = "Estimate",
    std.err_Males = "S.E.",
    p_Males = "P-value"
  ) %>%
  add_header_row(values = c("", "Females", "Males"), colwidths = c(1, 3, 3)) %>%
  align(j = -1, align = "center", part = "all") %>%
  colformat_double(j = -1, digits = 3) %>%
  padding(j=1:7, padding.top = 5, padding.bottom = 5, part = "all") %>%
  padding(2:4, padding.left = 10) %>%
  padding(6:8, padding.left = 10) %>%
  fontsize(size = 9, part = "all")  %>%
  ft_theme()
```

次に、random causal forestによって効果の異質性を検証する。この手法は与えられた共変量の組合せでサンプルを分割し、各サブサンプル内でトリートメント効果を推定する。これにより、研究者によって与えられた共変量で特徴づけられるサンプルの個別の介入効果を得られる。サンプルを分割する共変量の組合せは推定されるサブサンプルのトリートメント効果の平均二乗誤差を最小にするように決める。裏返すと、これは各サブサンプルのトリートメント効果の分散を最大にすることである。

@fig-int-rcf-cate は各実験群の正の意向を伴う返信に対する効果の分布である。特徴的な結果は30歳未満の男性の90%が実験群Bに対してポジティブな反応を示していることである。random causal forestは実験群Bの30歳未満の男性に対する平均効果が12.5ポイントであり、統計的に有意である（@tbl-int-rcf-cate）。これは@fig-subsample-reply で得られた推定値とほとんど一致する。

また、他の性年代グループに対して、介入群の効果は統計的に非有意である。これは介入群に対してポジティブな反応を示す人とネガティブな反応を示す人が同程度に存在しているからである。では、どのような特徴を持った人がポジティブな反応を示しやすいのだろうか。我々は各性年代グループの中で正の影響を受ける人とそうでない人の平均的な個人属性の差を検証した（@tbl-covariate-int-rcf）。30歳以上の男女のグループでは、高齢の人や過去のコーディネート経験が多い人がメッセージにポジティブな反応を示しやすい。また、30歳以上の女性のグループでは、病院の数が多い人がメッセージにポジティブな反応を示しやすい一方で、30歳以上の男性のグループでは、病院の数が少ない人がメッセージにポジティブな反応を示しやすい。30歳未満の女性のグループでは、若い人がメッセージにポジティブな反応を示しやすい。また、このグループでは、過去のコーディネート経験が多い人ほど介入群CとDにポジティブな反応を示しやすく、病院の数が多い人ほど介入群Dにポジティブな反応を示しやすい。

```{r}
#| label: est-correlation-int-rcf
#| include: false

int_tau_pred <- int_tau$predictions[, , 1]

est_tau_corr1 <- subset_cond %>%
  purrr::map(~ lm_robust(
    int_tau_pred[., 3] ~ int_tau_pred[., 1] + int_tau_pred[., 2],
    se_type = "HC0"
  ))

int_tau_pred_abs <- abs(int_tau$predictions[, , 1])
est_tau_corr2 <- subset_cond %>%
  purrr::map(~ lm_robust(
    int_tau_pred_abs[., 3] ~ int_tau_pred_abs[., 1] + int_tau_pred_abs[., 2],
    se_type = "HC0"
  ))

tbl_tau_corr <- list(est_tau_corr1, est_tau_corr2) %>%
  flatten() %>%
  setNames(paste0("(", seq_len(length(.)), ")")) %>%
  modelsummary(
    coef_map = c(
      "(Intercept)" = "Constant",
      "int_tau_pred[., 1]" = "Predicted effect of B",
      "int_tau_pred[., 2]" = "Predicted effect of C",
      "int_tau_pred_abs[., 1]" = "Abosulte of predicted effect of B",
      "int_tau_pred_abs[., 2]" = "Abosulte of predicted effect of C"
    ),
    stars = c("***" = .01, "**" = .05, "*" = .1),
    fmt = 4,
    gof_omit = "R2|AIC|BIC|Log|Std|FE|se_type|RMSE"
  )
```

```{r}
#| label: tbl-correlation-int-rcf
#| tbl-cap: Correlation of Predicted Tratment Effects

tbl_tau_corr %>%
  add_header_row(
    values = c("", rep(c("Age<30", "30\u2264Age", "Age<30", "30\u2264Age"), 2))
  ) %>%
  add_header_row(
    values = c("", rep(c("Females", "Males"), 2)),
    colwidths = c(1, 2, 2, 2, 2)
  ) %>%
  add_header_row(
    values = c("", "Predicted effect of D", "Absolute of predicted effect of D"),
    colwidths = c(1, 4, 4)
  ) %>%
  align(j = -1, align = "center", part = "all") %>%
  add_footer_lines(paste(
    "Notes: * p < 0.1, ** p < 0.05, *** p < 0.01.",
    "Robust standard errors are reported in parentheses."
  )) %>%
  width(j = 1, 1) %>%
  fontsize(size = 9, part = "all") %>%
  ft_theme()
```

## Response Speed to Notification

```{r}
#| label: create-flow-data
#| include: false
#| vscode: {languageId: r}

flow <- stock %>%
  mutate(
    days_reply = if_else(is.na(days_reply), 10000, days_reply),
    days4 = if_else(days_reply <= 4, value, 0),
    days7 = if_else(days_reply <= 7, value, 0),
    days10 = if_else(days_reply <= 10, value, 0),
    days14 = if_else(days_reply <= 14, value, 0),
    days21 = if_else(days_reply <= 21, value, 0),
    days28 = if_else(days_reply <= 28, value, 0)
  ) %>%
  select(-value) %>%
  pivot_longer(days4:days28, names_to = "within", names_prefix = "days") %>%
  mutate(within = as.numeric(within))
```

我々のデータは返信日数を含んでいるので、効果の経時的な推移を検証する。そこで、$d$日以内に返信する確率$\text{Pr}(D_{imw} \le d)$を線形確率モデルで推定する。このとき、アウトカム変数は$d$日以内に返信したならば1を取るようなダミー変数である。$d$の値を十分に大きくすると、$\text{Pr}(D_{imw} \le d)$に対する効果は前小節で示した返信に対する効果と一致する。また、前小節と同様に、$\text{Pr}(D_{imw} \le d)$に対する効果を提供意向の観点から二つの効果に分解する。正の意向については、提供意向があり、かつ$d$日以内に返信したならば1を取るようなダミー変数である。負の意向については、提供意向がなく、かつ$d$日以内に返信したならば1を取るようなダミー変数である。

```{r}
#| label: est-subsample-speed
#| include: false
#| vscode: {languageId: r}

est_flow_sub <- flow %>%
  mutate(age_less30 = if_else(age < 30, 1, 0)) %>%
  dplyr::filter(age_less30 == 1) %>%
  group_by(outcome, within, male) %>%
  nest() %>%
  mutate(
    fit = map(data, ~ lm_robust(
      update(mod$ctrl, . ~ . - male - age_demean),
      cluster = RCTweek,
      se_type = "stata",
      data = .x
    )),
    avg = map_chr(data, ~ sprintf(
      "%1d\n(%1.3f)", within, with(subset(.x, treat == "A"), mean(value))
    ))
  ) %>%
  mutate(
    tidy = map(fit, tidy),
    tidy = map(tidy, ~ subset(.x, str_detect(term, "treat"))),
    tidy = map(tidy, ~ dplyr::select(.x, -outcome))
  ) %>%
  dplyr::select(-data, -fit) %>%
  unnest(cols = tidy) %>%
  mutate(
    term = str_replace(term, "treat", ""),
    term = factor(term, LETTERS[2:4])
  )

est_flow_sub
```

```{r}
#| label: fig-young-male-speed
#| fig-cap: 'Effect on Reply within Specific Days after Sending Notification among Males Less than 30. Notes: These plots show the average effect (and associated 95% confidential interval) on each outcome.'
#| vscode: {languageId: r}

plot_list_male <- unique(est_flow_sub$outcome) %>%
  purrr::map(function(x) {
    subset(est_flow_sub, male == 1 & outcome == x) %>%
      ggplot(aes(x = within, y = estimate, color = term, shape = term)) +
      geom_hline(aes(yintercept = 0), linetype = 2) +
      geom_point(size = 3, position = position_dodge(2)) +
      geom_errorbar(
        aes(ymin = conf.low, ymax = conf.high),
        position = position_dodge(2),
        width = 0
      ) +
      scale_x_continuous(
        breaks = subset(est_flow_sub, male == 1 & outcome == x)$within,
        labels = subset(est_flow_sub, male == 1 & outcome == x)$avg
      ) +
      scale_y_continuous(
        breaks = seq(-0.2, 0.2, by = 0.05), limits = c(-0.1, 0.2)
      ) +
      labs(
        title = paste("Outcome:", x),
        x = "Days after sending notification\n(Control average)",
        y = "Estimated Effects (95%CI)",
        color = "Treatment", shape = "Treatment"
      ) +
      simplegg()
  })

wrap_plots(plot_list_male, ncol = 2) +
  plot_layout(guides = "collect") &
  theme(legend.position = "bottom")
```


我々の介入メッセージの効果は異質的であるので、返信スピードに対する効果も異質性に注目する。@fig-young-male-speed は30歳未満の男性にサンプルを限定している。JMDPは適合通知に返信の目安として7日を明記している。このサブサンプルの統制群において、7日以内に返信した人の割合は21%である。また、返信日数が早ければ早いほど、適合通知に返信した人の中で提供したいと考える人が多く存在する。例えば、4日以内に返信した人の68%が提供したいと考えており、28日以内に返信した人の51%が提供したいと考えている。言い換えれば、返信が遅い人ほど、提供の意思を持っていない可能性がある。

この性年代グループでは、確率メッセージのみを加えた介入群Bが正の意向を伴う返信を増やしていることが明らかになった。この効果は主に返信に10日以上かかるドナー候補者の行動によって生じている。介入群Bは10日以内の返信や正の意向を伴う返信に対して統計的に有意な効果を持っていないが、14--28日以内の返信や正の意向を伴う返信に対して統計的に有意な効果を持っている。また、特筆すべき結果として、介入群Bは7--10日以内に負の意向を伴って返信する確率を下げている。

```{r}
#| label: fig-young-female-speed
#| fig-cap: 'Effect on Reply within Specific Days after Sending Notification among Females Less than 30. Notes: These plots show the average effect (and associated 95% confidential interval) on each outcome.'
#| vscode: {languageId: r}

plot_list_female <- unique(est_flow_sub$outcome) %>%
  purrr::map(function(x) {
    subset(est_flow_sub, male == 0 & outcome == x) %>%
      ggplot(aes(x = within, y = estimate, color = term, shape = term)) +
      geom_hline(aes(yintercept = 0), linetype = 2) +
      geom_point(size = 3, position = position_dodge(2)) +
      geom_errorbar(
        aes(ymin = conf.low, ymax = conf.high),
        position = position_dodge(2),
        width = 0
      ) +
      scale_x_continuous(
        breaks = subset(est_flow_sub, male == 0 & outcome == x)$within,
        labels = subset(est_flow_sub, male == 0 & outcome == x)$avg
      ) +
      scale_y_continuous(
        breaks = seq(-0.2, 0.2, by = 0.05), limits = c(-0.2, 0.2)
      ) +
      labs(
        title = paste("Outcome:", x),
        x = "Days after sending notification\n(Control average)",
        y = "Estimated Effects (95%CI)",
        color = "Treatment", shape = "Treatment"
      ) +
      simplegg()
  })

wrap_plots(plot_list_female, ncol = 2) +
  plot_layout(guides = "collect") &
  theme(legend.position = "bottom")
```

@fig-young-female-speed は30歳未満の女性にサンプルを限定している。その結果、

## Effects on Coordination Process {#sec-process}

```{r}
#| label: create-coordination-data
#| include: false
#| vscode: {languageId: r}

exclude <- use %>%
  select(id, starts_with("exg_stop")) %>%
  pivot_longer(
    -id,
    names_to = "outcome", values_to = "exclude",
    names_prefix = "exg_stop_"
  )

coordination <- use %>%
  select(test, candidate, consent, donate, everything()) %>%
  pivot_longer(test:donate, names_to = "outcome") %>%
  dplyr::left_join(exclude, by = c("id", "outcome")) %>%
  mutate(
    age_demean = age - mean(rawdt$age),
    outcome = factor(
      outcome,
      levels = unlist(names(outcome_label)[4:7]),
      labels = unlist(outcome_label[4:7])
    )
  )
```

```{r}
#| label: est-full-coordination
#| include: false

est_coordination <- coordination %>%
  group_by(outcome) %>%
  nest() %>%
  mutate(
    fit1 = map(
      data,
      ~ lm_robust(
        mod$unctrl,
        data = subset(., exclude == 0),
        cluster = RCTweek,
        se_type = "stata"
      )
    ),
    fit2 = map(
      data,
      ~ lm_robust(
        mod$ctrl,
        data = subset(., exclude == 0),
        cluster = RCTweek,
        se_type = "stata"
      )
    ),
    avg = map_chr(
      data,
      ~ with(
        subset(., exclude == 0 & treat == "A"),
        sprintf("%.4f", mean(value))
      )
    )
  ) %>%
  pivot_longer(
    fit1:fit2,
    names_prefix = "fit",
    names_to = "model",
    values_to = "fit"
  ) %>%
  select(- data)

add_table <- c("Control average", est_coordination$avg) %>%
  rbind(c("Covariates", "", "X", "", "X", "", "X", "", "X")) %>%
  data.frame()

attr(add_table, "position") <- c(9, 10)

tbl_est_coordination <- est_coordination %>%
  pull(fit) %>%
  modelsummary(
    coef_map = c(
      "(Intercept)" = "Constant",
      "treatB" = "Treatment B",
      "treatC" = "Treatment C",
      "treatD" = "Treatment D"
    ),
    stars = c("***" = .01, "**" = .05, "*" = .1),
    fmt = 4,
    gof_omit = "R2|AIC|BIC|Log|Std|FE|se_type",
    add_rows = add_table
  )
```

```{r}
#| label: tbl-full-coordination
#| tbl-cap: Linear Probability Model of Coordination Process.
#| output: asis
#| vscode: {languageId: r}

tbl_est_coordination %>%
  add_header_row(
    values = c("", "CT", "Candidate", "Consent", "Donation"),
    colwidths = c(1, 2, 2, 2, 2)
  ) %>%
  align(j = -1, align = "center", part = "all") %>%
  add_footer_lines(paste(
    "Notes: * p < 0.1, ** p < 0.05, *** p < 0.01.",
    "Standard errors clustered by experimental weeks",
    "are reported in parentheses.",
    "Covariates are gender, squared polynomial of (demeaned) age,",
    "number of past coordinations,",
    "number of hospitals per 10 square kilometers,",
    "number of hospitals with PBSC collection per 10 square kilometers,",
    "number of hospitals with BM collection per 10 square kilometers,",
    "prefecture dummies, month dummies, and week dummies."
  )) %>%
  width(j = 1, 1) %>%
  fontsize(size = 9, part = "all") %>%
  ft_theme()
  # kableExtra::kable_styling() %>%
  # kableExtra::add_header_above(c(
  #   " " = 1, "CT" = 2, "Candidate" = 2, "Consent" = 2, "Donation" = 2
  # )) %>%
  # kableExtra::footnote(
  #   paste(
  #     "* p < 0.1, ** p < 0.05, *** p < 0.01.",
  #     "Standard errors clustered by experimental weeks",
  #     "are reported in parentheses.",
  #     "Covariates are gender, squared polynomial of (demeaned) age,",
  #     "number of past coordinations,",
  #     "number of hospitals per 10 square kilometers,",
  #     "number of hospitals with PBSC collection per 10 square kilometers,",
  #     "number of hospitals with BM collection per 10 square kilometers,",
  #     "prefecture dummies, month dummies, and week dummies."
  #   ),
  #   threeparttable = TRUE
  # )
```

```{r}
#| label: est-subsample-coordination
#| include: false
#| vscode: {languageId: r}

est_coordination_sub <- coordination %>%
  mutate(age_less30 = if_else(age < 30, 1, 0)) %>%
  group_by(outcome, male, age_less30) %>%
  nest() %>%
  mutate(est = map(data, ~ lm_robust(
    update(mod$ctrl, . ~ . - male - age_demean),
    cluster = RCTweek,
    se_type = "stata",
    data = subset(.x, exclude == 0)
  )))

pdt_coordination_sub <- est_coordination_sub %>%
  mutate(
    fit = map(est, tidy),
    fit = map(fit, ~ subset(.x, str_detect(term, "treat"))),
    fit = map(fit, ~ dplyr::select(.x, -outcome)),
    N = map_chr(est, ~ paste("N =", nobs(.x))),
    mean = map_dbl(data, ~ with(subset(., exclude == 0 & treat == "A"), mean(value))),
    mean = sprintf("Control avg = %1.3f", mean)
  ) %>%
  select(-data, -est) %>%
  unnest(cols = fit) %>%
  mutate(
    pos = paste0(male, age_less30),
    pos = factor(
      pos,
      levels = c("01", "00", "11", "10"),
      labels = c(
        "Female\u00d7\nAge<30",
        "Female\u00d7\n30\u2264Age",
        "Male\u00d7\nAge<30",
        "Male\u00d7\n30\u2264Age"
      )
    ),
    term = str_replace(term, "treat", ""),
    term = factor(term, LETTERS[2:4])
  )

text <- pdt_coordination_sub %>%
  ungroup() %>%
  select(male, age_less30, pos, N, mean, outcome) %>%
  distinct()
```

```{r}
#| label: fig-subsample-coordination
#| fig-cap: 'Effect on Coordination by Gender and Age Group. Note: These plots show the average effect (and associated 95% confidential interval) on each outcome by gender and age group. We cluster standard errors by experimental weeks. We control number of past coordinations, number of hospitals per 10 square kilometers, number of hospitals with PBSC collection per 10 square kilometers, number of hospitals with BM collection per 10 square kilometers, prefecture dummies, month dummies, and week dummies.'
#| vscode: {languageId: r}

plot_list <- unique(pdt_coordination_sub$outcome) %>%
  purrr::map(function(x) {
    subset(pdt_coordination_sub, outcome == x) %>%
      ggplot(aes(x = pos, y = estimate)) +
      geom_hline(aes(yintercept = 0), linetype = 2) +
      geom_point(
        aes(color = term, shape = term),
        size = 3, position = position_dodge(0.5)
      ) +
      geom_errorbar(
        aes(ymin = conf.low, ymax = conf.high, color = term),
        position = position_dodge(0.5),
        width = 0
      ) +
      geom_text(
        aes(y = -0.1, label = N),
        data = subset(text, outcome == x),
        color = "black"
      ) +
      geom_text(
        aes(y = -0.125, label = mean),
        data = subset(text, outcome == x),
        color = "black"
      ) +
      scale_y_continuous(
        breaks = seq(-0.2, 0.2, by = 0.05), limits = c(-0.15, 0.2)
      ) +
      labs(
        title = paste("Outcome:", x),
        x = "Subset",
        y = "Estimated Effects (95%CI)",
        color = "Treatment", shape = "Treatment"
      ) +
      simplegg()
  })

wrap_plots(plot_list, ncol = 2) +
  plot_layout(guides = "collect") &
  theme(legend.position = "bottom")
```

```{r}
#| label: est-donate-rcf
#| include: false
#| eval: false

donate <- subset(coordination, outcome == "Donation")
Y <- donate$value
X <- model.matrix(covariate, data = donate)
W <- donate$treat
G <- donate$RCTweek

donate_rcf <- multi_arm_causal_forest(X, Y, W)
donate_tau <- predict(donate_rcf, X)
```

```{r}
#| label: fig-donate-rcf
#| fig-cap: Distribution of Individual Treatment Effects on Donation Estimated by Random Causal Forest.
#| eval: false

predict_donate_rcf <- data.frame(X) %>%
  cbind(donate_tau$predictions) %>%
  rename(
    effect_B = `B - A.Y.1`,
    effect_C = `C - A.Y.1`,
    effect_D = `D - A.Y.1`
  ) %>%
  pivot_longer(
    effect_B:effect_D,
    names_to = c(".value", "treat"),
    names_sep = "_"
  ) %>%
  mutate(
    treat = factor(treat, labels = paste("Message", LETTERS[2:4])),
    age_less30 = if_else(age < 30, 1, 0),
    pos = paste0(male, age_less30),
    pos = factor(
      pos,
      levels = c("01", "00", "11", "10"),
      labels = c(
        "Female\u00d7\nAge<30",
        "Female\u00d7\n30\u2264Age",
        "Male\u00d7\nAge<30",
        "Male\u00d7\n30\u2264Age"
      )
    )
  )

predict_donate_rcf %>%
  ggplot(aes(x = effect, y = after_stat(count) / sum(after_stat(count)))) +
  geom_histogram(
    aes(fill = effect > 0),
    breaks = seq(-.2, .2, by = .01),
    color = "black"
  ) +
  scale_fill_manual(values = c("white", "red")) +
  facet_grid(treat~pos) +
  labs(
    x = "Treatment effects",
    y = "Fraction"
  ) +
  simplegg() +
  theme(legend.position = "none")
```

```{r}
#| label: est-donate-rcf-cate
#| include: false
#| eval: false

subset_cond <- list(
  X[, "male"] == 1 & X[, "age"] < 30,
  X[, "male"] == 0 & X[, "age"] < 30,
  X[, "male"] == 1 & X[, "age"] >= 30,
  X[, "male"] == 0 & X[, "age"] >= 30
)

ate_donate_rcf <- subset_cond %>%
  purrr::map(~ average_treatment_effect(donate_rcf, subset = .)) %>%
  reduce(bind_rows) %>%
  mutate(
    z = abs(estimate / std.err),
    p = 2 * pnorm(z, lower.tail = FALSE),
    gender = rep(c("Males", "Females", "Males", "Females"), each = 3),
    age = rep(c("Young", "Elder"), each = 6)
  )

tbl_donate_rcf <- ate_donate_rcf %>%
  select(gender, age, contrast, estimate, std.err, p) %>%
  pivot_wider(names_from = gender, values_from = estimate:p) %>%
  select(age, contrast, ends_with("Females"), ends_with("Males")) %>%
  mutate(contrast = str_extract(contrast, "[B-D]"))
```

```{r}
#| label: tbl-donate-rcf-cate
#| tbl-cap: Conditional Average Treatment Effect Estimated by RCF.
#| eval: false

tbl_donate_rcf %>%
  mutate(age = recode(
    age,
    "Young" = "Age: Less than 30",
    "Elder" = "Age: More than or equal to 30"
  )) %>%
  as_grouped_data("age") %>%
  as_flextable(hide_grouplabel = TRUE) %>%
  set_header_labels(
    contrast = "",
    estimate_Females = "Estimate",
    std.err_Females = "S.E.",
    p_Females = "P-value",
    estimate_Males = "Estimate",
    std.err_Males = "S.E.",
    p_Males = "P-value"
  ) %>%
  add_header_row(values = c("", "Females", "Males"), colwidths = c(1, 3, 3)) %>%
  align(j = -1, align = "center", part = "all") %>%
  colformat_double(j = -1, digits = 3) %>%
  padding(j=1:7, padding.top = 5, padding.bottom = 5, part = "all") %>%
  padding(2:4, padding.left = 10) %>%
  padding(6:8, padding.left = 10) %>%
  fontsize(size = 9, part = "all")  %>%
  ft_theme()
```

# Appendix {-}

```{r}
#| label: est-full-reply-logit
#| include: false

est_stock_logit <- stock %>%
  group_by(outcome) %>%
  nest() %>%
  mutate(
    fit1 = map(
      data,
      ~ glm(mod$unctrl, data = ., family = binomial())
    ),
    fit2 = map(
      data,
      ~ glm( mod$ctrl, data = ., family = binomial())
    )
  ) %>%
  pivot_longer(
    fit1:fit2,
    names_prefix = "fit",
    names_to = "model",
    values_to = "fit"
  )

add_tables <- tibble::tribble(
  ~term, ~"(1)", ~"(2)", ~"(3)", ~"(4)", ~"(5)", ~"(6)",
  "Covariates", "", "X", "", "X", "", "X"
)

attr(add_tables, "position") <- 7


tidy_custom.glm <- function(x, ...) {
  tbl <- tidy(x) %>%
    mutate(
      or = exp(estimate),
      lower.or = exp(estimate - 1.96 * std.error),
      upper.or = exp(estimate + 1.96 * std.error)
    )

  tbl
}

tbl_stock_logit <- est_stock_logit %>%
  pull(fit) %>%
  setNames(paste0("(", seq_len(length(.)), ")")) %>%
  modelsummary(
    estimate = "{or}",
    statistic = "[{lower.or}, {upper.or}]",
    coef_map = c(
      "treatB" = "Treatment B",
      "treatC" = "Treatment C",
      "treatD" = "Treatment D"
    ),
    add_rows = add_tables,
    gof_omit = "R2|AIC|BIC|RMSE|Std|FE|se_type",
    fmt = fmt_sprintf("%.3f")
  )
```

```{r}
#| label: tbl-full-reply-logit
#| tbl-cap: Logit Model of Reply and Intention

tbl_stock_logit %>%
  flextable::add_header_row(
    values = c("", "Reply", "Positive", "Negative"),
    colwidths = c(1, 2, 2, 2)
  ) %>%
  flextable::add_header_row(
    values = c("", "Intention"),
    colwidths = c(3, 4)
  ) %>%
  align(j = -1, align = "center", part = "all") %>%
  width(j = 1, 1) %>%
  fontsize(size = 9, part = "all") %>%
  ft_theme()
```

```{r}
#| label: est-full-coordination-logit
#| include: false

est_coordination_logit <- coordination %>%
  group_by(outcome) %>%
  nest() %>%
  mutate(
    fit1 = map(
      data,
      ~ glm(mod$unctrl, data = ., family = binomial())
    ),
    fit2 = map(
      data,
      ~ glm(mod$ctrl, data = ., family = binomial())
    )
  ) %>%
  pivot_longer(
    fit1:fit2,
    names_prefix = "fit",
    names_to = "model",
    values_to = "fit"
  )

add_tables <- tibble::tribble(
  ~term, ~mod1, ~mod2, ~mod3, ~mod4, ~mod5, ~mod6, ~mod7, ~mod8,
  "Covariates", "", "X", "", "X", "", "X", "", "X"
)

attr(add_tables, "position") <- 7

tbl_coordination_logit <- est_coordination_logit %>%
  pull(fit) %>%
  setNames(paste0("(", seq_len(length(.)), ")")) %>%
  modelsummary(
    estimate = "{or}",
    statistic = "[{lower.or}, {upper.or}]",
    coef_map = c(
      "treatB" = "Treatment B",
      "treatC" = "Treatment C",
      "treatD" = "Treatment D"
    ),
    add_rows = add_tables,
    gof_omit = "R2|AIC|BIC|RMSE|Std|FE|se_type",
    fmt = fmt_sprintf("%.3f")
  )
```

```{r}
#| label: tbl-full-coordination-logit
#| tbl-cap: Logit Model of Coordination

tbl_coordination_logit %>%
  flextable::add_header_row(
    values = c("", "CT", "Candidate", "Consent", "Donation"),
    colwidths = c(1, 2, 2, 2, 2)
  ) %>%
  align(j = -1, align = "center", part = "all") %>%
  width(j = 1, 1) %>%
  fontsize(size = 9, part = "all") %>%
  ft_theme()
```

<!-- Wild clustered bootstrap -->

```{r}
#| label: est-wildbs-young-reply
#| include: false

ate_bs <- stock %>%
  dplyr::filter(age < 30) %>%
  group_by(outcome, male) %>%
  nest() %>%
  mutate(
    treatB = map_dbl(data, ~ wildBS(
      update(mod$ctrl, . ~ . - male - age_demean),
      data = .x,
      cluster = RCTweek,
      H0 = "treatB = 0",
      B = 1000
    )),
    treatD = map_dbl(data, ~ wildBS(
      update(mod$ctrl, . ~ . - male - age_demean),
      data = .x,
      cluster = RCTweek,
      H0 = "treatD = 0",
      B = 1000
    ))
  )

tbl_stock_sub <- est_stock_sub %>%
  dplyr::filter(age_less30 == 1) %>%
  pull(est) %>%
  modelsummary(
    coef_map = c(
      "(Intercept)" = "Constant",
      "treatB" = "Treatment B",
      "treatC" = "Treatment C",
      "treatD" = "Treatment D"
    ),
    stars = c("***" = .01, "**" = .05, "*" = .1),
    fmt = 4,
    gof_omit = "R2|AIC|BIC|Log|Std|FE|se_type",
    add_rows = data.frame(rbind(
      c("Covariates", rep("X", 6)),
      c("B = 0", sprintf("%1.3f", ate_bs$treatB)),
      c("D = 0", sprintf("%1.3f", ate_bs$treatD))
    ))
  )
```

```{r}
#| label: tbl-wildbs-young-reply
#| tbl-cap: Linear Probability Model of Reply and Intentions among Young Males and Females

tbl_stock_sub %>%
  align(j = -1, align = "center", part = "all") %>%
  add_header_row(
    values = c("", "Reply", "Positive", "Negative", "Reply", "Positive", "Negative")
  ) %>%
  add_header_row(
    values = c("", "Young females", "Young males"),
    colwidths = c(1, 3, 3)
  ) %>%
  width(j=1, 1) %>%
  fontsize(size = 9, part = "all")  %>%
  ft_theme()
```

```{r}
#| label: est-wildbs-young-male-coordinate
#| include: false

ate_bs_coordination <- coordination %>%
  dplyr::filter(age < 30 & male == 1) %>%
  group_by(outcome) %>%
  nest() %>%
  mutate(
    treatB = map_dbl(data, ~ wildBS(
      update(mod$ctrl, . ~ . - male - age_demean),
      data = .x,
      cluster = RCTweek,
      H0 = "treatB = 0",
      B = 1000
    ))
  )

tbl_coordination_sub <- est_coordination_sub %>%
  dplyr::filter(age_less30 == 1 & male == 1) %>%
  pull(est) %>%
  modelsummary(
    coef_map = c(
      "(Intercept)" = "Constant",
      "treatB" = "Treatment B",
      "treatC" = "Treatment C",
      "treatD" = "Treatment D"
    ),
    stars = c("***" = .01, "**" = .05, "*" = .1),
    fmt = 4,
    gof_omit = "R2|AIC|BIC|Log|Std|FE|se_type",
    add_rows = data.frame(rbind(
      c("Covariates", rep("X", 4)),
      c("B = 0", sprintf("%1.3f", ate_bs_coordination$treatB))
    ))
  )
```

```{r}
#| label: tbl-wildbs-young-male-coordinate
#| tbl-cap: Linear Probability Model of Coordination among Young Males

tbl_coordination_sub %>%
  align(j = -1, align = "center", part = "all") %>%
  add_header_row(
    values = c("", "CT", "Candidate", "Consent", "Donation")
  ) %>%
  fontsize(size = 9, part = "all")  %>%
  width(j=1, 1) %>%
  ft_theme()
```

<!-- RCF -->

```{r}
#| label: est-t-test-covariate-int-rcf
#| include: false

cov_int_rcf <- predict_int_rcf %>%
  mutate(positive = if_else(effect > 0, 1, 0)) %>%
  select(age:BM_per_area, positive, pos, treat) %>%
  pivot_longer(age:BM_per_area, values_to = "value", names_to = "covariate") %>%
  group_by(pos, covariate, treat) %>%
  nest() %>%
  mutate(
    fit = map(data, ~ t.test(value ~ positive, data = .)),
    mean0 = map_dbl(fit, ~ .$estimate[1]),
    mean1 = map_dbl(fit, ~ .$estimate[2]),
    p = map_dbl(fit, ~ .$p.value)
  ) %>%
  select(-data, -fit) %>%
  pivot_wider(names_from = "treat", values_from = mean0:p) %>%
  select(pos, covariate, ends_with("B"), ends_with("C"), ends_with("D")) %>%
  arrange(pos)
```

```{r}
#| label: tbl-t-test-covariate-int-rcf
#| tbl-cap: Balance Test of Covariates Grouped By Predicted Treatment Effect

cov_int_rcf %>%
  as_grouped_data("pos") %>%
  as_flextable(hide_grouplabel = TRUE) %>%
  set_header_labels(
    covariate = "",
    "mean0_Message B" = "Negative",
    "mean1_Message B" = "Positive",
    "p_Message B" = "P-value",
    "mean0_Message C" = "Negative",
    "mean1_Message C" = "Positive",
    "p_Message C" = "P-value",
    "mean0_Message D" = "Negative",
    "mean1_Message D" = "Positive",
    "p_Message D" = "P-value"
  ) %>%
  add_header_row(
    values = c("", "Message B", "Message C", "Message D"),
    colwidths = c(1, 3, 3, 3)
  ) %>%
  align(j = -1, align = "center", part = "all") %>%
  colformat_double(j = -1, digits = 2) %>%
  padding(j=1:10, padding.top = 5, padding.bottom = 5, part="all") %>%
  padding(2:6, j = 1, padding.left = 10) %>%
  padding(8:12, j = 1, padding.left = 10) %>%
  padding(14:18, j = 1, padding.left = 10) %>%
  padding(20:24, j = 1, padding.left = 10) %>%
  width(j = -1, 0.7) %>%
  width(j = 1, 1.27) %>%
  fontsize(size = 9, part = "all")  %>%
  ft_theme()
```

```{r}
#| label: est-t-test-covariate-donate-rcf
#| include: false
#| eval: false

cov_donate_rcf <- predict_donate_rcf %>%
  mutate(positive = if_else(effect > 0, 1, 0)) %>%
  select(age:BM_per_area, positive, pos, treat) %>%
  pivot_longer(age:BM_per_area, values_to = "value", names_to = "covariate") %>%
  group_by(pos, covariate, treat) %>%
  nest() %>%
  mutate(
    fit = map(data, ~ t.test(value ~ positive, data = .)),
    mean0 = map_dbl(fit, ~ .$estimate[1]),
    mean1 = map_dbl(fit, ~ .$estimate[2]),
    p = map_dbl(fit, ~ .$p.value)
  ) %>%
  select(-data, -fit) %>%
  pivot_wider(names_from = "treat", values_from = mean0:p) %>%
  select(pos, covariate, ends_with("B"), ends_with("C"), ends_with("D")) %>%
  arrange(pos)
```

```{r}
#| label: tbl-t-test-covariate-donate-rcf
#| tbl-cap: Balance Test of Covariates Grouped By Predicted Treatment Effect (Donation)
#| eval: false

cov_donate_rcf %>%
  as_grouped_data("pos") %>%
  as_flextable(hide_grouplabel = TRUE) %>%
  set_header_labels(
    covariate = "",
    "mean0_Message B" = "Negative",
    "mean1_Message B" = "Positive",
    "p_Message B" = "P-value",
    "mean0_Message C" = "Negative",
    "mean1_Message C" = "Positive",
    "p_Message C" = "P-value",
    "mean0_Message D" = "Negative",
    "mean1_Message D" = "Positive",
    "p_Message D" = "P-value"
  ) %>%
  add_header_row(
    values = c("", "Message B", "Message C", "Message D"),
    colwidths = c(1, 3, 3, 3)
  ) %>%
  align(j = -1, align = "center", part = "all") %>%
  colformat_double(j = -1, digits = 2) %>%
  padding(j=1:10, padding.top = 5, padding.bottom = 5, part="all") %>%
  padding(2:6, j = 1, padding.left = 10) %>%
  padding(8:12, j = 1, padding.left = 10) %>%
  padding(14:18, j = 1, padding.left = 10) %>%
  padding(20:24, j = 1, padding.left = 10) %>%
  width(j = -1, 0.7) %>%
  width(j = 1, 1.27) %>%
  fontsize(size = 9, part = "all")  %>%
  ft_theme()
```