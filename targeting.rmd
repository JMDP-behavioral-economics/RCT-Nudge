---
title: |
  骨髄バンクドナーコーディネート初期行程におけるコーディネート進行率増加を目指した介入研究
author:
  - 大竹文雄（大阪大学）
  - 加藤大貴（大阪大学）
  - 黒澤彩子（伊那中央病院）
  - 吉内一浩（東京大学）
  - 福田隆浩（国立がん研究センター中央病院）
data: 2023年度第2回造血細胞移植合同班会議 令和6年1月7日(日)
output: powerpoint_presentation
---


```{r include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  warning = FALSE,
  error = FALSE,
  message = FALSE,
  dev = "png",
  fig.width = 15,
  fig.height = 8,
  fig.pos = "t",
  out.extra = ""
)
```

```{r library, include=FALSE}
library(here)
source(here("R/R6_RawData.r"))

data_root <- "D:/JMDPフィールド実験"
```

```{r def-study-sample, include=FALSE}
rawdt <- RawData$new(
  here(data_root, "shape.csv"),
  treat_vars = "treat",
  treat_levels = LETTERS[1:4]
)

rawdt$add_cond_study_sample("ongoing == 0")
```

```{r rct-setup, include=FALSE}
intervention <- list(
  "Standard notification" = c(A = "X", B = "X", C = "X", D = "X"),
  "Probability message" = c(A = "", B = "X", C = "", D = "X"),
  "Early Coordination message" = c(A = "", B = "", C = "X", D = "X")
)

endpoint <- list(
  reply = "Reply",
  positive = "Positive intention",
  negative = "Negative intention",
  test = "CT",
  candidate = "Candidate",
  consent = "Consent",
  donate = "Donation"
)

covs <- c(
  "Male (= 1)" = "male",
  "Age" = "age",
  "Number of past coordinations" = "coordinate",
  "Number of listed hospitals" = "hospital_per_area",
  "Number of hospitals listed with PBSC collection" = "PB_per_area",
  "Number of hospitals listed with BM collection" = "BM_per_area"
)

rct <- rawdt$RCT()
rct$add_intervention(intervention)
rct$add_outcome(endpoint)
rct$add_covariate(covs)
rct$add_fixed_effect(c("month", "week"))
rct$set_default_se_type("stata")
```

```{r rcf-int, include=FALSE}
library(xfun)
rcf <- cache_rds({
  id2 <- which(names(endpoint) == "positive")
  rct$rcf(id2)
})
```

## 一律介入と最適ターゲティングの効果

アウトカム：返信時に提供意向を示したかどうか

```{r optimum-targeting-effect}
targeting <- rcf$targeting()
targeting$flextable(font_size = 16)
```

## 予測介入効果の分布

```{r dist-targeting-effect}
targeting$hist()
```

## 最適ターゲティング別の個人属性の比較

```{r chacteristics-targeting}
targeting$
  summarize_X()$
  flextable(font_size = 13)
```

## 個人属性の分布

```{r chacteristics-targeting-dist}
X %>%
  select(-male) %>%
  pivot_longer(-optim, names_to = "vars") %>%
  mutate(vars = factor(
    vars,
    levels = c("age", "coordinate", "hospital_per_area", "PB_per_area", "BM_per_area"),
    labels = c(
      "Age",
      "Number of past coordinations",
      "Number of listed hospitals",
      "Number of hospitals listed\nwith PBSC collection",
      "Number of hospitals listed\nwith BM collection"
    )
  )) %>%
  ggplot(aes(x = value, fill = optim)) +
    geom_histogram() +
    facet_wrap(~ vars, ncol = 3, scales = "free") +
    labs(fill = "Optimal treatment") +
    my_theme_classic() +
    theme(legend.position = "bottom")
```

## 単純な分割ルールによる政策効果（最大分割：２）

```{r policy-tree, include=FALSE}
library(policytree)
library(DiagrammeRsvg)

Gamma_mat <- double_robust_scores(rcf$get_rcf())
tree <- cache_rds({
  train <- sample(nrow(X), 8850)
  tree <- policy_tree(rcf$get_X()[train, ], Gamma_mat[train, ], depth = 2)
})
tree_plot <- plot(tree)
cat(DiagrammeRsvg::export_svg(tree_plot), file = "policy-tree.svg")
```

```{r policy-tree-effect}
tree_optim <- predict(tree, rcf$get_X())
tau_withA <- cbind(effect_A = 0, rcf$get_tau())
tree_tau <- numeric(length(tree_optim))

for (i in 1:length(tree_tau)) {
  tree_tau[i] <- tau_withA[i, tree_optim[i]]
}

mean(tree_tau)
```

## 単純な分割ルールによる政策効果（最大分割：３）

```{r hybrid-policy-tree, include=FALSE}
tree <- cache_rds({
  train <- sample(nrow(X), 8850)
  tree <- hybrid_policy_tree(rcf$get_X()[train, ], Gamma_mat[train, ], depth = 3)
})
tree_plot <- plot(tree)
cat(DiagrammeRsvg::export_svg(tree_plot), file = "hybrid-policy-tree.svg")
```

```{r hybrid-policy-tree-effect}
tree_optim <- predict(tree, rcf$get_X())
tau_withA <- cbind(effect_A = 0, rcf$get_tau())
tree_tau <- numeric(length(tree_optim))

for (i in 1:length(tree_tau)) {
  tree_tau[i] <- tau_withA[i, tree_optim[i]]
}

mean(tree_tau)
```